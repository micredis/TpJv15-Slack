Grigory Kislin [11:30 PM]
joined #hw5.

Grigory Kislin [11:32 PM]
Добро пожаловать на 5е занятие: https://github.com/JavaWebinar/topjava/blob/doc/doc/lesson05.md
Первое видео с миграцией на jdk11 буду дорабатывать и, как выложу, напишу отдельно (edited)

severek [11:34 PM]
joined #hw5 along with 18 others.

Taras [10:02 AM]
Ого, jdk 11! Нам тоже надо будет поставить и перейти?

Grigory Kislin [10:03 AM]
Да, нужно. Решил перейти- будем идти в ногу со временем.

Grigory Kislin [10:26 AM]
Добавил *5_9_jdk11_fix.patch*
Поправил версию JDK в `.travis.yml` (edited)

Vitaliy Ivkin [11:47 AM]
Последний раз, когда перекатывался с разных JDK было много танцев с бубном и слетевших настроек :sweat_smile:
Ну, поехали

Grigory Kislin [12:16 PM]
да, IDEA не надо пробовать запускать из JDK 11. она сама ругается и просится обратно под свой JRE
если деплоится в tomcat не через idea- нужно поменять JAVA_HOME


ABaykov [Yesterday at 12:24 PM]
вопрос - что всё таки ставить OpenJDK или OracleJDK ? или для не коммерческого использования разницы не будет?


1 reply
Taras [20 hours ago]
У нас без разницы. У меня стоит oracle.


Roman Baranov [Yesterday at 12:25 PM]
при накатке патча `5_5_profiles_connection_pool.patch`
возникают конфликты в файлах src/main/resources/db/hsqldb.properties, pom.xml


1 reply
Roman Baranov [1 day ago]
починил через апдейт из оригинального  topjava repo


Maxim Valeev [Yesterday at 12:28 PM]
после патча 5_6_profile_resolver ловлю экспепшн в тестах. Профиль подключен Postgres, почему URL подтягивается из hsqldb.properies?
Снимок.PNG



3 replies
Maxim Valeev [1 day ago]
т.е. у меня все тянется из hsqldb.properties, хотя стоит профиль postgres


Maxim Valeev [1 day ago]
Починил)


Tony [1 day ago]
https://pbs.twimg.com/media/Dpj067-W0AE2I_m.jpg (187 kB)


Maxim Valeev [12:28 PM]
1.PNG 


fonto [Yesterday at 12:53 PM]
Мне одному кажется, что var заместо Map<>, менее удобно?


12 replies
fonto [1 day ago]
Или в этом кроется какой-то смысл о котором я не знаю?


Ansseii [1 day ago]
В уроке была статья с рассуждениями на эту тему) Как по мне - тут вопрос чисто эстетический. Я, вероятно, буду пользовать var в  ситуации, где требуется создать объект, а там будет не Map или, скажем, Integer, а название символов в 50+, что для спринга похоже есть норма)


ABaykov [1 day ago]
+1, если будет переменная из разряда AutowiredAnnotationBeanPostProcessor, то проще его на var заменить)


Gekov Iliya [1 day ago]
Да по сути для использования в циклах и методах для переменных, которые объявил, поиспользовал да забыл)

Zhinko [24 hours ago]
Это с непривычки кажется неудобным.

KaryNaiKo [22 hours ago]
А как это читать?
Вот вижу я впервые метод delet
   @Override
   public boolean delete(int id, int userId) {
       var meals = repository.get(userId);
       return meals != null && meals.remove(id) != null;

   }
что я удаляю?!
Сильно страдает понимание кода.
Нихатюююююю(((( (edited)


KaryNaiKo [22 hours ago]
Ладно еще в идее, где могу глянуть с помощью alt. Но а если я смотрю код без IDE? Короче, здесь считаю нельзя применять var (edited)


Zhinko [19 hours ago]
Ну тут просто вместо типа List используется var. В принципе понятно. А в javascript например там везде var

Gekov Iliya [19 hours ago]
Это понятно тому, кто этот метод писал, а тому, кто просто его читает, придется лезть смотреть, что этот метод возвращает. Мне кажется, var удобен лишь там, где мы сразу видим тип переменной по правой части после =.


Zhinko [19 hours ago]
Ну да, и тут ещё нужно чтобы название переменных отражало суть. По логике если meals то это скорее всего список


Gekov Iliya [19 hours ago]
Или мапа или сет или вообще массив)


Gekov Iliya [19 hours ago]
Вобщем злоупотреблять не стоит наверное...)


Dima [Yesterday at 5:39 PM]
мда, придется видимо новую идею поставить, после первого же патча все красное, ругается на List.of(). SDK 11 поставил, а вот уровнем языка стоит 9 и не выше. Как думаете спасет новая идея?  меня сейчас 2017.3.4


9 replies
Gekov Iliya [1 day ago]
Думаю да, 2018.2.2 никаких проблем


Dima [1 day ago]
качаю уже, месяц так поюзаю,потом использую купон


Dima [23 hours ago]
ну все, проблема ушла) токо я как нищеброд на триале))


Стецко Максим [23 hours ago]
лицензия же к аккаунту привязана, авторизуйся


Dima [23 hours ago]
как я понимаю,если я авторизируюсь 1 декабря, то срок лицензии пойдет с 1 декабря. а если сейчас- то сейчас. Или я не прав?


Стецко Максим [23 hours ago]
да вроде прав, а сейчас у тебя был еще триал чтоли?


Dima [23 hours ago]
сейчас у меня был perpetul , типо вечная необновляемая версия


Sergey Zhukov [19 hours ago]
блин нижний бар теперь весь серый, и вообще с каждым переходом цвета пропадают :confused:


Dima [19 hours ago]
все ближе к темной стороне...


Gekov Iliya [Yesterday at 7:43 PM]
В материалах к занятию есть 5_5_profiles_connection_pool.patch и 5_5_profiles_connection_pool1.patch, когда пробую применить первый - идея ругается на несколько мест в коде, что не может применить изменения, когда применяю второй (не пытаясь применить первый) - все ок. Это только у меня или кто-то еще столкнулся с этим?


3 replies
Gekov Iliya [22 hours ago]
У всех все ок с этим патчем?


Gekov Iliya [21 hours ago]
Вроде разобрался, если накатывать только 5_5_profiles_connection_pool1.patch, то все вроде ок, сверился с основным репозиторием


Zhinko [19 hours ago]
Да второй накатывайте и все норм будет


KaryNaiKo [Yesterday at 9:37 PM]
После перехода на 11 java мавен стал выдавать
WARNING: An illegal reflective access operation has occurred
WARNING: Illegal reflective access by com.thoughtworks.xstream.core.util.Fields (file:/C:/Users/Павлуша/.m2/repository/com/thoughtworks/xstream/xstream/1.3.1/xstream-1.3.1.jar) to field java.util.Properties.defaults
WARNING: Please consider reporting this to the maintainers of com.thoughtworks.xstream.core.util.Fields
WARNING: Use --illegal-access=warn to enable warnings of further illegal reflective access operations
WARNING: All illegal access operations will be denied in a future release
Что это значит?

Плюс не запускается проект
Root Cause

org.hibernate.HibernateException: Access to DialectResolutionInfo cannot be null when 'hibernate.dialect' not set
    org.hibernate.engine.jdbc.dialect.internal.DialectFactoryImpl.determineDialect(DialectFactoryImpl.java:100)
    org.hibernate.engine.jdbc.dialect.internal.DialectFactoryImpl.buildDialect(DialectFactoryImpl.java:54)
    org.hibernate.engine.jdbc.env.internal.JdbcEnvironmentInitiator.initiateService(JdbcEnvironmentInitiator.java:137)
    org.hibernate.engine.jdbc.env.internal.JdbcEnvironmentInitiator.initiateService(JdbcEnvironmentInitiator.java:35) (edited)


10 replies
Sergey Zhukov [20 hours ago]
clean делал?


KaryNaiKo [20 hours ago]
делал


Alexey_b [20 hours ago]
что-то опасаюсь на рабочем ноуте 11 ставить, это надо по идее 2 джавы и с помощью path регулировать какая сейчас активная?


Zhinko [19 hours ago]
Там же в настройках проекта можно выбрать версию джавы.


Zhinko [19 hours ago]
Я скачал и поменял на 11. У меня все норм работает


Sergey Zhukov [19 hours ago]
я поставил рядом с 2017.3.3
активировал купон
все так же запускается
версия языка 11, jdk-11.0.1, накатил 5_0_jdk_11.patch


Sergey Zhukov [19 hours ago]
ругается на maven, удали его репозиторий, пусть заново создаст
C:/Users/Павлуша/.m2


KaryNaiKo [19 hours ago]
Решил проблему с hibernate. У меня каким-то образом умерла БД, пришлось удалять и делать новую.
А вот предупреждения так и появляются. Все работает. С этим можно жить? :smile:
Умерла так
FATAL: catalog is missing 17 attribute(s) for relid 2600 (edited)


Gekov Iliya [19 hours ago]
Время покажет) "Работает - не трогай" (с)  :grin:

Taras [10 hours ago]
@KaryNaiKo Ты бы кириллицу исключил из путей. Это верный способ нажить себе неожиданных проблем.


This message was deleted.


22 replies
Ilya A. Kvyatkovsky [17 hours ago]
Сори, расчувствовался! Пойду спать, завтра буду разгребать эту свалку.:mountain: (edited)


shomnest [12 hours ago]
@Ilya A. Kvyatkovsky добро пожаловать в мир кровавого энтерпрайза, это над тобой ещё ПМ не стоит и не требует что бы все было готово ещё вчера.


Dima [11 hours ago]
Ты видимо не с javaRush тут? Потому что после борьбы с валидатором заданий этот проект кажется просто чуть сложнее. Да,много всего и надо много гуглить,но как я понимаю,это и есть будущая работа)



vch [11 hours ago]
Тут пока лайт-версия ПМ в виде Татьяны, требующей сдать HW к вечеру вторника :slightly_smiling_face:


Gekov Iliya [10 hours ago]
Думаю в реальной работе, особенно если вливаться в готовый проект, все будет в разы хуже в этом плане, надо как то привыкать и приспосабливаться. Возможно, стоит побольше времени уделить чтению теории, какой-нибудь из популярных книг по спрингу, хибернейту, jpa. Пока готовился к стажировке почитал Pro Spring к примеру и как то пока особых сложностей в усвоении материала нет. Так же не стоит забывать, что этот проект называется именно стажировкой, а не лекции с семинарами, то есть максимальное приближение к реальной работе. Мне наоборот нравится, что перед нами ставят именно такие задачи - вот тебе проект, вот тебе такая то технология, изучи ее, внедри, а потом почини что поломалось)


Gekov Iliya [9 hours ago]
И обязательно посмотрите Борисова по spring data (ссылка в материалах)



Ilya A. Kvyatkovsky [8 hours ago]
Теперь ясно понимаю, почему многие заходят по 2 и 3 кругу на стажировку. Освоить с первого раза такой объем крайне сложно.
В статьях и видео много говорят что нужно писать простой и понятный код, а на практике получается все наоборот. Если, как вы говорите на продакшене все проекты в виде фарша из технологий, то в индустрии явно нехватка грамотных архитекторов.
И это наверное будет точкой роста для меня. (Если, конечно, хватит упорства освоить все это).
Пост убрал потому, что это скорее флудинг и нытье.
П.С.: JavaRush - это детский лепет по сравнению с тем что мы имеем здесь.


Gekov Iliya [8 hours ago]
Уж не знаю куда еще проще код, чем в spring data, унаследовался от интерфейса и всё - crud репозиторий готов. Если spring boot использовать, то еще в разы код упрощается.


Gekov Iliya [8 hours ago]
Да и о каком фарше идет речь? Нужна проекту технология - добавили, не нужна - убрали, естественно это все переплетается кучей зависимостей, но никакого фарша не вижу, все легко через мавен контролируется. У нас проект учебный, попробовали реализацию с jdbc, попробовали jpa, теперь пробуем spring data, видим в чем отличие, почему это удобнее и т.п. В реальном проекте естественно мы бы сразу взяли, к примеру, спринг дата и всё


Gekov Iliya [8 hours ago]
Да и не был бы у джавы ЕЕ такой высокий порог вхождения, не было бы и соответствующих з/п) никто не обещал что будет легко)


Ilya A. Kvyatkovsky [7 hours ago]
@Gekov Iliya Илья, все верно, мы рассмотрели сначала одну технологию, потом вторую, затем третью. Но если бы мы рассматривали их каждую на чистом проекте (те полностью очищали от предыдущего варианта) тогда бы было наглядно видно что нам нужно для одного а что для другого. А сейчас у нас получается, что все накладывается друг на друга.


Gekov Iliya [7 hours ago]
Не соглашусь. В реальном рабочем проекте при переходе от одной технологии к другой тоже будете проект очищать? Мы учимся работать с реальным проектом, а не создавать абстрактные примеры использования отдельных технологий - этого итак в инете куча (edited)


Dima [7 hours ago]
Мы пользуемся благами спринга и внедрением зависимомтей,как раз сейчас видно все плюсы,в коде можетбыть куча всего,но по конфигкрационному файлу ясно,что сейчас у нас попадает в контекст,а что нет.



Gekov Iliya [7 hours ago]
Кстати да, если бы мы все подчищали, то какой вообще прок от IoC контейнера?


Ilya A. Kvyatkovsky [7 hours ago]
@Gekov Iliya @Dima Как давно Вы вошли в Java? Вероятно мой бэкграунд маловат или мозг!? Я с Java начал свое знакомство этим летом на явераш, за три месяца добрался до 35 уровня и на стажировку. Наверное я слишком быстро кинулся на стажировку а сейчас тупо не хватает опыта. Хотя в принципе то что дает Григорий достаточно для освоения проекта. Как давно Вы занимаетесь джавой?


Gekov Iliya [7 hours ago]
Около года, начал с джавараша, на середине понял что не хватает теории, ушел читать книги, которые считаются мастрид для джавы, посмотрел почти всего Головача на ютубе. Паралельно прошел дипломный курс по проф. переквалификации в Специалисте при Бауманке. Вернулся на джавараш, дорешал, в ожидании стажировки читал, пробовал спринг, вобщем то и всё.. до этого опыта в програм. 0 (edited)


Dima [7 hours ago]
Я начал в 2015 на javarush,дошел до 20 уровня,потом забросил изза работы. Этой весной решил ,что мояработа меня зае...))) решил продолжить,но начал сначала. Когда писал задание на стажировку впервые услышал про спринг, jdbc и т.д Прочел пару книг,и просиотрел дофига часов на ютубе.

Dima [7 hours ago]
И на udemy прошел курс спринг и хибернэйт,довольно неплохой.Всем советую книгу Spring 5 in action (edited)


Ilya A. Kvyatkovsky [6 hours ago]
Ясно, бэк у меня дохленький, потому и взрыв мозга иногда случается. Есть к чему стремиться. Спасибо что поделились. Продолжу разбираться с проектом и make home work. Что нас не убивает, то делает нас сильнее. Через терни к звездам. По**дел...


shomnest [6 hours ago]
@Ilya A. Kvyatkovsky эт ты еще ejb не видел и надеюсь не увидишь, потому как оно нафиг ни кому не надо видеть)) или полотен js файлов или бэк на node, где вообще параллельная вселенная системы типов. Ну, а если серьезно, то не так страшен черт, главное правило это "разделяй и властвуй", мысленно (ну или на бумажке) разделяй все на подкомпоненты, проводи декомпозицию задач и вся связность будет как на ладони, то для чего и куда. Ну, еще наверное стоит книженцию какую-нибудь по паттернам пролистать или Роберта Мартина чего - нибудь.


Ilya A. Kvyatkovsky [6 hours ago]
@shomnest Вот-вот, про разделяй и властвуй это ты верно излагаешь, только вот c делением у меня пока трудности.


shomnest [6 hours ago]
научишься


fonto [Today at 1:52 AM]
Профили это о супер удобная штука для тестирования и одно из самых крутых нововведений о которых я узнал в этом проекте. Спасибо!


2 replies
Gekov Iliya [10 hours ago]
Согласен, красиво выглядит, главное самому в них не запутаться)


fonto [2 hours ago]
Если разобраться, то уже не запутаешься)), удобно очень)


Artem [Today at 6:19 AM]
Кто в курсе как теперь будет происходить компиляция проекта на jdk 11, если jre убрали? Как допустим исполняемый файл передавать на другой комп и что на него устанавливать чтобы фишки 11 java были доступны? И если оставить jre 8 будет ли работать программа? Где про это почитать можно


6 replies
Sergey Zhukov [11 hours ago]
jre - часть jdk, необходимая только для запуска... так что ставь jdk и сможешь запускать и компилировать, в папке bin есть и java и javac


Artem [10 hours ago]
Ну насчёт часть jdk я бы поспорил, да в в составе jdk есть jre, но он облегченный. У них много общего, соглашусь, но это все таки разные сборки. Вот допустим раньше на компе достаточно было установить jre и запускать программу, без установки java_home. Что для пользователя было удобно. Как я понимаю теперь обязательно устанавливать переменную java_home, чтобы java работала? Или может я че-то не догоняю. И пришёл  jlink это что за фрукт? (edited)


Taras [9 hours ago]
Загляни в готовый war, под WEB-INF увидишь либы, которые туда заносит maven из тех зависимостей, что мы указали (плюс транзитивные). В Java 11 некоторые библиотеки, доступные в прошлых версиях, теперь надо подключать отдельно — и мы их подключили. Так что на целевой машине достаточно иметь jre11 и всё будет нормально. Твой Томкэт все либы из WEB-INF это положит с classpath и приложение их найдёт.


Taras [9 hours ago]
По поводу ручной установки JAVA_HOME. Если у тебя «целевая» машина не девелоперовская, то на ней одна java, и она сама из jre и прекрасно знает, где свои библиотеки. Ты (или не ты), запустив инсталлятор Java, всё это  получил автоматом. А вот если ты для запуска приложения хочешь воспользоваться какими-то нестандартными вещами, сделать доступ из classpath к либам/ресурсам, использовать другую jre, то надо устанавливать.


Artem [8 hours ago]
примерно понял) спасибо за ответ)


Andrey Tolkachev [7 hours ago]
можно еще прописать в идее в разделе Java Compiler версию байткода, для спокойствия, например поставить 8 вместо 11.
Capture.PNG


Стецко Максим [Today at 10:39 AM]
Вроде будет издана книга "Spring 5 для профессионалов" на русском в декабре. Вот что нужно брать сразу)


3 replies
Dima [7 hours ago]
Лучше почитай spring 5 in action на английском. Там уже все на spring boot, и проект хоть интересный. На фронте ангуляр


Стецко Максим [7 hours ago]
когда не знаешь анг, надо читать на русском)


shomnest [6 hours ago]
@Стецко Максим можно ссыль, откуда инфа?


Zhinko [Today at 11:57 AM]
Можно ли в CrudMealRepository получить список еды без аннотации @Query?


17 replies
Taras [6 hours ago]
Эту аннотацию используют, если нет подходящего встроенного метода, или запрос нельзя построить именем метода вида findAllWhereNameLikeOrderById(String name)... постарался не подсказывать, но намекнуть. ;) Поиграйся разными запросами в тесте, разберёшься!


Zhinko [6 hours ago]
Я начал делать так у меня все методы используют @Query. Но что-то мне подсказывает что так не должно быть:)


Gekov Iliya [5 hours ago]
Не должно)


Taras [5 hours ago]
Не надо, можно обойтись тем, что есть. И спринг не будет лишнее парсить, сэкономим энергию, пожалеем природу.. :)


Zhinko [3 hours ago]
Что то я туплю. Как мы можем реализовать метод get без @Query, если у нас 2 id?


Also sent to the channel
Gekov Iliya [3 hours ago]
https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#repository-query-keywords Keyword 'ы spring data для написания методов


Taras [3 hours ago]
Найти на youtube видео борисова “spring data та да», очень познавательно.


Gekov Iliya [3 hours ago]
Да оно в ссылках к материалам занятия есть, видео действительно класс


Zhinko [3 hours ago]
Не смотрел. Видимо нужно сначала инфу изучить, а потом пытаться сделать


Gekov Iliya [3 hours ago]
Это 100%)


Dima [3 hours ago]
так человек вроде спрашивал про hibernate. Spring data конечно вещь в себе) бери, да выдумывай методы, а спринг сам все сделает


Gekov Iliya [3 hours ago]
Я так понял вопрос именно по спринг дата и его круд репозиторию


Dima [3 hours ago]
я просто только с работы)) не все патчи еще накатил и не все посмотрел) видимо да, по дате спрашивал.

fonto [2 hours ago]
Описание этих длинных методов есть в документации Спринга)


fonto [2 hours ago]
Но запросами query это более наглядно


Dima [2 hours ago]
https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#jpa.query-methods


Zhinko [1 hour ago]
Вроде разобрался), остался только метод для сохранения, ломаю над ним голову


Dima [5:03 PM]
Первый взгляд после патча о data jpa. А зачем мы в имплементации юзера оверрайдим методы JpaRepository?Они имплементируются автоматически.


Gekov Iliya [Today at 5:04 PM]
В видео объясняется, чтобы обойти ограничения jparepo


7 replies
Dima [1 hour ago]
В CrudUserRepository какие ограничения мы обходим? Если в этом интерфейсе ничего не написать, то в DataJpaUserRepositoryImpl , через  crudRepository будет дергать теже методы.


Gekov Iliya [1 hour ago]
Кода перед глазами нет, сейчас трудно конкретно сказать


Dima [1 hour ago]
в этом интерфесе надо писать методы, которые ты сам придумал, типа List<User> findByEmailOrderByRegistered(String email, Date date) (edited)


Dima [44 minutes ago]
своя обертка DataJpaUserRepositoryImpl - это да, это прикольно. Можно подкрутить Data JPA


Gekov Iliya [37 minutes ago]
Хм, да, я думал ты про это спрашиваешь. Сейчас глянул, действительно, в CrudRepository override по идее не нужен... может для наглядности?


Dima [37 minutes ago]
ну может


Gekov Iliya [35 minutes ago]
А то я помню, когда в первый раз увидел как пустой интерфейс делает все необходимые операции, у меня разрыв шаблона случился)


Zhinko [Today at 5:19 PM]
Подскажите по методу save , а то я в нете норм инфы найти не могу


15 replies
fonto [34 minutes ago]
Что именно подсказать?


Gekov Iliya [33 minutes ago]
Там же есть дефолтный save, какая проблема?


fonto [33 minutes ago]
Он пишется ровно так же как и в jpa, но без то реализации em (edited)


Zhinko [27 minutes ago]
Просто как получить ссылку на юзер?


Zhinko [23 minutes ago]
Или это юзер репозитория брать?


Dima [22 minutes ago]
до дз еще не дошел, но видимо надо в меал засунуть юзера, а потом сделать save. А юзера можно взять по id


Dima [21 minutes ago]
но можно модифицировать стандартный save при помощи @Query и пихнуть там id юзера. Посмотрим)вы все такие быстрые. (edited)


Zhinko [20 minutes ago]
https://stackoverflow.com/questions/45831695/alternatives-to-getreference-method-in-spring-data-jpa
Stack Overflow
Alternatives to getReference method in Spring data JPA
I found myself struggling to implement customizable methods in Spring Data JPA. For example, I have a Pet class, which has an Owner(Many to One rel.) What if I have a method to save(Pet pet, int ow...
 


Zhinko [20 minutes ago]
Мне кажется что так нужно


Gekov Iliya [19 minutes ago]
@Zhinko Да, видимо так, про это и в подсказках сказано


Dima [19 minutes ago]
ну как я тебе и сказал)


Gekov Iliya [19 minutes ago]
6: В Data-Jpa метод для ссылки на entity (аналог em.getReference) : T getOne(ID id)



Gekov Iliya [18 minutes ago]
Смущает только необходимость инжектить два репозитория, но по сути наверное в этом ничего страшного нет...


Zhinko [18 minutes ago]
Да это меня тоже смутило вот я и голову ломал


Gekov Iliya [16 minutes ago]
С другой стороны, лишний раз показывает практическую пользу IoC, если представить сколько бы это проблем прибавило без возможности инжекта


Viktor [5:53 PM]
jdk 11 идет только для x64. Для 32 битной винды уже не работать не будет?
И обязательно ли мигрировать если такой возможности нет?


Roman Baranov [2 days ago]
думаю что будут проблемы с накаткой патчей. конечно конфликты можно будет резолвить вручную


Roman Baranov [2 days ago]
https://github.com/ojdkbuild/ojdkbuild/releases/download/11.0.1-1/java-11-openjdk-11.0.1.13-1.ojdkbuild.windows.x86_64.msi


Viktor [1 day ago]
эту пробовал, пишет, что не найден jdk в этой папке


This message was deleted.


7 replies
Dima [2 days ago]
вероятно потом напишем свой ExceptionHandler, который будет оборачивать эксепшн в какой нить красивый ответ, чтоб на странице не появлялось что то типа "Ошибка 404". Но с другой стороны как может прийти не тот id, если методом добавить может пользоваться только залогиненный пользователь, что будет прописано скорее всего в security


Gekov Iliya [2 days ago]
Да, но мы делаем getReference по id не тому, что нам спринг секьюрити передал, а тот, что лежит в переданном через веб meal'е, то есть теоретически в нем может лежать вообще левый userid, подсунутый кем-то где-то по пути) мы же для этого и перепроверяем...


Dima [2 days ago]
так вход в метод контроллера по спринг секурити. Вначале он рулит, а потом доходит до метода save


Gekov Iliya [2 days ago]
Так а зачем мы тогда вообще перепроверяем userid?)


Dima [2 days ago]
ну я не задумывался) но верю, что есть смысл. Может на ранних этапах разработки это надо. А когда прикрутим защиту, многое поменяется. Посмотрим


Dima [2 days ago]
как те методы в CrudRepository, они не нужны, но смысл в них есть


Gekov Iliya [2 days ago]
Всё, разобрался, это я запутался, мы же не сразу getReference вызываем, а только после вытаскивания мила и проверок соответствующих. Вопрос более не актуален)


Sergey Zhukov [Nov 2nd at 9:33 PM]
Решил переключится на openjdk, idea немного офигела, и начала подчеркивать мне некоторые методы, хотя все компилируется и работает. Решилось сменой версии языка на с 11 на 8 и обратно на 11 :grin:
openjdk.png



7 replies
Dima [2 days ago]
а че у тебя с цветностью?или ты в розовых очках)


Sergey Zhukov [2 days ago]
прога стоит которая фильтрует синий


Sergey Zhukov [2 days ago]
вечером


Sergey Zhukov [2 days ago]
f.lux


Dima [2 days ago]
у меня на работе тоже недавно монитор показывал так, в итоге отвалился провод синего цвета.


under4eg [2 days ago]
так флюкс же в скрины не лезет и оставляет их в обычном цвете)


Sergey Zhukov [2 days ago]
видимо лезет


Dima [Nov 2nd at 11:02 PM]
у всех в методе save параметр Meal Meal?


1 reply
Gekov Iliya [1 day ago]
Да, опечатка видимо


lifter4ik [Yesterday at 2:38 PM]
кто-нибудь починил сервлет после добавления профилей? пытаюсь в init подсунуть нужный профиль - не воспринимает и валится с тем же Invalid boolean value [${jpa.showSql}] что в тестах был


2 replies
Taras [1 day ago]
Тебе надо установить переменную окружения, которая за подгружаемые профили отвечает, ДО того, как загрузиться контекст. У меня всё работает, и тесты и веб.


lifter4ik [8 hours ago]
сделал так, работает, спасибо. но хотелось бы настроить похожим образом, как сделано в тестах, аннотация вешается с нужным профилем, и все работает)


Maxim Valeev [Yesterday at 3:46 PM]
Разделить реализации Repository по профилям Spring: jdbc, jpa, datajpa (общее в профилях можно объединять, например <beans profile="datajpa,jpa">).
Работаем только с spring-db.xml? в pom файле ничего не меняем?


5 replies
Gekov Iliya [1 day ago]
Я сначала думал разделить в pom, но посмотрел и понял, что там нечего разделять кроме БД) хотя могу ошибаться, может что то можно придумать и в поме (edited)


Maxim Valeev [1 day ago]
понял, а то пока не разобрался, как только закидываю например datajpa  в профиль, то все, тесты не идут


Maxim Valeev [1 day ago]
А как тогда активировать профиль ? Тое есть если я кидаю, например JPA реализацию в <beans profile="jpa">
   </beans>

то контекст не поднимается, как будто  я закомментил код (edited)


Gekov Iliya [1 day ago]
Ну добавить в массив профилей в аннотации в тестах


Maxim Valeev [1 day ago]
блин, точно, спасибо. Сижу уже час пытаюсь сделать


Nikita Ganin [Yesterday at 8:49 PM]
По 3-му пункту дз, у нас же тесты ничем не отличаются кроме профиля? Получается что и классы будут пустые?


5 replies
Gekov Iliya [1 day ago]
Как не отличаются, если мы разные данные передаем на тест


Gekov Iliya [1 day ago]
В юзерах просто id, в миле id и userid. Ассерты разные совершенно (edited)


Nikita Ganin [1 day ago]
Не я не про это. У нас есть метод MealServiceTest, в задании написано сделать тесты на все реализации, но тест то мы использовали один на все реализации, соответственно, если мы его делаем базовым то в тестах с разной реализацией класс будет пустым


Zhinko [1 day ago]
jpa , datajpa, jdbc тесты у меня тоже пустые.


Gekov Iliya [1 day ago]
А, тогда да, получается разница только в профилях


ABaykov [Today at 8:05 AM]
Господа, сталкивался кто со следующей проблемой ? При попытке прогнать юзертест после накатки патчей обнаружил следующую ошибку

Caused by: org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'crudMealRepository': Injection of autowired dependencies failed; nested exception is java.lang.NoSuchMethodError: org.springframework.beans.factory.ObjectProvider.getIfAvailable(Ljava/util/function/Supplier;)Ljava/lang/Object;


Сталкивался кто с подобным ? В интернетах пишут, что такое может возникнуть при несовместимости версий спринг даты и спринг фреймворка (бута). Но судя по документации, версия спринг даты 2.1.2 должна дружить с 5.1.2 (edited)


2 replies
Ilya A. Kvyatkovsky [12 hours ago]
Да, такая же проблема, не разобрался. Юзер тест удалось запустить только после исключения всех бинов Мил из контекста, ну это не вариант.


ABaykov [3 hours ago]
Итак!!! Сам сломал - сам починил. Обнаружил, что у меня в проект подключен спринг framework старой  версии 4.3.18. Он у меня в проекте в папке lib жил. Залез в используемые библиотеки, выкинул оттуда эту версию спринга. Почистил мавен и реимпортнул всё заного. Подтянулась правильная версия спринга 5.1.2 и всё заработало.


Marat [Today at 8:06 AM]
Патч 5.5 не применяется
Pasted image at 2018-11-04, 12:06 PM



4 replies
Nikita Ganin [14 hours ago]
Да там проблема с properties, если скопировать из репозитория Григория то все норм


Roman Baranov [12 hours ago]
да или надо было вместо 5_5_profiles_connection_pool.patch накатывать 5_5_profiles_connection_pool1.patch



Marat [12 hours ago]
Ну так и сделал 5_5 ...1 накатил


Grigory Kislin [2 hours ago]
`5_5_profiles_connection_pool1.patch`- у меня накатывается. удалил плохой и переименовал, сорри
как должно быть можно посмотреть на github:
https://github.com/JavaWebinar/topjava/blob/master/src/main/resources/db/hsqldb.properties (edited)


Zhinko [2:41 PM]
В 5 задании Optional разделил реализации JdbcMealRepositoryImpl и спринг начал ругаться при тестировании. Хотя я задаю в @Profile конкретные реализации


Ilya A. Kvyatkovsky [Today at 2:57 PM]
Ребят, дайте наводку, что должно лежать в тех профилях которые лежа пустыми в spring-db.xml
Я реально не понимаю что мы используем для той или иной реализации и как это влияет на другие классы. (edited)


27 replies
Gekov Iliya [8 hours ago]
Для jpa и datajpa мы используем jpa вендора, энтитименеджера и транзакции и там и там, отличия между ними в том, какие пакеты сканировать (edited)



Gekov Iliya [8 hours ago]
А для jdbc мы соответственно используем jdbctemplate'ты и не используем вендора и транзакции)


Ilya A. Kvyatkovsky [7 hours ago]
@Gekov Iliya Спасибо, теперь все прояснилось!


Dima [7 hours ago]
Странно,что после профилирования не может найти dataSource бин, хотя он указан в xml.


Gekov Iliya [7 hours ago]
@Dima Указан только в профилях БД, правильно?


Dima [7 hours ago]
ну да. я уже по всякому пробовал, и в @Profile тоже указывал БД


Gekov Iliya [7 hours ago]
В @ActiveProfiles указаны оба профиля? В мавене профиль бд выбран? (edited)


Dima [7 hours ago]
да, я уже все ревертнул, делаю заново, ща еще видосы посмотрю по этому поводу.


Gekov Iliya [7 hours ago]
А, еще момент, в db xml общий профиль для jpa и datajpa объявлен до профилей отдельных по jpa и datajpa?


Dima [7 hours ago]
да


Dima [7 hours ago]
может надо профиль БД обьявлять раньше общего профиля JPA и datajpa


Gekov Iliya [7 hours ago]
Да конечно) Там же датасорс определяется


Dima [7 hours ago]
ну если так, то как то на спринг не похоже. В обычном xml нет разницы,где ты обьявляешь бин, он все равно заинжектиться в любой проперти.


Gekov Iliya [7 hours ago]
@Dima Хм, нет, сейчас попробовал для интереса поменять местами, ничего не сломалось, тесты работают


Dima [6 hours ago]
фигня какая то,теперь не может найти бин репозитория) В тестах пишем в ActiveProfiles - БД и реализацию доступа к БД, над классами ставим @Profile. Может я что то упускаю?


Gekov Iliya [6 hours ago]
До optional еще не дошел, поэтому насчет @Profile ничего не могу сказать, но в остальном да, все так


Gekov Iliya [6 hours ago]
Если хочешь, могу в личку скинуть xml, чтобы сравнить


Dima [6 hours ago]
так у меня тесты вообще не идут, какой optional)) у тебя че, тесты рабоотают тупо от @ActiveProfiles и все? может у меня чето с идеей


Gekov Iliya [6 hours ago]
Да, просто указываем в ActiveProfiles профили и все


Gekov Iliya [6 hours ago]
А где ты Profile ставишь?


Dima [6 hours ago]
над классом. Допустим класс DataJpa там ставлю @Profile("datajpa")


Dima [6 hours ago]
лано, походу я чето неправильно делаю, буду читать


Gekov Iliya [6 hours ago]
Смотри, если ты уже разделил тестовые классы на абстрактный общий и реализации конкретные, то над абстрактным ставишь @ActiveProfiles и выбираешь реализацию БД, а над конкретным классом ставишь @ActiveProfiles с реализацией доступа, это все через наследование суммируется


Dima [6 hours ago]
я пока без разделения решил проверить как работают профили.


Gekov Iliya [6 hours ago]
Тогда до разделения, чтобы по самому простому проверить работу профилей ставишь к примеру над MealServiceTest @ActiveProfiles({"hsqldb", "datajpa"}), должно работать


Dima [5 hours ago]
до применения профилей в xml все ок, т.е. все лишнее закоментил и все работает. Как раскидал по профилям, то все валится. Значит спринг не загружает классы по профилям выбранным идеей.


Gekov Iliya [5 hours ago]
Скинь в личку свой xml, сравню со своим


Marat [Today at 3:13 PM]
Spring Data JPA это аналог Hibernate ? Немного не понял с этим.


3 replies
Gekov Iliya [8 hours ago]
Нет, это следующий уровень абстракции над jpa спецификацией, предоставляющий дополнительные возможности, а hibernate предоставляет конкретную реализацию этой спецификации (edited)


Gekov Iliya [7 hours ago]
Если быть точнее, вот строчка из документации: Spring Data JPA provides repository support for the Java Persistence API (JPA). It eases development of applications that need to access JPA data sources. То есть по сути, spring data просто делает разработку под JPA проще, предоставляя новые фичи для удобства (как например готовые реализации репозиториев)



Grigory Kislin [2 hours ago]
про JPA/ORM/Hibernate есть тут вопрос: https://github.com/JavaWebinar/topjava/blob/doc/doc/lesson04.md
Spring Data JPA сделана поверх JPA- дженерик репозиторий вынесен в отдельный модулдь спринг. посмотри видео из урока: https://jeeconf.com/archive/jeeconf-2013/materials/spring-data/ (edited)


ABaykov [7:21 PM]
Илья. Я починил проблему, отписался в ветку. Посмотри, может у тебя схожая проблема


Dima [Today at 10:26 PM]
После разделения тестов на разные реализации доступа к данным хорошо видна разница во времени выполнения тестов. Почти всегда проигрывает dataJPA, зато пишется легко) у меня самая большая разница оказалась в
```getUserByEmail---------
JDBC---26
JPA---15
DataJPA---231```
(edited)


3 replies
Gekov Iliya [21 minutes ago]
Да, не хило


Sergey Zhukov [14 minutes ago]
пока он сгенерит имплементации


Dima [12 minutes ago]
```getMeal---------
JDBC---106
JPA---10
DataJPA---18```
видимо разница просто в написании как именно достается


[1 day ago]
у меня такой большой разницы нет, в зависимости от теста.
```UserDataJpaServiceTest.getByEmail               29
UserJpaServiceTest.getByEmail                    8
UserJdbcServiceTest.getByEmail                  16```


```UserDataJpaServiceTest.update                   17
UserJpaServiceTest.update                       16
UserJdbcServiceTest.update                      21```
(edited)


Nov 4th at 10:54 PM]
получаю пользователя
```User user = userRepository.getOne(userId);```
есть смысл проверять его на null, прежде чем отдавать методу в meal-репозитории?
Вроде как пользователь уже авторизован должен быть на данном этапе и точно будет получен из базы. (edited)


1 reply
[1 day ago]
проверить не получится. метод getOne(userId), бросит исключение если не найдет запись
     ```/**
     * Returns a reference to the entity with the given identifier.
     *
     * @param id must not be {@literal null}.
     * @return a reference to the entity with the given identifier.
     * @see EntityManager#getReference(Class, Object)
     * @throws javax.persistence.EntityNotFoundException if no entity exists for given {@code id}.
     */
    T getOne(ID id);```
(edited)


Nov 4th at 11:25 PM]
Можно ли реализовать save() не через query, а через crudRepository.save(meal);
Нужно как-то выставить объект meal.user, получается это никак не сделать в Data JPA ?


10 replies
[1 day ago]
конечно,  в подсказках 6й пункт
 ```В Data-Jpa метод для ссылки на entity (аналог em.getReference) : T getOne(ID id)```


[1 day ago]
https://stackoverflow.com/questions/45831695/alternatives-to-getreference-method-in-spring-data-jpa
Stack Overflow
Alternatives to getReference method in Spring data JPA
I found myself struggling to implement customizable methods in Spring Data JPA. For example, I have a Pet class, which has an Owner(Many to One rel.) What if I have a method to save(Pet pet, int ow...
 


[1 day ago]
https://stackoverflow.com/questions/45831695/alternatives-to-getreference-method-in-spring-data-jpa

[1 day ago]
вот тут пишут один в один реализацию нашего репозитория, только говорят, что нужно это делать в сервисе

[1 day ago]
Ты смотрел что там в конце написано ?


[1 day ago]
Должно на мысли навести


[1 day ago]
да я думаю все понятно, только получается в Meal-репозитории будет зависимость от User-репо


[1 day ago]
Ну да это минус, но по другому видимо никак


[1 day ago]
почему минус? раз проверяем принадлежность к юзеру, значит ходим в юзер-репо


[1 day ago]
или используй нативный query


Maxim Valeev [Yesterday at 5:26 AM]
не могу разобраться как для разных имплементаций  подключать разный профиль реализации. Сейчас у нас профиль базы выбирает ActiveDbProfileResolver.class, в нем мы руками выставляли профиль реализации. Как сделать чтобы автоматом ставился профиль?


8 replies
Gekov Iliya [1 day ago]
Аннотации ActiveProfiles суммируются при наследовании, ставим профиль бд в базовом классе тестов, а профили доступа к базе в классах конкретных имплементаций


Maxim Valeev [1 day ago]
Спасибо)


Sergey Zhukov [1 day ago]
кто нибудь оставлял этот резолвер в тестах? я понял что он нужен для смены профилей во время запуска без перекомпиляции


Gekov Iliya [1 day ago]
Да, оставил


Gekov Iliya [1 day ago]
Он нужен, чтобы определять профиль БД по тому, какой драйвер подгружен через мавен (edited)


Sergey Zhukov [1 day ago]
вместе он у меня пока не очень хочет работать, т.е в абстрактном тесте ставим резолвер, а в имплементациях указываем точно?


Gekov Iliya [1 day ago]
В абстрактном оставляем резолвер, а в имплементациях указываем способ доступа (jdbc jpa datajpa)


Sergey Zhukov [1 day ago]
окей спасибо


Nikita Ganin [Yesterday at 9:25 AM]
"7: Проверьте, что в DataJpaMealRepositoryImpl все обращения к DB выполняются в одной транзакции" как это можно сделать?


2 replies
pal548 [1 day ago]
Не разобрался?


Nikita Ganin [21 hours ago]
Нет, вернее начал optional делать, а это оставил напоследок


Zhinko [Yesterday at 11:14 AM]
Как можно протестировать задание 7? Нам же надо дополнительные методы в общий интерфейс добавлять


15 replies
Gekov Iliya [1 day ago]
Ну, написать соответствующие тесты


Zhinko [1 day ago]
У меня почему то спринг ругается. Ты эти методы в отдельном классе делал?


Gekov Iliya [1 day ago]
Ну по id пользователя вместе с его едой соответственно в юзер сервисе, по id еду вместе с пользователем в мил сервисе


Zhinko [1 day ago]
А как ты вызвал эти методы если у общего интерфейса их нет ?


Gekov Iliya [1 day ago]
Не пойму, у какого общего интерфейса?


Zhinko [1 day ago]
Ну DataJpaMealRepository реализует интерфейс MealRepository. Если мы добавим новый метод dataJpa репозиторий , то в MealRepository его не будет, а тесты работают через MealRepository


Gekov Iliya [1 day ago]
Так никто не мешает их добавить и в MealRepository)


Gekov Iliya [1 day ago]
Или, если не хотим менять основной репо, то можно написать к примеру отдельный класс тестов и инжектить туда не по репозиторию, а конкретную реализацию только datajpa репозитория


Zhinko [1 day ago]
Вот я хочу 2 вариант

Gekov Iliya [1 day ago]
Правда в задании сказано протестировать сервис, а не репозиторий, так что я так понимаю все-таки надо по первому варианту делать


Gekov Iliya [1 day ago]
Если бы у нас были отдельные тесты для сервисов и для репозиториев, тогда проблем нет


Gekov Iliya [1 day ago]
Только сейчас обратил внимание: "5: Для уменьшения количества кода при реализации Optional (п. 7, только DataJpa) попробуйте сделать default метод в интерфейсе"


Gekov Iliya [1 day ago]
Как я понимаю, чтобы не пришлось делать пустые заглушки в остальных реализациях, просто делаем дефолтный метод и реализуем его только в datajpa

Nikita Ganin [1 day ago]
Тоже через профиль?

Gekov Iliya [1 day ago]
Нет, просто добавляем дефолтные методы в соответствующие репозитории, но реализуем только в datajpa репозитории


Vladimir Gorbatenko [Yesterday at 11:54 AM]
У кого-то получилось прикрутить spring.profiles.active через web.xml?
У меня что-то не хочет активировать профайлы... Пробовал и через <context-param> и через <init-param>.


5 replies
Gekov Iliya [1 day ago]
Вроде в задании написано, что надо поднимать контекст без spring.profiles.active



Vladimir Gorbatenko [1 day ago]
В задании - да, но почему бы не перепробовать всеми возможными способами для расширения кругозора.


Taras [1 day ago]
Насколько я понимаю, context-param требует listener, который это дело обрабатывает. А он из spring mvc.


Stepan [17 hours ago]
Не понял, как можно поднять контест без spring.profiles.active, то есть без такой строки
System.setProperty(AbstractEnvironment.ACTIVE_PROFILES_PROPERTY_NAME, "postgres, jdbc");
Киньте ссылку почитать


Gekov Iliya [17 hours ago]
Я ставил через setActiveProfiles, главное выставить до сканирования xml


Marat [Yesterday at 12:29 PM]
Когда мы переопределяем методы, то они из разных интерфейсов берутся. Как-то все запутано
Pasted image at 2018-11-05, 4:29 PM



1 reply
Gekov Iliya [1 day ago]
Да на самом деле ничего запутанного, иерархия простая: есть базовый интерфейс Repository его имплементит CrudRepository, добавляя методы crud, его в свою очередь имплементит PagingAndSortingRepository, который добавляет возможность разбития на страницы, его имплементит JpaRepository, всё, вот и вся иерархия


Gekov Iliya [Yesterday at 2:27 PM]
"7.1: достать по id пользователя вместе с его едой" Означает ли это, что в User добавляем коллекцию Meal?


7 replies
ABaykov [1 day ago]
так Григорий же и говорил в видео и писал об этом



Gekov Iliya [1 day ago]
Да? Как-то я это пропустил(


Gekov Iliya [1 day ago]
Тьфу, слепой, действительно пропустил в подсказках пункт


lifter4ik [1 day ago]
только где это поле из подсказки добавлено? казалось, я его видел во время применения патчей. сейчас в упор не вижу. или оно только в видео мелькало?


Gekov Iliya [1 day ago]
Не, нет его, надо самостоятельно добавлять видимо


lifter4ik [1 day ago]
отвечаю, я его видел))) осталось найти в каком видео уроке


Gekov Iliya [1 day ago]
Ну видео то старые, уж 10 раз все поменяться могло


Sergey Zhukov [Yesterday at 7:42 PM]
В Jpa и DataJpa UserServiceTest лезет Error SQL но все тесты проходит.
Это надо чинить?
SQLerror.png



8 replies
Gekov Iliya [22 hours ago]
Если не ошибаюсь, это в тесте на дублирующий емейл, так и задумывалось)


Sergey Zhukov [22 hours ago]
да он, я тоже подумал название теста подходит под ситуацию ))


Sergey Zhukov [21 hours ago]
@Gekov Iliya в итоговый отчет вставлял разделители по классам?


Gekov Iliya [21 hours ago]
Неа


Sergey Zhukov [21 hours ago]
там простыня в которой повторяются имена методов, нафик нужен такой отчет


Gekov Iliya [21 hours ago]
Меня так последний optional вымотал, что тупо не охота с логами морочиться)


Gekov Iliya [21 hours ago]
Но идея хорошая)


Sergey Zhukov [21 hours ago]
я их еще не начинал )


KaryNaiKo [Yesterday at 8:16 PM]
Не понимаю, почему не хочет находить ${jpa.showSql}, ведь я назначил активный профиль через
       ConfigurableEnvironment environment = springContext.getEnvironment();
       environment.setActiveProfiles("postgres");
       springContext.refresh(); (edited)


11 replies
pal548 [20 hours ago]
а jpa/jdbc ?


pal548 [20 hours ago]
appCtx.getEnvironment().setActiveProfiles("postgres", " *jdbc* ");


pal548 [20 hours ago]
а, нет, должно работать и так


Dima [20 hours ago]
делал через System.setProperty перед инициализацией контекста


creilyss [18 hours ago]
так чтобы выполнить getEnvironment springContext у тебя уже должен быть где-то проинициализирован. Так и падает он во время инициализации не доходя до проставления профиля. Я тоже делал как Дима.


Sergey Zhukov [18 hours ago]
А через GenericXmlApplicationContext неверный путь?
Через него получаю ConfigurableEnvironment, сетю профили, потом с помощью метода load загружаю контекст и делаю refresh()
Я смутно понимаю что я делаю, но оно работает


pal548 [18 hours ago]
тоже так сделал, думаю все норм


Vladimir Gorbatenko [7 hours ago]
Не понимаю, как оно с одним параметром профайла будет работать? У меня не работает.  При том что он и  базу postgres не ставит как актив, который у нас "прошит в pom.xml"  по умолчанию. И если в базу по умолчанию я бы понял что он выбрал, то как  ему выбирать какой профиль "jdbc/jpa/datajpa"?


Sergey Zhukov [7 hours ago]
у меня 2 параметра, через запятую перечислил (edited)


Vladimir Gorbatenko [7 hours ago]
2 параметра это да, у меня тоже работают, но выше писали мол и с одним должно...


Sergey Zhukov [7 hours ago]
да это задачка, тогда нужно копать как контекст спринга получит профиль из pom


This message was deleted.


3 replies
under4eg [20 hours ago]
второй работает


Gekov Iliya [20 hours ago]
Да и третий должен


Ilya A. Kvyatkovsky [20 hours ago]
Решил! Глупая была ошибка. Спасибо!


Ilya [Yesterday at 9:15 PM]
Вопрос, почему idea не предлагает переключать профили в xml?


4 replies
Ilya [20 hours ago]
Pasted image at 2018-11-05, 10:17 PM
 


Ilya [20 hours ago]
починил. отбой


Dima [20 hours ago]
ну зайди  в settings -> Languages & Frameworks -> Spring -> и там галочку посмотри Show Profiles panel


Ilya [19 hours ago]
нет там дело было в другом. project structure в спринге не было контекстов


Stepan [Yesterday at 9:53 PM]
Почему-то когда запускают все тесты через мавен, запускаются только 2 теста из папки веб, остальные игнорятся...в чем может быть проблема? идею перезапускал


2 replies
pal548 [19 hours ago]
Названия тестов должны оканчиваться на Test, у меня такое было


Stepan [19 hours ago]
Благодарю


Roman Baranov [Yesterday at 10:20 PM]
```5: Для уменьшения количества кода при реализации Optional (п. 7, только DataJpa) попробуйте сделать default метод в интерфейсе```
подскажите что здесь имеется ввиду? мы добавляем по методу в каждый репозиторий. что тут сокращать?


2 replies
Dima [18 hours ago]
если добавишь просто метод в репозиторий, то придется его реализовывать в каждой имплементации. Если делать метод default - то этого не придется делать


Roman Baranov [18 hours ago]
спасибо


Sergey Zhukov [Today at 12:19 AM]
по 5 пункту
ставлю @Profile("hsqldb") - бин инжектится, ставлю @Profile("postgres") - ничего не происходит
подскажите где переключается


6 replies
Gekov Iliya [17 hours ago]
А в мавене переключаешь базу?


Sergey Zhukov [17 hours ago]
в мавене на postgres галка стоит


Sergey Zhukov [17 hours ago]
есть еще какой материал наводящий по @Profile?


Gekov Iliya [17 hours ago]
Да там больше ничего и не требуется, ставишь Profile с бд и в зависимости от того какая сейчас бд стоит в activeprofiles, такая имплементация jdbc репозитория срабатывает


Sergey Zhukov [16 hours ago]
короче что-то с интеграцией idea, в тестах обращается к нужной имплементации, но подсветка как кандидата на инжекцию не показывается, при переключении в мавене, все время листики на hsqldb
почему он не рисует :four_leaf_clover: - "должно повезти"


Nikita Ganin [11 hours ago]
Попробуй сделать clean


Marat [Today at 7:44 AM]
Подскажите зачем мы используем этот конструктор?
public User(Integer id, String name, String email, String password, Role role, Role... roles) {
       this(id, name, email, password, DEFAULT_CALORIES_PER_DAY, true, new Date(), EnumSet.of(role, roles));
   }


1 reply
Roman Baranov [8 hours ago]
пользователь может иметь несколько ролей.


Sergey Zhukov [Today at 9:51 AM]
по 5 скажите, верно я понял шаблонный метод?
    ```@Override
    public Meal save(Meal meal, int userId) {
        return convertToTimeStampAndSave(meal, userId, false);
    }```
у меня в этом методе в зависимости от переданного флага конвертит или нет
для hsqldb соответственно вызываю с true (edited)


10 replies
Gekov Iliya [7 hours ago]
Я думаю разные варианты можно придумать, я к примеру маппинг вынес в отдельный метод и в hsqldb реализации его переопределил (edited)


Sergey Zhukov [7 hours ago]
это под паттерн попадает или я что-то горожу из другого паттерна

Sergey Zhukov [7 hours ago]
```2: В реализациях JdbcMealRepository код не должен дублироваться.```
как переопределить мапинг без дублирования?

Gekov Iliya [7 hours ago]
Я вообще разделил метод сейв на два этапа - два метода, один мапит, второй вносит в базу, мапинг переопределил в реализации hsqldb, соответственно в зависимости от базы вызывается разный мапинг, а в базу заносится одним и тем же методом



Gekov Iliya [7 hours ago]
Не уверен, что именно это правильно с точки зрения паттерна, но дублирования кода нет


ABaykov [6 hours ago]
Шаблонные метод - это когда у тебя есть каркас в методе

Типа такого -
шаг 1 - сделай маппинг
шаг 2 - сохрани в базу
шаг 3 - верни результат

Ты переопределяешь для разных реализаций конкретно шаг 1. А шаг 2 и 3 так и остаются общими (edited)


Nikita Ganin [5 hours ago]
Можно создать абстрактный метод конвертации времени, и сделать две реализации в зависимости от профиля, в одном для одной базы в другом для другой



Sergey Zhukov [5 hours ago]
@ABaykov спасибо, вроде понял
у меня значит паттерн "дичь", т.к. подрузумевает 2 варианта развития событий :grin: (edited)


Sergey Zhukov [4 hours ago]
@Nikita Ganin сделал так, но Object заменить дженериком пока не  могу


pal548 [3 hours ago]
Я вынес добавление параметра в мапу параметров в отдельный метод. Но не стал делать его абстрактным, а в нем сделал реализацию для Pg. Соответственно, класс дня Hsql наследуется от класса Pg и переопределяет этот метод. Не знаю, насколько это по фен-шую) (edited)


Sergii [Today at 12:37 PM]
Попробовал всю еду по юзеру организовать без реализации, методами Spring Data и получил в результате List<Meal> getAllByUserOrderByDateTimeAllSortedDesc(User user) . Это нормально ? Имеет право на жизнь ? (edited)


11 replies
Nikita Ganin [5 hours ago]
Ну в этом и плюс Spring Data:slightly_smiling_face:


Sergii [5 hours ago]
За такое в приличных конторах по башке не дадут ?)


Sergii [5 hours ago]
А я всегда по методу шланга делаю - сначала делаем , как понимаем , потом понимаем , что не взлетело и ... переходим к чтению инструкций)


Gekov Iliya [5 hours ago]
Я перепутал, там про другой момент речь)


ABaykov [5 hours ago]
а почему собственно за это должны давать по башке? если такое объявление избавляет тебя от написания query запроса) Всё четко и лаконично


Sergii [5 hours ago]
Накалякать накалякал - теперь пойду проверять, что оно там действительно возвращает)

Sergii [4 hours ago]
getAllByUserOrderByDateTimeDesc - так получше

Sergey Zhukov [4 hours ago]
когда between добавляешь вообще каляка получается


Sergii [4 hours ago]
с битвином - вообще жуть) в моей практике это первое место по длине имени метода)


Sergii [4 hours ago]
ФайндАбраКадабраБайАбырвалгКиргудуБарбарбия)


Ilya [1 hour ago]
в спринге все с такими названиями


Илья Чиликин [1 day ago]
`getAllByUserOrderByDateTimeAllSortedDesc` равносильно
`getByUserOrderByDateTimeDesc` - уже короче.
А если Sort передать параметром, остаётся `getByUser`. (edited)


KaryNaiKo [Nov 6th at 6:44 PM]
Господи... -2 дня на устранение ошибки в профилях... Видите разницу в "jdbc" и "jdbs"? А я вот не видел(((
Объясните, плс, а зачем помечать аннотацией @Profile помимо сервисов (тут понятно, разная реализация repository) еще и все controller'ы? Ведь контроллеры сканятся в spring-app, где нет профилей + у нас одна реализация сервисов.


18 replies
Gekov Iliya [1 day ago]
А почему решили что контроллеры и сервисы надо помечать? Достаточно репозитории пометить (edited)

KaryNaiKo [1 day ago]
Я так сначала и сделал, но вылетает ошибка, что сервисы не найдены


Taras [1 day ago]
Посмотри внимательно какие пакеты сканируются.


Dima [1 day ago]
я тоже помечал все @Profile, без этого не находит нужные бины контекст.


Gekov Iliya [1 day ago]
@Dima у нас же только в jdbc репозитории разделение на профили бд идет, если все пометить, то при каждом смене БД в мавене надо вручную все аннотации менять?


Gekov Iliya [1 day ago]
Да и теряется вся логика. Profile определяет какой бин попадет в спринг контекст в зависимости от активных профилей, нам регулировать в данном случае нужно только бин jdbc репозитория



Dima [1 day ago]
ну не совсем вручную) я использовал константы из класса Profiles. Я гуглил как надо делать, только либо я тугой, либо никто должным образом не уделяет этому нормальных статей, ничего не нашел, почему приходится указывать каждому классу со спринговой аннотацией профиль.


Dima [1 day ago]
без профайлинга в xml спринг подгружает все сам, как только появляется профайлинг, то спринг уже не может найти класс(даже с аннотацией @Component), если на нем нет @Profile.


Gekov Iliya [1 day ago]
У меня всего стоит две аннотации Profile над двумя реализациями jdbc репозитория., больше нигде. Всё работает.



Dima [1 day ago]
хотя если смотреть на <context:component-scan> , то там отображаеются сервисы


Gekov Iliya [1 day ago]
А при запуске сервлета указали оба активных профайла? (к примеру "hsqldb", datajpa"").


Dima [1 day ago]
обязательно.


Gekov Iliya [1 day ago]
Странно, какая то беда с настройкой профилей


Dima [1 day ago]
обновление: за закомментил все @Profile, кроме репозиториев и приложение поднялось. Видимо глючит идея или магия)


Gekov Iliya [1 day ago]
Наверное надо было проект пересобрать. Теперь можно оценить насколько это удобное решение - переключаешь БД в мавене и всё, нужная реализация Jdbc репозиторя автоматически подгружается :+1: (edited)


Dima [1 day ago]
эти пляски с бубном иногда кумарят)

Gekov Iliya [1 day ago]
Боюсь представить первые дни работы на настоящем проекте)


Nikita Ganin [1 day ago]
У меня например в сервисах идея ругается на репозиторий, что существует больше одного бина, но все равно работает


ABaykov [7:25 PM]
Такой вопрос. Если мы достаем юзера с едой по id
То как нам сравнить двух юзеров с едой?


ABaykov [Nov 6th at 7:27 PM]
если сравниваю чисто списки еды, то тест проходит. А вот assertThat двух юзеров с едой - сыпется


4 replies
Gekov Iliya [1 day ago]
Я решил так - сравниваю отдельно еду (без поля юзер) и самого юзера



ABaykov [1 day ago]
Не. С этим как раз проблем нет. Если я достал еду с юзером, то сравнение двух премов пищи с юзером внутри - проходит. А когда достал юзера с инициализированной колекцией еды внутри, тут затык. Можно, конечно, сравнить сначала двух юзеров без еды. А потом отдельно еду у них) спасибо за идею


Gekov Iliya [1 day ago]
Да, я это и имел в виду) Наверняка можно сделать красивее, но у меня не получилось)


ABaykov [1 day ago]
сейчас попробую в AsserJ порыться. Но как-то я пилю это с 11 утра... и порядком устал)


Roman Baranov [Nov 6th at 8:50 PM]
```9: Проверьте, что все тесты запускаются из Maven (имена классов тестов удовлетворяют соглашению) и итоги тестов класса выводятся корректно (не копятся)```
это получается надо дублировать сбор результатов и печать в каждом тестовом классе?


2 replies
lifter4ik [1 day ago]
я сделал в абстрактном через @BeforeClass, что бы сводка обнулялась


Roman Baranov [1 day ago]
super :+1:
я както не дошел до этого


pal548 [Nov 6th at 11:06 PM]
Как реализовали п.5, Optional ДЗ, метод, возвращающий нужный объект DateTime ?


7 replies
pal548 [1 day ago]
я сделал абстрактный
protected abstract <T> T getDateTimeForParams(LocalDateTime dateTime);
потом в наследнике пишу так:
@Override
   protected *Timestamp* getDateTimeForParams(LocalDateTime dateTime)


pal548 [1 day ago]
идея говорит, что тут будет непроверяемое приведение типа. Ну можно конечно сделать через дженерик-класс, а не метод.


Sergey Zhukov [1 day ago]
у меня тоже ругнулась на это, в итоге
я сделал без дженериков, возвращал Object в абстрактном методе, посмотрю в четверг как правильно


pal548 [1 day ago]
а, впринципе все проще, можно параметризовать базовый тип

pal548 [1 day ago]
JdbcMealRepositoryAbstractImpl<T>
а наследовать с указанием типа
public class JdbcMealRepositoryPgImpl extends JdbcMealRepositoryAbstractImpl<LocalDateTime>


Sergey Zhukov [1 day ago]
отоночо :slightly_smiling_face: попробую так же сделать


ABaykov [1 day ago]
cделал так же так шо параметризуйте)


Vitaliy Ivkin [Yesterday at 9:23 AM]
Вроде работает. Следовало ли создавать новый абстрактный класс для тестов, или достаточно просто объявить мил/юзерСервисТест абстрактными и унаследоваться всеми тестами от них?
Pasted image at 2018-11-07, 10:23 AM



6 replies
Gekov Iliya [1 day ago]
Если не создавать один общий класс, то остается много дублирующего кода


Vitaliy Ivkin [1 day ago]
Я решил объявить исходные два тестовых класса абстрактными, скопировал код с @Rule из Мил в Юзер + метод для вывода в лог. Вот и весь дублирующий код


Gekov Iliya [1 day ago]
Плюс аннотации с конфигами и профилем, зачем приводить к копипасту если этого можно избежать?


Vitaliy Ivkin [1 day ago]
Применил аннотации профилей как в вебинаре для тестов, так что копирования по минимуму. Или ты про описанное выше?
Pasted image at 2018-11-07, 10:37 AM
 


Gekov Iliya [1 day ago]
Еще расположение конфигов спринга, а если что то придется менять или добавлять, придется уже в двух местах менять вместо одного. Минимум копирования, максимум, ка как по мне не важно, это в любом случае зло, избежать этого можно за 2 минуты работы. Но это всего лишь мое мнение, можно и копировать



Vitaliy Ivkin [1 day ago]
Спасибо за совет, я постараюсь с этим разобраться


Ilya [Yesterday at 9:33 AM]
дошел до пункта 6. Но приложение выдает ошибку, кто нибудь  с этим сталкивался? Код пока не менял. Судя по ошибки что то с томкатом, не видит сервлетов
Pasted image at 2018-11-07, 10:33 AM



15 replies
Gekov Iliya [1 day ago]
Профили в сервлете выставил?


Ilya [1 day ago]
нет


Gekov Iliya [1 day ago]
В этом и суть пункта 6)


Ilya [1 day ago]
а я думал в другом) ок сейчас проверю


Gekov Iliya [1 day ago]
Но вообще если я правильно понимаю, то без профилей ошибку должен выдавать на этапе попытки подключения к базе, а не сразу при загрузке локалхоста, так что возможно проблема и не в этом...


Ilya [1 day ago]
ну вот и я про тоже так думаю. Профили не помогли(


Gekov Iliya [1 day ago]
Как варинт - после запуска глянуть список бинов в контексте, все ли на месте


Vladimir Gorbatenko [1 day ago]
какую страницу он не может открыть (найти)? (edited)


Ilya [1 day ago]
прикол в том что в init он не заходит(


Ilya [1 day ago]
users


Ilya [1 day ago]
что то с диплоем не так(


Ilya [1 day ago]
все ок, нашел)


Ilya [1 day ago]
JRE 11 надо было поставить
Pasted image at 2018-11-07, 10:58 AM



Zhinko [1 day ago]
вообще я так понимаю, что без выставления профилей спринг не будет понимать к какой базе коннектиться и какую реализацию использовать


Gekov Iliya [1 day ago]
Если быть точнее, спринг просто не загрузит бины, объявленные в этом профиле, в свой в контекст (edited)


indisbk [Yesterday at 12:49 PM]
Подскажите, пожалуйста, в каком направлении думать чтоб выполнить 7.2 пункт?)  Как реализовать в SpringData meal.getUser()?


4 replies
Zhinko [1 day ago]
в подсказках к дз есть


Zhinko [1 day ago]
Ordering a join fetched collection in JPA using JPQL/HQL


Zhinko [1 day ago]
там практически готовое решение


indisbk [1 day ago]
ок разберемся)


senadnepr [3:23 PM]
Просто прелестно! Вместо такой вот жути:
 ```@Query("select m from Meal m where m.user.id = :user_id and m.id = :id")
    Meal get(@Param("id")int id, @Param("user_id")int userId);```
Вот такая красота!
```Meal getByIdAndUser_Id(int id, int userId);```


senadnepr [Yesterday at 3:24 PM]
А вот это вообще прекрасно!
```List<Meal> findByDateTimeBetweenAndUser_IdOrderByDateTimeDesc(LocalDateTime startDate, LocalDateTime endDate, int userId);```


6 replies
Igor [23 hours ago]
Программирование через именование методов меня смущает. Уж лучше старый добрый sql запрос. Хотя может я старомоден...



Dima [23 hours ago]
вот именно, ты программируешь, а не думаешь как там писать запросы на sql


Sergey Zhukov [22 hours ago]
зачем писать User_Id, можно без пробела UserId


Ilya [21 hours ago]
запросы бывают разные, ничего сложнее простой выборки тут все равно не написать) так что sql жив)


senadnepr [21 hours ago]
User_Id - нагляднее, как аналог meal.User.Id. Так и в документации написано.


Илья Чиликин [16 hours ago]
Дайте ссылку, где в документации советуют использовать подчёркивания.


Raisa [Yesterday at 5:44 PM]
падают тесты с hsqldb, причина: Caused by: org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'entityManagerFactory' defined in class path resource [spring/spring-db.xml]: Cannot resolve reference to bean 'dataSource' while setting bean property 'dataSource'; nested exception is org.springframework.beans.factory.CannotLoadBeanClassException: Cannot find class [org.apache.tomcat.jdbc.pool.DataSource] for bean with name 'dataSource' defined in class path resource [spring/spring-db.xml]; nested exception is java.lang.ClassNotFoundException: org.apache.tomcat.jdbc.pool.DataSource
Related cause: org.springframework.beans.factory.CannotLoadBeanClassException: Cannot find class [org.apache.tomcat.jdbc.pool.DataSource] for bean with name 'dataSource' defined in class path resource [spring/spring-db.xml]; nested exception is java.lang.ClassNotFoundException: org.apache.tomcat.jdbc.pool.DataSource

подскажете, в чем может быть проблема?
насколько я поняла, datasource не может найти, что это значит? (edited)


5 replies
Vladimir Gorbatenko [20 hours ago]
org.apache.tomcat.jdbc.pool.DataSource - для профиля postgres


Raisa [20 hours ago]
я переключила профили в мавене и в spring-db, почему он может искать для postgres?


Gekov Iliya [20 hours ago]
Или профили неправильно настроены или аннотации над тестовыми классами (edited)



Taras [18 hours ago]
Не видит dataSource. Проверь, как ты разнесла определение бинов по профилям. И jpa и datajpa требуют dataSource.


Raisa [2 hours ago]
проблема была в неправильной аннотации над тестовым классом :slightly_smiling_face: сделала resolver в абстрактном классе, все заработало


Marat [Yesterday at 6:46 PM]
Не могу додуматься как сделать реализацию сохранения еды
Meal save(Meal meal, Integer userId);


1 reply
Gekov Iliya [19 hours ago]
Если проблема в том, как юзера установить, то смотрим пункт 6 подсказок


Raisa [Yesterday at 7:06 PM]
у кого-нибудь падали тесты JdbcMealSevisTest с bad SQL grammar c hsqldb?


2 replies
Zhinko [19 hours ago]
Это потому что hsql не поддерживает LocalDateTime. Тебе нужно использовать класс Timestamp.


Raisa [19 hours ago]
спасибо :slightly_smiling_face:


Sergey Zhukov [Yesterday at 10:34 PM]
по 7 подскажите кто сделал.
1. Мы добавляем список еды пользователю
2. чиним тесты которые уже есть, добавлением игнора поля в assert
3. добавляем дефолтные методы в интерфейсы
4. добавляем в существующий класс тестов datajpa тесты для этих методов
Что-то упустил?


14 replies
Gekov Iliya [15 hours ago]
Вроде нет


Sergey Zhukov [15 hours ago]
@Gekov Iliya ты как тестил?
       ```User user = service.getById(USER_ID);
        UserTestData.assertMatch(user, USER);
        MealTestData.assertMatch(user.getMeals(), MEALS);```


Gekov Iliya [15 hours ago]
Также


Sergey Zhukov [14 hours ago]
@Gekov Iliya
```11: В релизации 7.1 учесть, что у юзера может отсутствовать еда```
это если пустой, то что делаем?


Sergey Zhukov [14 hours ago]
список останется null?

Sergey Zhukov [14 hours ago]
Jpa его даже не инициализирует пустым?


Gekov Iliya [14 hours ago]
Я сделал как с юзер ролями, то есть в сеттере присваиваем новый пустой список

Gekov Iliya [14 hours ago]
Но не уверен что именно это имелось в виду


Sergey Zhukov [14 hours ago]
может наоброт в гетере проверять что со списком


Sergey Zhukov [14 hours ago]
хотя вроде логично в сетере, чтобы нулпоинтер не словить
```CollectionUtils.isEmpty(meals) ? Collections.emptyList() : meals;```


Gekov Iliya [14 hours ago]
Ага


Sergey Zhukov [14 hours ago]
@Gekov Iliya а NotFound-тесты писал?


Gekov Iliya [14 hours ago]
Неа, поленился)


Sergey Zhukov [14 hours ago]
тоже уже не успел закомичу без них


Ilya [Yesterday at 11:12 PM]
http://www.javarticles.com/2013/12/spring-profiles.html



4 replies
Ilya A. Kvyatkovsky [14 hours ago]
Спасибо! Отличная статься с подробным объяснением и понятными примерами. Статья необходима в материалах к этому уроку.


Zhinko [14 hours ago]
Да статья хороша


Sergey Zhukov [14 hours ago]
тоже парсил эту статью, когда искал как починить SpringMain и MealServlet
тяжело осваивать пока не сделают нормальную интеграцию профилей в IDEA, в галках путаешься поначалу


Vladimir Gorbatenko [5 hours ago]
отличная статья


Kirill Shiryaev [12:30 PM]
PDF 
Walls C. - Spring in Action - 2019.pdf
18 MB PDF


Marat [12:34 PM]
Привет всем. Подскажите, вот у нас есть интерфейс interface CrudUserRepository extends JpaRepository. При этом есть класс DataJpaUserRepositoryImpl implements UserRepository. Но почему он не имплементирует CrudUserRepository?


Sergey Zhukov [Today at 12:38 PM]
чтобы не получить имплементацию с кучей ненужных методов, делегируем


11 replies
Gekov Iliya [1 hour ago]
Ну не совсем так, Григорий в видео объяснял делегируем, чтобы обойти ограничения, например в jparepository delete возвращает int, а мы по нашей логике хотим boolean


Marat [1 hour ago]
Понял, спасибо


Gekov Iliya [1 hour ago]
Если сигнатуру методов дефолтных изменять не надо, то можно так и не заморачиваться


Sergey Zhukov [1 hour ago]
@Gekov Iliya ограничения только архитектурные.
Тот же boolean delete(int, int) получим без ограничений
Или еще есть ограничения?
crud_meal.png



Gekov Iliya [43 minutes ago]
Ну да, архитектурные, чтобы наша логика построенная, к примеру, в сервисе на основе возвращаемых значений не сломалась

Gekov Iliya [37 minutes ago]
Если бы нас например устраивало, что delete возвращает void, то мы могли бы просто сразу crudmealrepository в сервис инжектить да и всё, без всяких прослоек в виде своего mealrepository (edited)

Sergey Zhukov [24 minutes ago]
В сервис мы инжектим MealRepository, чтобы заинжектить надо реализовать а если мы имплементим еще и JpaRepository то надо уже и все его методы реализовать... т.е. получаем такую вот фигню
короче делегирование самый простой способ все заиметь в одной реализации
Нам Спринг подсунет SimpleJpaRepository (edited)
crud_meal2.png



Sergey Zhukov [19 minutes ago]
он нам не нужен в спринге, но в реале там подсунута реализация
я отвечаю на вопрос топикстартера
```Но почему он не имплементирует CrudUserRepository?```


Sergey Zhukov [17 minutes ago]
в выпускном можно фигарить JpaRepository или CrudRepository прям в сервис, но тут другая ситуация, ублажаем готовый сервис


Gekov Iliya [17 minutes ago]
Аа, понял, ну да, все верно, я думал мы уже отошли от той темы)


Gekov Iliya [10 minutes ago]
Я видимо изначальный вопрос не так понял, думал речь идет о том, почему userrepository не имплементит cruduserrepo (edited)


Grigory Kislin [20 hours ago]
> в выпускном можно фигарить JpaRepository или CrudRepository прям в сервис
и даже прямо в контроллер


fonto [19 hours ago]
@Grigory Kislin  это сарказм?;)


Marat [17 hours ago]
Что значит фигарить? Наследоваться сразу в сервисе вот так class MealServiceImpl implements MealService extends JpaRepository? (edited)


Gekov Iliya [17 hours ago]
@Marat Нет, если не относительно нашего проекта: создаем интерфейс MyRepository,экстендим JpaRepository, всё, репозиторий по сути готов. Далее в сервисе, к примеру, MyService инжектим поле MyRepository. Всё, репозиторий готов к работе, реализаций в виде класса для репозитория не требуется (edited)


Sergey Zhukov [16 hours ago]
инжектоавтоварить


Sergey Zhukov [14 hours ago]
@Marat фигарить вылетело, я имел ввиду @Autowired :grin:


KaryNaiKo [Yesterday at 8:18 PM]
Объясните, зачем нужна аннотация @Modifying?


6 replies
Sergey Zhukov [14 hours ago]
из гугла
```@Modifying говорит о том, что указанный метод должен быть интерпретирован как модифицирующий запрос```
я так понял это команда будет в базу дана, готовься к апдейту


Gekov Iliya [14 hours ago]
https://www.logicbig.com/tutorials/spring-framework/spring-data/modifying-queries.html


Sergey Zhukov [14 hours ago]
почти угадал )


Gekov Iliya [14 hours ago]
После выполнения модифицирующих запросов в контексте энтити менеджера может остаться неактуальная инфа по сущностям, эта аннотация, как я понимаю, дает спрингу понять, что этот запрос именно update и надо очистить энтити менеджер от устаревшей инфы


Sergey Zhukov [14 hours ago]
наверно не спрингу а хибернейту


Gekov Iliya [14 hours ago]
Ну да, имеется в виду, что спринг сканирует аннотации и дальше по цепочке отдает команды, в итоге это конечно ляжет на плечи хибернейта (edited)


Roman Baranov [9:40 PM]
а отчего используются запросы с индексами параметров
`@Query("SELECT m FROM Meal m JOIN FETCH m.user WHERE m.id = ?1 and m.user.id = ?2")`
а не с именнованными параметрами
`@Query("SELECT m FROM Meal m LEFT JOIN FETCH m.user WHERE m.id=:id AND m.user.id=:userId")`
ведь с именнованными параметрами легче читать


Sergey Zhukov [Today at 10:34 AM]
по предложенному решению:
в чем отличия?
предложено:
    ```@Override
    public Meal get(int id, int userId) {
        return crudMealRepository.findById(id).filter(meal -> meal.getUser().getId() == userId).orElse(null);
    }```
мое решение, может я что-то не учел?
    ```@Override
    public Meal get(int id, int userId) {
        return mealRepository.getByIdAndUserId(id, userId);
    }```
*upd* одно отличие я заметил, мне пришлось его объявить в интерфейсе, чтобы JPA сгенерил мне запрос, Григорий использовал дефолтный метод (edited)


2 replies
Gekov Iliya [12 minutes ago]
Кода перед глазами нет, не помню, второй способ что возвращает если не найден такой мил?


Sergey Zhukov [8 minutes ago]
тесты проходят, значит null


Zhinko [3 days ago]
1 способ ты переопределяешь метод интерфейса findById() и метод возвращает optional. 
2 способ ты пишешь свой метод 
В плане отличий мне кажется что 1 способ будет работать быстрее , так как ты просто переопределяешь метод интерфейса.


Sergey Zhukov [3 days ago]
@Zhinko там нет переопределения, Григорий использует готовый метод. Спрашиваю про различия в результатах, может есть какая-то неучтенная мной ситуация.


Sergey Zhukov [3 days ago]
сейчас у Григория мы получаем из базы даже еду не пренадлежащую пользователю, а потом применяем фильтр по userId, отдаем или еду или null? (edited)


Gekov Iliya [3 days ago]
Получается так


Grigory Kislin [3 days ago]
результат тот же


Sergey Zhukov [Nov 9th at 8:55 PM]
@Grigory Kislin смотрю @NamedEntityGraph убрали из User и заменили @EntityGraph(attributePaths = {"meals", "roles"})
это короткая запись?
почему добавили roles?


4 replies
Grigory Kislin [3 days ago]
да, под патчем есть что заменил на запись короче
roles- тк мы их тоже тянем


Dima [3 days ago]
Григорий, EntityGrath в нашем случае заменяет двойной join fetch?


Sergey Zhukov [3 days ago]
да там в видео говорится об этом


Sergey Zhukov [3 days ago]
просто в видео roles не подтягивали


senadnepr [4:11 PM]
@Grigory Kislin При всём уважении!
Если мы "дошли" до DataJPA, почему мы не используем "на полную" её возможности?
Люди старались, проделали огромную работу.
Можно только догадываться (или подсмотреть!),
какой сложности RegExp-ы использовались, а мы им - запросы с параметрами!
Наверняка, трудились над оптимизацией, а мы им - это медленно, это можно
использовать только вначале, когда еще не определились с вариантом базы данных! (Слова
самого Spring-потрошителя из видео!)
Старались, чтобы названия функций выглядели самодостаточно, чтобы
после каждой не писать комменты об их истинной функциональности, как, кстати
и рекомендуется делать во всех книгах. Собственно, это и есть часть "философии Java",
как я понял из Эккеля. А мы им - слишком сложные названия, магия непонятная...
К чему это я - сделал свою реализацию CrudMealRepository:
   ```@Transactional
    @Modifying
    int deleteByIdAndUser_Id(int id, int userId);

    Meal getByIdAndUser_Id(int id, int userId);

    List<Meal> findByUser_IdOrderByDateTimeDesc(int userId);

    List<Meal> findByDateTimeBetweenAndUser_IdOrderByDateTimeDesc(LocalDateTime startDate, LocalDateTime endDate, int userId);```
Ну и тесты к нему.
Прогнал общее решение и своё. Не по одному разу, и не по два, ес-но. Результаты сравнимы. Рис.1.
А вот, когда начал гонять тесты все вместе, через Maven, то, вначале, мой вариант давал результаты
в пять-семь раз хуже. А где-то после пятого круга его результаты стали сравнимы,
(даже лучше!) с типа "быстрыми" JDBC и Jpa. Рис. 2. Вот тут и возникает вопрос: это и есть
проявление этого "пресловутого" разогрева Java-машины. Если да, то почему это видно только
в DataJPA. Если нет - то где я ошибаюсь и как правильно проводить тесты на время при
разных реализациях. И нужно ли в разработке вообще уделять внимание улучшению скорости
при "разогреве"? (edited)
test2.jpg 

test3.jpg 



Grigory Kislin Yesterday at 6:28 PM
@senadnepr нравится- делай:) как это работает - я покопал в начале использования (в видео вроде есть).
https://habr.com/post/232381 : Spring Data JPA
как в проектах это будет использоваться- все субъективно от тимлида зависит
 Хабр
По следам Spring Pet Clinic. Maven/ Spring Context/ Spring Test/ Spring ORM/ Spring Data JPA
Здравствуйте! Spring MVC, согласно обзору инструментов и технологий Java за 2014 г. от RevbelLabs, является самым популярным веб фреймворком. Далее тот же... (77 kB)

 
senadnepr 19 hours ago
Ок, буду разбираться. Мне интересно, как они многотабличные запросы реализовали. Покопаюсь...


regorov [Yesterday at 11:01 PM]
@Grigory Kislin Григорий, пояснишь по транзакциям? В статье, ссылка на которую приводится в HW5 https://www.ibm.com/developerworks/ru/library/j-ts1/index.html говорится так "при использовании ORM флаг "только чтение", как правило, бесполезен, и в большинстве случаев игнорируется" и даже так "Еще лучше вообще не использовать аннотацию @Transactional при чтении данных из базы". В HW5 наоборот есть пункты:  а) 7.3: обращения к DB сделать в одной транзакции (можно сделать разные варианты) б) 7: Проверьте, что в DataJpaMealRepositoryImpl все обращения к DB выполняются в одной транзакции.
ibm.com
Распространенные ошибки
В этой статье Марк Ричардс описывает распространенные подводные камни, которые могут привести к потере согласованности. Они объясняются на примерах, взятых из инфраструктуры Spring Framework и спецификации EJB (Enterprise JavaBeans) 3.0.
 


1 reply
Grigory Kislin [14 hours ago]
да, в занятии есть про это ссылка
https://jira.spring.io/browse/DATAJPA-601