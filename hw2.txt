Grigory Kislin [10:38 PM]
joined #hw2.

Grigory Kislin [10:38 PM]
set the channel topic: https://github.com/JavaWebinar/topjava/blob/doc/doc/lesson02.md

Grigory Kislin [10:40 PM]
Привет! Разбор HW1 + 2-е занятие:
https://github.com/JavaWebinar/topjava/blob/doc/doc/lesson02.md
Успехов!
GitHub
JavaWebinar/topjava
Contribute to JavaWebinar/topjava development by creating an account on GitHub.

Constantine [10:43 PM]
joined #hw2 along with 18 others.


Vitaliy Ivkin [Today at 1:30 PM]
И снова в бой с новыми силами



2 replies
Dima Pugovkin [4 hours ago]
для начала следует разобраться в косяках проигранной предыдущей битвы :face_with_monocle:



Andrey Tolkachev [4 hours ago]
собираем выживших, лечим "косячных", даем всем выпить для храбрости и бьемся дальше :sunglasses:


Igor [Today at 4:38 PM]
В *2_2_HW1_optional.patch* пропущен импорт `java.util.Collection` в классе `MealsUtil`. Так и пушить?.. Изменения в ветке `master` только патчами ведь... (edited)


9 replies
Rogozinnikov Evgeny [38 minutes ago]
у меня не таких пропусков ипорта. может ты что-то удалил?


Andrey Tolkachev [37 minutes ago]
у меня добавился import java.util.*; и все


Igor [30 minutes ago]
До патча у меня тоже было `import java.util.*;`. Может идея сама что-то поменяла..


Igor [28 minutes ago]
Добавлю руками. Надеюсь ничего не сломается.


Andrey Tolkachev [27 minutes ago]
поставь в настройках Optimize imports on the fly, удобно


Igor [18 minutes ago]
@Andrey Tolkachev поставил, но не уверен, что понял как она работает


Andrey Tolkachev [16 minutes ago]
все просто, идея анализирует импорты в твоих классах, и если есть неиспользуемые (серые), то она их автоматически стирает. Еще если много классов/интерфейсов из одного пакета, идея для экономии места импортирует просто весь пакет (edited)


Igor [14 minutes ago]
@Andrey Tolkachev спасибо за разъяснение


Andrey Tolkachev [14 minutes ago]
не за что)


Rogozinnikov Evgeny [Today at 4:49 PM]
Добрый день, не подскажите, патч Apply 2_3_app_layers.patch на старый проект накатывать? в видео с новым проектом работаем, как я понял


1 reply
Andrey Tolkachev [33 minutes ago]
все накатывается на старый проект, который был форкнут еще перед выполнением нулевого дз


Timur_Gainitdinov [4:50 PM]
А что значит фраза "Подсказки по HW02 (для проверки, сначала сделайте самостоятельно!)"(с) ?
Этот блок смотреть только после того как будут самостоятельно написаны первые решения? (edited)

fonto [4:59 PM]
Почему-то письмо со вторым занятием так и не пришло на почту

senadnepr [5:18 PM]
По поводу видео HW01-optional: Firefox не поддерживает новый элемент datetime-local в HTML5. Поэтому в нём такой красоты с вводом даты пока не получится!


KaryNaiKo [Oct 11th at 9:42 PM]
Подскажите как работает строка repository.computeIfPresent(meal.getId(), (id, oldMeal) -> meal); в методе InMemoryMealRepositoryImpl.save ()?
что за значения id, oldMeal? Откуда они берутся? Как получается новое значение в мапе?


6 replies
Idan Baskin [8 days ago]
Пытаемся положить в мапу пару id - meal. Если такой ключ id есть (в мапе есть пара id - oldMeal), то после работы метода в мапе будет пара id- meal вместо id - oldMeal.


KaryNaiKo [8 days ago]
@Idan Baskin Зачем это нужно и какая цель - понятно. Как это происходит и как что себя ведет, вот что не понятно. (edited)


Gekov Iliya [8 days ago]
Это стоит обратиться к материалу, прилагающемуся к HW0, про стримы и функциональные интерфейсы, там про это куча информации


KaryNaiKo [8 days ago]
@Gekov Iliya обращался. Не понятно конкретно в этом случае как параметр Id попадает в новый meal. Почему не так
(Id, oldMeal) -> {oldMeal.setId(id); return oldMeal}
Ну то есть где команда присвоить старому значение meak новое Id?


Yuri [8 days ago]
новый id не надо присваиваеть, так как этот объект уже есть в базе.
`repository.computeIfPresent(meal.getId(), (id, oldMeal) -> meal);`  это типо безопасное сохранение измененной сущности Meal под тем же id что и было. Безопасно потому что мы не сможем обмануть систему и подделать вызов с Meal и новым ID которого еще нет в базе. (edited)


Victor_Ch [8 days ago]
прочитай про лямбды и анонимные классы, и все станет на места. (edited)


KaryNaiKo [Oct 11th at 10:07 PM]
Правильно ли я понимаю принцип работы этой строки "<h2>${param.action == 'create' ? 'Create meal' : 'Edit meal'}</h2>" в mealForm?
Допустим мы находимся на страничке meals в браузере, нажимаем кнопку Update, в запросе к серверу будет отправлен параметр action=update, mealServlet отработает и отправит на mealForm с этим параметром, где уже мы его берем из param.action и смотрим какую надпись вывести?


3 replies
Sergey Zhukov [8 days ago]
тернарный оператор, это тот параметр action, который мы положили в сервлете в response (edited)


Sergey Zhukov [8 days ago]
домашку сделал? зачем обсуждать в канале по второй домашке первую? (edited)


KaryNaiKo [8 days ago]
@Sergey Zhukov делал, но без param.action


Maxim Valeev [Oct 12th at 12:58 PM]
Всем привет. Нашел короткую, но удачную статью для тех кто немного запутался (как я например) https://habr.com/post/321344/
Хабр
Инверсии зависимостей управления впрыском
Вступление Наверняка первый вопрос, который возник у вас при взгляде на заголовок, был "Шта?". На самом деле я просто перевел фразу "Инверсия управления,... (388 kB)
(edited)


4 replies
Igor [7 days ago]
Прочитал. Мне не помогло :rolling_on_the_floor_laughing:



Maxim Valeev [7 days ago]
@Igor не повезло)))


JavaHolic [7 days ago]
На мой взгляд очень хорошо всего эти механизмы описаны в третьем издании Spring в действии, а в статье по ссылке, как по мне, не очень разжевано.. (edited)


Maxim Valeev [7 days ago]
@JavaHolic Спасибо, посмотрю обязательно


Pushkin [1:30 PM]
В видео про Guava новая вводная. https://stackoverflow.com/a/44218055/4711212
Stack Overflow
Why spring deprecate guava cache in official document
I want to use spring-cache with guava cache, but I find guava cache has been marked deprecated by spring official document.I wonder to know why, they didn't give some explanations. https://docs.sp...

regorov [2:47 PM]
Правильно получается, что свойство объекта со значением null на jsp записывается как пустая строка?


Dima [Oct 12th at 4:19 PM]
@Grigory Kislin есть вопрос. В задании указано, что фильтрацию делать в репозитории, конвертацию - в сервисе или вебе. Отсюда вопрос: если лист приходит в конвертацию уже обрезанный, как адекватно расчитать поле exceed?


5 replies
Maksim K [7 days ago]
2.4: Фильтрацию по датам сделать в репозитории т.к. из базы будем брать сразу отфильтрованные по дням записи. Следите чтобы первый и последний день не были обрезаны, иначе сумма калорий будет неверная.


Maksim K [7 days ago]
В подсказках по домшке это написано.



Dima [7 days ago]
Если делать фильтрацию и конвертацию в MealWithExceed в репозитории, то проблем нет, так как сумму калорий за день вычислить можно перед фильтрацией. Если отфильтрованный List<Meal> приходит в контроллер или сервис, и там конвертируется в List<MealWithExceed>, то уже потеряно общее число калорий за день


vch [7 days ago]
@Dima Фильтраций 2 штуки - по дате и по времени. Их же можно разнести по разным частям приложения. Тогда проблема исчезнет.


Dima [7 days ago]
@vch это сработало, спасибо


Стецко Максим [Oct 13th at 1:22 PM]
это нормально, что из видео 2 урока я примерно понял только 10%???



16 replies
Mojeico [6 days ago]
f


Mojeico [6 days ago]
До этого проекта я немного подучил Spring


Mojeico [6 days ago]
https://www.youtube.com/playlist?list=PL6jg6AGdCNaWF-sUH2QDudBRXo54zuN1t
YouTube
Spring Framework - The Basics - YouTube
Курс знакомит с базовыми концепциями Spring Framework и его основными модулями: Core, AOP, JDBC. С помощью практических примеров объясняется внедрение зависи...
 


Mojeico [6 days ago]
Посмотри ссылку. Этот парень мне все объяснил, до этого не мог разобраться 2 дня

Gekov Iliya [6 days ago]
Мне помогла книга Pro Spring, прочитал перед стажировкой


Mojeico [6 days ago]
Spring_3_dlia_professionalov_2013
я начал читал такую. Ее нужно читать, когда ты хоть понимаешь хоть что-то.



Mojeico [6 days ago]
можешь кинуть ссылочу

Sergey Zhukov [6 days ago]
до проекта еще spring потрогали многие в тестовом задании


Sergey Zhukov [6 days ago]
@Mojeico эта книга действительно для тех кто уже немного разобрался в Спринге, но хочет досканально... Лучше для начала "Spring in action"  она легче читается


Gekov Iliya [6 days ago]
Это она и есть) я правда читал издание 2015го


Mojeico [6 days ago]
Как по мне там очень навалено. Лучше базу объяснять как тупому, разжевывая и тд


Gekov Iliya [6 days ago]
Думаю если видео Григория вызывают серьезные трудности в понимании нужно углубиться в теорию по спрингу, почитать побольше, посмотреть примеры crud, в инете их полно. Иначе, как мне кажется, стажировка может мало пользы принести


Mojeico [6 days ago]
Мне понимание основ принесла ссылка выше


Dima [6 days ago]
по спрингу на udemy хорошие курсы. Только англ яз надо знать


Victor_Ch [6 days ago]
рекомендую вот эту:
Soni R.K., Ganeshan A., Rajesh RV - Spring Developing Java Applications for the Enterprise - 2017 (торренты) (edited)


Grigory Kislin [6 days ago]
я рекомендую прояснить, что непонятно и вопросы задавать..


Mojeico [1:38 PM]
Для тех у кого возникли проблемы с Спрингом. Просмотрите это и все пойметею (edited)


Mojeico Oct 13th at 1:38 PM
https://www.youtube.com/playlist?list=PL6jg6AGdCNaWF-sUH2QDudBRXo54zuN1t

Merkulov 6 days ago
Евгения Борисов - Spring-потрошитель в двух частях

Victor_Ch 6 days ago
эти видео тоже для понимающих...
рекомендую вот эту:
Soni R.K., Ganeshan A., Rajesh RV - Spring Developing Java Applications for the Enterprise - 2017


Timur_Gainitdinov [Oct 13th at 6:33 PM]
В задании говорится об авторизированном пользователе, а не авторизированный чем отличается?
он вроде видит только главное меню, не может совершать каких-то действий...
он по сути не пользователь, почему тогда акцент на авторизации?=)


1 reply
Grigory Kislin [6 days ago]
привет. вопрос не понял... в демо можно посмотреть- в приложение только авторизированных юзер заходит


fonto [Oct 13th at 8:17 PM]
Можно ли вынести из обоих репозиториев мапу в отдельный синглтон класс и ключем использовать юзера(Map<User, Map<Integer, Meal>> ), ведь если оставить разные мапы в репозиториях, то при удалении пользователя все его трапезы будут оставаться в мапе MealRepository, а это не есть хорошо (edited)


46 replies
fonto [6 days ago]
Или по этому поводу можно пока не заморачиваться?


Ansseii [6 days ago]
Как я понял из задания, то мы и так знаем id пользователя из SecurityUtil и общая мапа для всей еды будет как раз Map<Integer, Map<Integer, Meal>>. При удалении юзера можно лезть в эту мапу и тереть ключ с совпадающим id. Я не прав?


Ansseii [6 days ago]
У меня отсюда возникает вопрос вот по этому пункту только:
3.2: если по запрошенному id еда отсутствует или чужая, возвращать null/false (см. комментарии в UserRepository)
При такой реализации ведь этого не произойдет.


Maksim [6 days ago]
А разве правильно если UserRepository будет работать с Meal? Удалить юзера одна операция, удалить еду юзера другая.


fonto [6 days ago]
Если делать мапу как ты написал, она подходит лишь для MealRepository, а для сохранения пользователя надо создавать отдельную мапу в UserRepository. Но тогда при удалении пользователя, чтобы вместе с ним удалить его данные, надо будет лезть в мапу которая находится в MealRepo


fonto [6 days ago]
Ну дак они и будут отдельно работать если, вынести мапу в другой класс(И допустим назвать memory)


fonto [6 days ago]
Через милрепо по активированому юзеру работать с его едой, а через юзеррепо уже с юзерами. И тогда если удалить юзера, все его данные тоже удаляться


Maksim [6 days ago]
А как в этой мапе будет храниться инфо о пользователе?


Maksim [6 days ago]
Хотя понял, а поиск по id как? Перебором?


Ansseii [6 days ago]
Выходит так. Мы же видим userId из SecurityUtil


Ansseii [6 days ago]
И его предстоит сравнивать со полем id каждого пользователя


Maksim [6 days ago]
И перебираем по порядку например миллион.


fonto [6 days ago]
А что вам мешает в SecurutyUtil пользователя возвращать?;)

Ansseii [6 days ago]
Когда пользователь авторизуется в приложении, его id и норма калорий “чудесным образом” попадают в SecurityUtil.authUserId()/authUserCaloriesPerDay() и в приложении мы может обращаемся к ним.


Ansseii [6 days ago]
Не думаю, что это уточнение Григория стоит не учитывать


Maksim [6 days ago]
В таком случае SecurityUtil должен работать с вышеуказанной мапой.


Ansseii [6 days ago]
В любом случае общее хранилище будет выглядеть как граф, но я пожалуй оставлю ключом все таки уникальный ID пользователя.
Забавно, но по демо приложению вообще непонятно девается ли вообще куда то еда пользователя при удалении его самого. Админ не видит всего списка. Тоже только свой. (edited)


Maksim [6 days ago]
Хранение в любом случае DB там же не зря таблицы придумали. А так это не важно, как сундук, нет ключа и не узнаешь пуст он или нет.


Ansseii [6 days ago]
А вот моя реализация тоже не правильная. Следом в пункте 4 идет условие:
4.2: SecurityUtil может использоваться только на слое web (см. реализацию ProfileRestController).
Итого мы не можем им пользоваться. Придется переделывать через добавление userID в Meal


Maksim [6 days ago]
3.1: реализовать хранение еды для каждого пользователя можно с добавлением поля userId в Meal ИЛИ без него (как нравится). Напомню, что репозиторий один и приложение может работать одновременно с многими пользователями.


Maksim [6 days ago]
Или не зря выделено. Наверное

fonto [6 days ago]
Из дБ при удалении пользователя удаляется и еда за счёт связей между таблицами

fonto [6 days ago]
Там все просто

Maksim [6 days ago]
А как связи осуществляются?

fonto [6 days ago]
OnetoOne, ManytoOne и т.д.

fonto [6 days ago]
По сущности

Maksim [6 days ago]
По id Разные таблицы, значит и мапы разные (edited)


fonto [6 days ago]
Ну есть у тебя Map<Int, User> и Map<Int, Meal>


fonto [6 days ago]
Проведи связь)

Maksim [6 days ago]
Какую именно?


Dima [6 days ago]
Там будет связь один юзер ко многой еде



fonto [6 days ago]
Угу


Maksim [6 days ago]
Удалил юзера, потом ЕСЛИ НАДО удалил еду по id а не надо оставил пусть хранится никому не мешает


Maksim [6 days ago]
А может даже пригодится


fonto [6 days ago]
Ладно спорить не будем), подождем ответ Григория мне интересно, что он скажет)

fonto [6 days ago]
А связь там да будет один ко многим

Maksim [6 days ago]
А мы и не спорим мы все вместе думаем. Очень даже интересно.

fonto [6 days ago]
А по поводу того, что инфа о пользователе никому не мешает)). Приведу пример, есть допустим соц сеть ВКонтакте, у пользователя может быть не одна тысяча фотографий, видео и т.д. Он удалился, а вся эта инфа осталась на сервере)


Maksim [6 days ago]
И что...?

fonto [6 days ago]
И я понимаю, что дальше мы будем работать с базой и эти мапы на будут не нужны)), поэтому я и задал вопрос "Стоит ли вообще заморачиваться по этому поводу"

Maksim [6 days ago]
Наверное не стоит, хотя вариант интересный, но он не гибкий, как мне кажется.


Maksim [6 days ago]
Хотя можно и попробовать, негативный опыт тоже опыт. Мы же здесь для этого.


Maksim [6 days ago]
Хотя мапы при мокировании нужны все таки, вроде как....


Taras [6 days ago]
По-моему, задание боевое, помогает немного прояснить для себя, как оно «под капотом» базы данных, связи OneToMany, каскадные удаления и т.п.. По поводу ВК и прочих — насколько я знаю, там удаления записей не происходит, это, как ни странно, очень дорого. Ставят флажок «юзер удален», и, по возможности, потом «чистят» базу.

Grigory Kislin [6 days ago]
вопрос интересный, спасибо! пока с этим не заморачивался...
если бы не было базы- сделал бы метод в интерфейсе- удалить все для юзера и добавил бы репозиторий еды в юзер репозиторий. но для базы будет каскадное удаление, те метод будет не нужен...


Thaipad [6 days ago]
Я добавил к Meal userId и при обращении к мапе фильтрую по этому полю. Значение для фильтрации передаю параметром с уровня контроллера. Если проецировать на базу,  то userId - вторичный ключ в таблице Meal со ссылкой на первичный ключ таблицы User. Впрочем, когда будет база, а не мапа, в класс Meal можно будет не добавлять это поле - оно нужно только для мапы.


Vitaliy Ivkin Oct 13th at 8:53 PM
В первом пункте ДЗ - нужно ли хардкодить список юзеров и если да, то какой конструктор использовать? В Мил-классе у нас был взять захардкоденный в милсУтил список, а как быть здесь? (edited)

Ansseii 6 days ago
Я создал отдельный утильный класс и захардкодил

Vitaliy Ivkin 6 days ago
@Ansseii а какой конструктор использовать?

Ansseii 6 days ago
Я брал тот что без id и выставлял его через метод save в имплементации

Grigory Kislin 6 days ago
можно не делать. ни UI, ни тестов же пока нет (edited)


Stepan [Oct 13th at 9:01 PM]
Принадлежность еды к пользователю определять в слое сервиса или в репо?


1 reply
Grigory Kislin [6 days ago]
лучше в репо


Vitaliy Ivkin [Oct 13th at 10:10 PM]
В методе getAll в требование фиксированного порядка в случае одинаковых имён - как можно сделать вторичную сортировку (например, по id) в стриме после сортировки по именам?


11 replies
Maksim [6 days ago]
Comparator методы (edited)



Vitaliy Ivkin [6 days ago]
Сообразил через thenComparing, спасибо



Dima [6 days ago]
list.stream()                .sorted(Comparator.comparing(Userr::getName)                        .thenComparing(Userr::getId))
               .collect(Collectors.toList()); (edited)


Dima [6 days ago]
мде, как тут код нормально вставлять?


Vitaliy Ivkin [6 days ago]
да, затем собрать в лист. у меня так же


Vitaliy Ivkin [6 days ago]
а тут можно код нормально вставлять?!


Dima [6 days ago]
не знаю,вот и спрашиваю


Dima [6 days ago]
ctrl+shift+enter


Grigory Kislin [6 days ago]
я делаю с  ``` в начале и в конце


Grigory Kislin [6 days ago]
```код```


Dima [6 days ago]
```Это легче, но номера строк не показывает```
(edited)


Taras [Oct 13th at 11:21 PM]
Судя по сигнатуре `User getByEmail(String email);` у нас поле `email` — уникальное. Значит ли это, что при попытке записи в базу пользователя с дупликатом `email` надо бросать какой-то exception? Если нет, то какого пользователя в случае дубликата `email` выводить? Первого попавшегося?


4 replies
Dima [6 days ago]
база сама может кидать SQLException если сделать поле уникальным. Можно перехватывать и использовать


Taras [6 days ago]
Это понятно, но мы пока до базы не дошли, речь о текущем задании.


fonto [6 days ago]
В этом вся и суть моего вопроса выше)), стоит ли со всем с этим сейчас заморачиваться или нет. И почему мы сразу не начали работу с базой


Grigory Kislin [6 days ago]
вначале пробуем с памятью. проверку не делал, вывожу по get первого попавшегося. можете сделать


Maxim Valeev [Oct 14th at 6:43 AM]
Что-то я совсем запутался. Как на данном этапе должна работать авторизация? Она вообще есть?Или у меня по дефолту пользователь с id=1? Сейчас должна быть реализация входа под админом? Где и как должен проверяться вход? Может я пропустил где это объяснялось? сложнаа (edited)


6 replies
Tanya [5 days ago]
прочитай внимательно все задание
8: добавить выбор текущего залогиненного пользователя (имитация авторизации, *сделать Select с двумя элементами со значениями 1 и 2 в index.html и SecurityUtil.setAuthUserId(userId) в UserServlet* ). Настоящая авторизация будет через Spring Security позже.

пока это не сделано, авторизации вообще нет, userId 1



Maxim Valeev [5 days ago]
То есть значение 2 не должно работать т.к. у нас валидный только 1?


Tanya [5 days ago]
для base HW  - да (edited)


Maxim Valeev [5 days ago]
Спасибо, попробую разобраться)


Maxim Valeev [5 days ago]
А где должна обрабатываться авторизация? Я выбираю пользователя, отправляю пост запрос на юзерсервлет, там через профайлконтроллер чекаю тот юзер или нет и если тот, кидаю на еду, правильно?


Sergey Zhukov [5 days ago]
я также понял, хардкодим пару пользователей в репозитории и обычным select и post запросом меняем текущего юзера, вот только я не понял, сессию учитывать? тогда придется держать мапу "сессия-юзер"


Sergii [Oct 14th at 2:08 PM]
Запутался, как и многие, как-то непоследовательно у нас все ... Григорий , а не логичней сначала добить авторизацию, а потом трогать еду ? А то проект потихоньку превращается в монстра с кучей заглушек и "временных" решений ... (edited)


6 replies
Gekov Iliya [5 days ago]
Одна единственная заглушка и одно единственное временное решение,где куча то? Насколько я понимаю, сразу реализовать авторизацию на данном этапе не получится, так как она будет реализована через спринг секьюрити, а у нас еще даже спринг mvc не реализован
Как по мне так все последовательно и вполне логично, с учетом того, что этот проект учебный (edited)


Sergii [5 days ago]
Уфф, чувствую, нужно откатиться к началу и полностью пересмотреть весь код)

Dima [5 days ago]
Так если приходить на работу, там полюбому уже проект сделан, и там придется вообще разбираться в уже созданном а не как мы тут по шагам. Думаю это неплохая тренировка



Taras [5 days ago]
Ребята, авторизацию «навешивают» потом. И не обязательно её делают на spring security, даже в случае использования spring mvc. Поэтому всё правильно, — мы идём с самого начала, чтоб пройти все этапы «взросления». :)


Sergey Zhukov [5 days ago]
да вроде нормально все, на то он и назвал это каркасом, не все еще готово, но уже вырисовываются очертания


Ilya [4 days ago]
Кто хочет может сделать авторизацию через фильтры) в них по атрибутам находим пользователя и добавляем его в сессию и считаем что он авторизован


Vitaliy Ivkin [Oct 14th at 4:04 PM]
В задании указано, что реализацию можно осуществить с добавлением айди юзера в мил ИЛИ без него. Если добавлять, то слишком уж много приходится перелопачивать, начиная от конструкторов мил, куда надо вводить новую переменную, до списков еды и милсервлета. Хотя может я делаю что-то не так и можно было сделать как-то проще? Или же как-то можно реализовать без втыкания this.userId = userId;?


46 replies
Ansseii [5 days ago]
Я обошелся без добавления доп поля и использовал
```Map<Integer, Map<Integer, Meal>> repository;```
(edited)


Dima [5 days ago]
Я использовал userId, и инициализировал его автоматом при создании еды внутри конструктора.


Vitaliy Ivkin [5 days ago]
@Ansseii у меня получилось через

Vitaliy Ivkin [5 days ago]
Map<Integer, List<Meal>> repository


Vitaliy Ivkin [5 days ago]
@Dima инициализация без изменения параметров конструктора мне видится только через this.userId = SecurityUtil.authUserId();


Vitaliy Ivkin [5 days ago]
Или так и надо было с самого начала?


Dima [5 days ago]
я так и сделал


Ansseii [5 days ago]
SecurityUtil можно юзать только в слое контроллера


Ansseii [5 days ago]
@Vitaliy Ivkin
А по поводу листа - ты поиск конкретной еды будешь делать перебором индекса?


Dima [5 days ago]
эту фраза из задания никак не сходится с фразой, что можно использовать userId в Meal, если учесть что получить userId можно только из утильного класса


Gekov Iliya [5 days ago]
Если я правильно понял, в слое сервиса и репозитория userid можно хардкорить, а не брать из секьюрити утил, про это тоже в задании написано


Gekov Iliya [5 days ago]
А в слое веба брать из утила

Ansseii [5 days ago]
@Dima
Я осознал адекватное для себя решение только после того как сначала нарисовал все слои еды и пошел от контроллера вниз.
Делаешь авторизацию в контроллере через SecurityUtil, а ниже ты просто делегируешь в методы, где одним из параметров как раз будет userId.


Gekov Iliya [5 days ago]
4.2: SecurityUtil может использоваться только на слое web (см. реализацию ProfileRestController). MealService можно тестировать без подмены логики авторизации, принимаем в методах сервиса и репозитория параметр userId: id владельца еды.

Gekov Iliya [5 days ago]
@Ansseii Да, я тоже так это понял (edited)

Vitaliy Ivkin [5 days ago]
@Ansseii реализовал через цикл for, но у меня были серьезные сомнения - использовать лист или мэп внутри мэп. В чем плюсы реализации через мэп с айди еды?


Ansseii [5 days ago]
@Vitaliy Ivkin
Как раз в том что тебе не нужен цикл. Ты дергаешь из мапы по ключу, что быстрее перебора коллекции.
С мапой очень удобно работать через Java8 методы
```computeIfAbsent()
computeIfPresent()```
(edited)

Dima [5 days ago]
@Ansseii у меня тоже в каждом методе userId, только в методе save я достаю его прям из Meal, именно потому что оно вшивается туда во время создания еды


Vitaliy Ivkin [5 days ago]
@Ansseii интересно, мне нравится такой способ) а как решил вопрос с userId в мил? Сейчас было очень дельное предложение просто захардкодить его пока что

Dima [5 days ago]
Если делать через мапу в мапе, то userId уже не надо пихать в еду. Как выше сказали, он просто подмешивается в метод контроллера.


Vitaliy Ivkin [5 days ago]
Сейчас уже немного перестал понимать - если мы делаем через мапу, то откуда вообще тогда берём для неё в милрепо айди?


Vitaliy Ivkin [5 days ago]
если не добавляем его в мил


Dima [5 days ago]
это id будет тянуться по цепочке из контроллера


Vitaliy Ivkin [5 days ago]
попробую разобраться, спасибо

Nikita Ganin [5 days ago]
Я правильно понимаю, что все описанное в данной ветке должно быть реализовано в repo и repoImpl?


Sergii [5 days ago]
А вариант Map<Integer, Map<Integer,Meal>> не избыточен ? Первый Integer - это userId, а зачем второй ? Такой вот вариант не проще :


Sergii [5 days ago]
Map<Integer, List<Meal>> ... или я таки что-то недопонял ...


Sergii [5 days ago]
У нас же Id еды теперь в самой еде


Dima [5 days ago]
первый int  - пользователь, второй - номер еды

Sergii [5 days ago]
вот об этом и говорю

Sergii [5 days ago]
с пользователями- та же петрушка - у юзера есть id, в репозитории, где он сохраняется - тоже есть id , зачем ?

Sergii [5 days ago]
Не могу понять , зачем нам мапы вместо листов

Maksim [5 days ago]
Скорость выборки Map самая максимальная.

Sergii [5 days ago]
Разве это повод дублить айдишники ?


Sergii [5 days ago]
оправдано ?


Sergii [5 days ago]
вероятно, одна из причин кроется тут : https://ru.stackoverflow.com/questions/493508/%D0%9F%D0%BE%D1%87%D0%B5%D0%BC%D1%83-%D0%BD%D0%B5%D1%82-concurrentlistt
Stack Overflow на русском
Почему нет ConcurrentList?
В .NET есть такая структура как потокобезопасный словарь ConcurrentDictionary. А вот потокобезопасного списка почему-то нет? Может кто-то знает почему? Заранее спасибо
 


Maksim [5 days ago]
Это же id разных сущностей, чем смущает?

Sergii [5 days ago]
не совсем понятно, зачем нам id в еде, например, если при занесении еды в репозиторий она и так получит id в виде ключа репо

Maksim [5 days ago]
Update?

Maksim [5 days ago]
Насколько я понимаю List имеет смысл только при заведомо упорядоченных значениях. Здесь же этого не требуется. (edited)

Sergii [5 days ago]
с выборкой еды (get, delete ...) в конструкции Map<Integer, Map<Integer,Meal>> тоже такойсебевариант получается ...


Maksim [5 days ago]
O(1) + O(1)= O(1) насколько я понимаю.


Sergey Zhukov [5 days ago]
@Sergii я думаю народ упрощает возможную реализацию, но не думает о реальной базе, в которой плоская таблица уже не сможет разложится в такую удобную мапу (по сути каждому пользователю нужно будет создавать отдельную таблицу в базе), и придется все равно пихать пользователя в еду и делать над полем аннотацию @ManyToOne в таблицу пользователей.


Sergii [4 days ago]
Сергей, я думаю давно есть механизм, позволяющий "расскладывать" подобные вещи в плоские таблицы, ведь по сути тут просто ключ по двум полям


Sergey Zhukov [4 days ago]
такие мапы лучше хранить в какой-нибудь MongoDB или ей подобной.

Sergii [4 days ago]
монго тут не нужен - у нас все строготипизировано


KaryNaiKo [9:27 PM]
Почему в UserServiceImpl в методе update мы проверяем на отсутствие в БД но не пробрасываем исключение NotFoundException как в остальных методах и не обрабатываем?


Alexey_b [Oct 14th at 11:12 PM]
Вопрос по поводу пункта: getByEmail попробуйте сделать через stream. Я сделал через ....findAny().orElse(null);   Как в таком случае записать в лог 2 разных события, успешное и неуспешное?


8 replies
Dima [5 days ago]
что то типо
```log.info("getByEmail {}", user!=null ? user : 'чтото');```


Yuri [5 days ago]
Можно логировать только неудачи через orElseGet(). Либо Optional.isPresent() проверять в if-else (edited)


Alexey_b [5 days ago]
получается в итоге столько же кода как если бы изначально сделать не черерз стрим, а через if else


Yuri [5 days ago]
Зачем, в данной ситуации записывать успешное событие, еще и пользователя в логи выводить? Мне кажется более верно логировать ключевые места работы приложения и ошибки/нештатные ситуации с данными для возможности воспроизвести или проверить.


Sergey Zhukov [5 days ago]
а я смотрю в Meal нет лога и тут похерил его по аналогии :grin:


Alexey_b [4 days ago]
@Yuri у нас приложение учебное, мы тут проблемы выдумываем, потом решаем. Если смущает для чего тут логировать, можно представить, что пришел тикет с прода, пользователи утверждают, что эта функция криво работает, а у нас только логи :sunglasses:. В целом я хотел подискутировать на тему целесообразности тут красивых стримов, и олд скульных if else


Yuri [4 days ago]
@Alexey_b имхо для такого тикета вполне достаточно будет лога о начале поиска + email и лога о ошибке, если она была. Я использую стрим когда он получается лаконичнее и нагляднее цикла. Обычно когда в стриме надо открывать {}, то либо что-то не так с логикой либо цикл будет лучше, но опять же это зависит от ситуации. BTW Сейчас все больше реактивщины и асинхронщины в проектах, а это все на концепции стримов построено. Optional тоже красиво заходит со стримами.


Yuri [4 days ago]
На скорую руку, может можно и проще сделать, но:
Цикл
```User user = null;
for (User u : repository.values()) {
    if (u.getEmail().equalsIgnoreCase(email)) {
        user = u;
        break;
    }
}

if (Objects.nonNull(user)) {
    log.info("Success");
} else {
    log.info("Error");
}
return user;```


Стрим
```return repository.values().stream()
        .filter(user -> user.getEmail().equalsIgnoreCase(email))
        .findFirst()
        .orElseGet(() -> {
            log.info("Couldn't find a user");
            return null;
        });```
Имхо стрим выигрывает (edited)


creilyss [Oct 15th at 1:19 AM]
кто победил этот момент ? подскажите куда копать, инициализация в статическом блоке у меня проходит, и бины подгружает, а потом в сервлете везде NPE, как будто никаких autowired не было.
Untitled
 в MealServlet сделать инициализацию Spring



3 replies
YuriyUh [4 days ago]
Не нужен статичный блок, инициализируй  в методе init() сервлета, начинай с контроллера.


Maxim [4 days ago]
Каким образом загружается контекст? так же как и в SpringMain?


YuriyUh [3 days ago]
Да, сначала инициализируешь контекст, а затем загружаешь туды контроллер чз getBean(name_class)


Maxim Valeev [Oct 15th at 2:46 AM]
добавил userId в Meal. Проверку на принадлежность еды к юзеру делать на слое Service? нельзя же спускать логику до рипозитория, он же не должен знать вообще об этом?


5 replies
Tanya [5 days ago]
а как это репозиторий не знает кому принадлжит еда?


Maxim Valeev [5 days ago]
Репозиторий знает кому принадлежит. Логику проверки в него помещать корректно?


Tanya [5 days ago]
ну допустим поместили проверку на принадлежность еды юзеру в сервисе
напиши как будет происходить например удаление


Maxim Valeev [5 days ago]
Вот я этого не могу сделать, как раз с удалением и споткнулся) думал всю логику надо на сервис вешать


Tanya [5 days ago]
в сервисе проверка результата, см как в юзере


Marat [Oct 15th at 8:02 AM]
Привет всем. Не могу понять почему в InMemoryUserRepositoryImpl метод
public boolean delete(int id) {
       log.info("delete {}", id);
       return true;
   }
возвращает boolean ?


2 replies
Andrew Kalugin [4 days ago]
см.видео - "обычно delite возвращает void, но мы будем делать нестандартно" - упоминали об этом. При такой реализации проще проверять на ошибки - посмотри service для user.


fonto [4 days ago]
Ну типо есть такой еды не было метод отправляет фолс и при валидации просто отправляем, что типо такой еды нет. А если есть, то просто удаляет и отправляет тру


Maxim Valeev [Oct 15th at 10:31 AM]
NotFoundException мы наследовали от RuntimeException. Нам надо в сервисе или контроллере обрабатывать исключения, когда пользователь пытается взаимодействовать с чужой едой? (edited)


1 reply
Yuri [4 days ago]
Исходя из :
```4.3: если еда не принадлежит авторизированному пользователю или отсутствует, в MealServiceImpl бросать NotFoundException.```
Обрабатывать в контроллере (edited)


Marat [Oct 15th at 12:18 PM]
Запутался с этим заданием. Сделал слои приложения для еды по аналогии с пользователем до контроллера. Дальше не пойму как что сделать


6 replies
Zhinko [4 days ago]
что именно не понял?


Marat [4 days ago]
Как только свою еду смотреть


Marat [4 days ago]
Все логику для этого в контроллете/сервелете делать?


Zhinko [4 days ago]
ну я передавал в репоризиторий id пользователя. И там сохранял  с учетом Id пользователя


Zhinko [4 days ago]
В репозитории где хранится еде у меня Map в которой ключ id пользователя а значение другая Map в которой хранится еда


Sergey Zhukov [4 days ago]
@Marat "Как только свою еду смотреть". В контрллере по аналогии с user делаешь getAll и передаешь в него id пользователя(я еще на всякий случай передал калории за день), в сервисе такой же метод, он получает сущности из базы по id пользователя и преобразует в DTO MealWithExceed (edited)


roma [Oct 15th at 9:43 PM]
Нрод вопрос скорее по предыдущему уроку, даже 2 вопроса 1) я в убунту добавил переменную TOPJAVA_ROOT в в bash.bashrc, но у меня не появляется каталог log в папке проекта и 2й вопрос как в убунту запустить томкат из терминала


7 replies
Yuri [4 days ago]
https://topjava15.slack.com/archives/CCPHF8VBN/p1539012788000100
Yuri Heiko
Проблема с логированием под Ubuntu - в упор нехочет видеть переменную окружения TOPJAVA_ROOT. Если в logback.xml указать путь явно, то все работает. Хотя переменная есть в окружении, перезагрузка IDEA и компа не помогает
Thread in #hw1Oct 8th at 6:33 PM


roma [4 days ago]
ага - все перезагружал


Alexey_b [4 days ago]
по поводу второго,  всё должно быть аналогично виндовсу. В папке  томката bin запустить ./catalina.sh start


Yuri [4 days ago]
@roma Мне на ноуте помогло добавление в /etc/profile.d/jdk.sh строки с экспортом переменой. На рабочей машине так и не победил (


roma [4 days ago]
понял - что обойдусь на ноуте без этой папки ))) - хотя помоему переменная будет еще юзаться дальше (((.... томкат запустил из терминала - спасибо боьшое (edited)


shomnest [3 days ago]
@roma как переменную устанавливал?


YuriyUh [3 days ago]
Так же стартовать TomCat можно из терминала(в любом месте) systemctl start tomcat, остановить чз stop


roma [Oct 15th at 10:22 PM]
И еще вопрос - не знаю почему но на винде и под хромом все работает нормально - а под убунтой и мозилой у меня время минуты сохраняет только равными 10 (тоесть сколько бы я не вводил минут 1, 30 , 45 - сохранится всегда 10) - при этом дату и часы сохраняет правильно (edited)


1 reply
Grigory Kislin [4 days ago]
посмотри вкладку Network в браузере


Alexey_b [Oct 15th at 10:31 PM]
Вопрос по пункту 4.4: конвертацию в MealWithExceeded можно делать как в слое web, так и в service.  Если делать в service, соответсвенно надо менять тип возвращаемого значения MealWithExceed get(int id)  ?   Или надо сделать 2 метода которые возвращают и обычную еду и DTO ?


2 replies
Grigory Kislin [4 days ago]
сделай, как видишь правильным. 2 не нужно (edited)


Alexey_b [4 days ago]
а, вижу в подсказках к дз. Немного не логично, предполагается что их нужно читать когда уже сделал задание. И кстати вижу ремарку  Сделайте отдельный getAll без применения фильтра, соответсвенно в некоторых случаях нужно 2


roma [10:33 PM]
уж точно не 2 метода - иначе зачем нам вообще dto


Andrew Kalugin [Oct 15th at 10:53 PM]
Что-то я не врублюсь, как безболезненно для проекта пункт 8 сделать. Каким образом SecurityUtil.setAuthUserId(userId) в UserServlet изменит id пользователя, если все проверки на SecurityUtil.authUserId() завязаны?


2 replies
ABaykov [4 days ago]
Полагаю, что нужно ввести отдельное поле authUserId. И вместо метода authUserId(), который стабильно возвращает 1, подсовывать getAuthUserId() (edited)



Grigory Kislin [3 days ago]
сделать статический член класса


under4eg [Oct 15th at 10:57 PM]
Вот и моя очередь не понимать на публику :slightly_smiling_face: "Отдать свою еду (для отображения в таблице, формат List<MealWithExceed>), запрос БЕЗ параметров" - как же уточнить тогда, еду какого пользователя нужно вытянуть из репо, если метод без параметров и следовательно айди не пробросить? (edited)


6 replies
Gekov Iliya [4 days ago]
Через секьюрити утил


Gekov Iliya [4 days ago]
Пробрасывайте айди из заглушки для секьюрити утил


ABaykov [4 days ago]
подразумевается, что как только пользователь залогинился в системе, система сама знает какой у пользователя id.



Sergey Zhukov [4 days ago]
@under4eg в репозитории все методы принимают параметр userId


under4eg [4 days ago]
Разговор и вопрос не шел про репозиторий, подозрения про заглушку озвучили люди выше, спасибо.


Tanya [4 days ago]
еду того юзера чей id на момент запроса находится в SecurityUtil.authUserId()


Sergey Zhukov [Oct 16th at 12:09 AM]
по Optional 6.1. "...вся логика должна быть в контроллере",  а что остается в сервлете? где action из request разруливать?


1 reply
Tanya [4 days ago]
action из request разруливаешь в сервлете


Marat [Oct 16th at 11:55 AM]
Как тестировать пункт 5: включить классы еды в контекст Spring (добавить аннотации) и вызвать из SpringMain любой метод MealRestController (проверить что Spring все корректно заинжектил)  ?
Bean definition names: [inMemoryMealRepositoryImpl, inMemoryUserRepositoryImpl,
............................................................... .
mealServiceImpl, userServiceImpl, mealRestController, adminRestController, profileRestController]
................................................................
INFO  MealRestController [MealRestController.java:23] create Meal{id=null, dateTime=2015-05-30T10:00, description='Завтрак', calories=500}


4 replies
YuriyUh [3 days ago]
Ну допустим вытаскиваешь из контекста бин контроллера и вызываешь у него метод getAll() и смотришь, что действительно все заинжектено и из репозитория приходит ответ, как то так.


Marat [3 days ago]
Сделал по аналогии с юзером, но список еды не возвращает когда main запускаю


Grigory Kislin [3 days ago]
@Marat ищи, в чем проблема (edited)


Gekov Iliya [3 days ago]
@Marat расставь точки дебага на всех соответствующих методах в контроллере, сервисе, репозитории, посмотри вызываются ли они вообще и если вызываются, то что возвращают (edited)


YuriyUh [Oct 16th at 1:50 PM]
Что то я не пойму никак, зачем проверять "изменить иль удалить чужую(не авторизованного пользователя) еду", еже ли на страницу выводятся только данные авторизованного пользователя?


5 replies
ABaykov [3 days ago]
Через консольное приложение пользователь авторизованный может поменять id еды в запросе на чужой
И баба Клава которая следит за своим весом ужаснётся, когда в следующий раз в приложении увидит, что уже неделю превышает норму калорий на 3000 в день (edited)


Dmitriy [3 days ago]
postman fiddler позволяют модифицировать http/https запросы(например, изменить id еды в запросе), если не будет проверки - потенциальная уязвимость.


YuriyUh [3 days ago]
Жалко бабу Клаву :grin:, над проверить дабы не случилось такое недоразумение.


Grigory Kislin [3 days ago]
а уж get запрос прямо в браузере можно поменять на любой


fonto [3 days ago]
Гет запросы да прямо в браузере), поэтому я делал все эти действия пост запросом


Sergey Zhukov [Oct 16th at 4:40 PM]
Залип на 7 пункте Optional, думаю как упростить условие передачи параметров из сервлета (две даты и два времени) в метод контроллера, написать небольшой вспомогательный метод, чтоб doPost не раздувать, или не парится и передать строками(если хотя бы одна из них не пустая), а в сервисе уже делать все проверки?


6 replies
YuriyUh [3 days ago]
В пунктах 2.4 и 2.7 идет речь о фильтрации на уровне репозитория, я прям туды мапу с параметрами отдал.


Sergey Zhukov [3 days ago]
@YuriyUh только по дате на уровне репозитория


Ilya [3 days ago]
у меня две мапы, обе идут в контроллер, даты фильтруются в контроллере, время проваливается до репозитория и там уже в стриме в фильтре.


YuriyUh [2 days ago]
Ну не знаю, но по моему лучше запросить из бд уже отфильтрованный кусок, чем вытаскивать кучу записей и потом их разгребать(могу ошибаться, с бд толком не работал).


Ilya [2 days ago]
чтобы посчитать превышение по еде нам нужны полный список еды по дням


YuriyUh [2 days ago]
@Ilya Упустил сей момент


This message was deleted.


8 replies
Andrew Kalugin [3 days ago]
достать его из контеста Spring


Andrew Kalugin [3 days ago]
Я объявил переменную controller и присвоил ей значение из контекста


Andrew Kalugin [3 days ago]
все работает


Andrey Tolkachev [3 days ago]
лучше делать как в SpringMain в блоке try, вынести контроллер в отдельное поле и присваивать ему бин из контекста в блоке try
Ну а потом плавно перейти с Репо на Контроллер (edited)


Andrew Kalugin [3 days ago]
@Andrey Tolkachev я то же это имел ввиду (edited)


Andrey Tolkachev [3 days ago]
@Andrew Kalugin видимо синхронно ответили)


Andrew Kalugin [3 days ago]
:slightly_smiling_face:


Dmitriy [3 days ago]
Спасибо, разобрался)


Ivan Oct 16th at 7:52 PM
5 пункт включить классы еды в контекст Spring (добавить аннотации) и вызвать из SpringMain любой метод MealRestController (проверить что Spring все корректно заинжектил)
Получаю ошибку
WARN  ClassPathXmlApplicationContext [AbstractApplicationContext.java:556] Exception encountered during context initialization - cancelling refresh attempt: org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'inMemoryMealRepositoryImpl': Invocation of init method failed; nested exception is java.lang.NullPointerException

Yuri 3 days ago
Покажи начало класса - ты никакие аннотации кроме @Repository не поставил?

Ivan 3 days ago
@Repository
public class InMemoryMealRepositoryImpl implements MealRepository {
...
}

Ivan 3 days ago
больше ничего
Yuri 3 days ago
Спринг не может бин создать, наверно что-то там все таки есть еще. Может конечно еще настройки какие - ты в spring-app.xml ничего не добавлял?

Ivan 3 days ago
нет, его не трогал
Yuri 3 days ago
тогда надо стектрейс смотреть

Andrey Tolkachev 3 days ago
подозреваю, что метод save репозитория кидает NPE, если идет наполнение мапы в блоке кода, как у user, думаю надо там искать ошибку

Ivan 3 days ago
спасибо, была там проблема

Ivan 3 days ago
теперь вылазит

Ivan 3 days ago
Bean instantiation via constructor failed; nested exception is java.lang.NoClassDefFoundError: javax/servlet/http/HttpServlet

Ivan 3 days ago
запускаю
public class SpringMain {
    public static void main(String[] args) {
        // java 7 Automatic resource management
        try (ConfigurableApplicationContext appCtx = new ClassPathXmlApplicationContext("spring/spring-app.xml")) {
            System.out.println("Bean definition names: " + Arrays.toString(appCtx.getBeanDefinitionNames()));
            AdminRestController adminUserController = appCtx.getBean(AdminRestController.class);
            adminUserController.create(new User(null, "userName", "email@mail.ru", "password", Role.ROLE_ADMIN));

        }
    }
}

Ivan 3 days ago
и теперь выдает WARN  ClassPathXmlApplicationContext [AbstractApplicationContext.java:556] Exception encountered during context initialization - cancelling refresh attempt: org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'mealRestController' defined in file [D:\..\MealRestController.class]: Bean instantiation via constructor failed; nested exception is java.lang.NoClassDefFoundError: javax/servlet/http/HttpServlet
Exception in thread "main" org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'mealRestController' defined in file [D:\...\MealRestController.class]: Bean instantiation via constructor failed; nested exception is java.lang.NoClassDefFoundError: javax/servlet/http/HttpServlet

Andrey Tolkachev 3 days ago
у тебя также?
@Controller
public class MealRestController {
   protected final Logger log = LoggerFactory.getLogger(getClass());
   private final MealService service;
   @Autowired
   public MealRestController(MealService service) {
       this.service = service;
   }

Ivan 3 days ago
1 в 1
Andrey Tolkachev 3 days ago
возможно что-то с версиями в pom, посмотри вот тут
https://stackoverflow.com/questions/28325329/java-lang-noclassdeffounderror-javax-servlet-http-httpservlet
 Stack Overflow
java.lang.NoClassDefFoundError: javax/servlet/http/HttpServlet
I work on a web application, I created a web service with axis2 I integrated this web service in my application, but the problem is that when I try to retrieve the wsdl via the following URL: http:...
 
 
 
Andrey Tolkachev 3 days ago
если не поможет, то остается только гуглить и смотреть придирчиво стектрейс
YuriyUh 2 days ago
А где происходит вызов бина контроллера еды, можно код глянуть.
Andrey Tolkachev 2 days ago
public class MealServlet extends HttpServlet {
   private static final Logger log = LoggerFactory.getLogger(MealServlet.class);
   private MealRestController mealRestController;
   @Override
   public void init(ServletConfig config) throws ServletException {
       super.init(config);
       try (ConfigurableApplicationContext appCtx = new ClassPathXmlApplicationContext("spring/spring-app.xml")) {
           mealRestController = appCtx.getBean(MealRestController.class);
       }
   }


   
Timur_Gainitdinov [9:41 PM]
Наполнение мапы <Integer, Map<Integer, Meal>> - лучше в методе save() делать?
у меня 6 милов, 5 из них имеют userId =1...но в общую мапу идут тока 4
```if (meal.isNew()) {
           ...
            repositoryId.merge(meal.getUserId(), new ConcurrentHashMap<>(), (a, b) -> {
                Map<Integer, Meal> mapA = new ConcurrentHashMap<>(a);
                Map<Integer, Meal> mapB = new ConcurrentHashMap<>(b);
                mapA.put(meal.getId(), meal);
                mapB.put(meal.getId(), meal);
                mapB.putAll(mapA);
                return mapB;
            });
            return meal;```
(edited)


senadnepr [Oct 16th at 10:51 PM]
"4.4: конвертацию в MealWithExceeded можно делать как в слое web, так и в service" А MealsUtils мы уже не используем?


1 reply
Gekov Iliya [3 days ago]
Используем, но эти методы то нужно где-то вызвать, вот нам и дают выбор, где это сделать


regorov [Oct 17th at 1:31 AM]
По optional 7 - как сделать чтобы input'ы после отправки get запроса на фильтрацию не очищались?


3 replies
Ilya A. Kvyatkovsky [3 days ago]
Возвращай их обратно в форму из сервлета через setAttribute


Илья Чиликин [2 days ago]
set'ить заново не нужно, они доступны в jsp через ${param}



Gekov Iliya [1 day ago]
@Илья Чиликин Отличная подсказка, спасибо


Ilya A. Kvyatkovsky [3:12 AM]
Вроде работает 8/
MPEG 4 Video 
bandicam 2018-10-17 03-03-35-166.mp4
8 MB MPEG 4 Video

Sergey Zhukov [2 days ago]
Отлично, но у тебя фильтр не сохраняет, и можно использовать начальную инициализацию данными из MealsUtil.MEALS https://youtu.be/_q1ZD8ylkoU (edited)



Dima [2 days ago]
Я еще дополнил задание тем, что если нет еды у юзера, таблица не выводится, только слова, что ничего нет


Dima [2 days ago]
и я думаю, за изменением чужой еды имелось в виду прописать в url удаление чужой еды (edited)


Ilya A. Kvyatkovsky [2 days ago]
Ok! Допилю. Правда я не увидел в задании условие по поводу сохранения состояния фильтра. Если не сложно какой это пункт? Заранее Спасибо!


Gekov Iliya [2 days ago]
Нет такого пункта, так происходит в демо версии приложения


Ilya A. Kvyatkovsky [2 days ago]
@Sergey Zhukov @Gekov Iliya Спасибо! Недочет исправил. (edited)


roma [Oct 17th at 11:25 AM]
Почему вместо exlussion commons-logging предпочли избавиться от зависимости
```<dependency>
            <groupId>org.slf4j</groupId>......```
?


2 replies
Grigory Kislin [2 days ago]
вопрос не совсем понял.
exlussion commons-logging в spring 5 уже не нужен- там свой мост на slf4j


roma [1 day ago]
в этом и был вопрос ) - спасибо


indisbk [Oct 17th at 12:55 PM]
Приветствую господа, не могли бы вы объяснить почему при вызове конструктора переменная id не сохраняется (изобр. 1), хотя я явно указываю конкретное число (изобр. 2). Из-за этой проблемы, при update записи, вызывается create и соответственно создается новая (ибо id=null). Прикидываю, что причина в вызове метода super() хотя не уверен. Хелп плеазе)
1.jpg



2 replies
Gekov Iliya [2 days ago]
Вы же его не присваиваете полю id, а вызываете родительский конструктор, естественно это поле останется null, id у нас в абстрактном энтити, удалите его из Meal вообще. (edited)


indisbk [2 days ago]
благодарю не допер)


indisbk [12:55 PM]
2.jpg 


Dima Pugovkin [Oct 17th at 1:27 PM]
как вы заинжектили MealRestController в MealServlet?
у меня пока ниодин способ с гугла не сработал


11 replies
Gekov Iliya [2 days ago]
В init методе. Ничего инжектить не надо, просто берите бин контроллера из контекста и работайте с ним (edited)


Dima Pugovkin [2 days ago]
не могу получить доступ из сервлета к контексту. по просту не работает


Gekov Iliya [2 days ago]
Делаете по аналогии со SpringMain, в котором Григорий показывал работу с контекстом?



Gekov Iliya [2 days ago]
Попробуйте в любом мейне создать контекст, вывести все бины, посмотрите есть ли в них контроллер, если нет, то проверьте аннотации и spring xml


Dima Pugovkin [2 days ago]
та я ловлю бесконечно длинный стектрейс из nullpointer ведущий аж к InMemoryMealRepositoryImpl, но увы дебагер не ловит ничего, я уже везде где можно расставлял брейкпоинты


Gekov Iliya [2 days ago]
Так бины все в контексте присутствуют?


Dima Pugovkin [2 days ago]
нет,
Error creating bean with name ‘inMemoryMealRepositoryImpl’.
найти причину не удается


JavaHolic [2 days ago]
А что дальше в исключении пишется ?... там самое интересное (edited)


Vladimir Gorbatenko [2 days ago]
Жирных подсказок гора:
@Repository
public class InMemoryMealRepositoryImpl implements MealRepository
------
@Service
public class MealServiceImpl implements MealService {
   @Autowired
   private MealRepository repository;
------    
@Controller
public class MealRestController {
-----
private MealRestController repository;
-----
ApplicationContext applicationContext = new ClassPathXmlApplicationContext("spring/spring-app.xml");
       repository = applicationContext.getBean(MealRestController.class);
       ((ClassPathXmlApplicationContext) applicationContext).close();
-----


Alla Protopopova [2 days ago]
Проверьте, что  inMemoryMealRepositoryImpl у вас не кидает ошибку в процессе инициализации. Скорее всего, когда наполняется мапа с едой. Можно в том же SpringMain попробовать создать экземпляр inMemoryMealRepositoryImpl  вручную и посмотреть, создастся ли он корректно.


Dima Pugovkin [2 days ago]
Ошибка найдена, всем спасибо. Боль оказалась в том, “как” я решил реализовать репо, не учев одной вещи


Sergey Zhukov [Oct 17th at 2:20 PM]
по пункту 1.3 поясните, что значит "порядок должен быть зафиксированным"? если у нас десять пользователей с именем Sergey, то мы их выводим в порядке регистрации?


1 reply
ABaykov [2 days ago]
ABaykov [2:24 PM]
по айдишнику наверное...а чем младше айди - тем раньше зарегистрировался


Sergey Zhukov [Oct 17th at 3:39 PM]
@Grigory Kislin Григорий скажи, пожалуйста, насколько больше в памяти будет занимать Map<Integer, Map<Integer, Meal>> по сравнению с Map<Integer, Meal>? в 2 раза больше, 1.5 или меньше? судя по статье https://habr.com/post/159557/ нужно тестить, в IDEA можно это проверять?
Хабр
Накладные расходы памяти у коллекций
Мне было интересно, какие коллекции сколько съедают дополнительной памяти при хранении объектов. Я провёл замеры накладных расходов для популярных коллекций,... (136 kB)


3 replies
ABaykov [2 days ago]
https://www.ibm.com/developerworks/java/library/j-codetoheap/#HashMap
ibm.com
From Java code to Java heap
This article gives you insight into the memory usage of Java code, covering the memory overhead of putting an int value into an Integer object, the cost of object delegation, and the memory efficiency of the different collection types. You'll learn how to determine where inefficiencies occur in your application and how to choose the right collections to improve your code.
 


ABaykov [2 days ago]
Лови статеечку, надеюсь поможет проанализировать


Grigory Kislin [1 day ago]
@Sergey Zhukov
1. вопрос чисто теоретический, тк с практической точки зрения у нас нет  проблем с памятью
2. зависит от количества еды в день у юзера. можно оптимизировать вложенной мапы , задав например initialCapacity. проверить в idea не знаю- на это есть спец. инструмены. попробуй. c initialCapacity по умолчанию (16)  и небольшим кол-вом еды в день разница будет большая (edited)


fonto [Oct 17th at 6:31 PM]
Раз уж начали хвастаться видео с решенным задание, покажу и свое)). Удаление и изменение чужой еды не работает, все как по условиям, записывать не стал, т.к. проверял в postman. Аутотенфикацию написал сам) прям в сервлетах.
MPEG 4 Video
Java Enterprise (Topjava) - Google Chrome 17.10.2018 18_21_58.mp4
119 MB
MPEG 4 Video
 Click to download





17 replies
vch [1 day ago]
При всём почтении... Но не стоит ли сделать так, чтобы удаление чужой еды не приводило к NullPointerException? Да и одновременное создание нескольких Meal одним и тем же  пользователем можно сделать более потокобезопасным.


fibz [1 day ago]
интерфейс через bootstrap делал? (edited)


Dima [1 day ago]
очень сложно мне представить, что один пользователь сможет одновременно добавить две еды, можно пример?


vch [1 day ago]
@Dima никто не запрещает работать из 2 браузеров одновременно. В случае rest-запросов - можно отправить много запросов быстро друг за другом. И они могут прийти на сервер как последовательно, так и одновременно.
Программист не может полагаться на то, что не контролирует.


fonto [1 day ago]
@Dima попробуй в постмене поотравлять запросы, если код неправильно будет написан, то запросами можно будет и свою и чужую удалять


Dima [1 day ago]
Ок ,с постманом поиграюсь,а вот два браузера открытых ,это надо одновременно нажать кнопки и там и там,или одновременно выслать запрос по url, как то мало вероятно


fonto [1 day ago]
@fibz да бутстрап


vch [1 day ago]
@Dima Это 1 из проблем многопоточности - множество ситуаций невозможно повторить при обычном тестировании. Многие ситуации малореальны в реальной жизни, но это не повод их игнорировать. При высокой нагрузке вылезут - и много времени потратишь на поиск причины.
HW2 очень показателен в этом плане, особенно функция сохранения Meal. Не у всех получается её сделать так, чтобы было безопасно в многопоточной среде. (edited)


fibz [1 day ago]
@fonto как сделать чтобы выскакивало popup menu?


fonto [1 day ago]
@fibz это модальное окно, посмотри в документации бутчтрапа. Вызывать легко, а вот добавлять туда нужные параметры лучше через js, но я ещё нашел способ и без него обходиться


fibz [1 day ago]
@fonto это 3 или 4 бутстрап?

fonto [1 day ago]
4


fibz [1 day ago]
спасибо, выглядит круто


Dima [1 day ago]
@vch ща сделал пул тредов, которые 100 раз добавили еду. никаких сбоев.


vch [1 day ago]
@Dima Эээ... А ты свой код использовал или у @fonto взял?


Dima [1 day ago]
из-за инета в гостишке слишком дорогое удовольствие смотреть видосы) я свой опробовал.


vch [1 day ago]
@Dima Но ArrayList ведь не является потокобезопасным...
Конечно, можно сослаться на ТЗ - `3.4: атомарность операций не требуется (коллизии при одновременном изменении одного пользователя можно не учитывать)`, но в реальных проектах это не будет оправданием.


GerKir [Oct 17th at 8:26 PM]
Друзья, помогите исправить говнокод на адекватные методы стримов:
repository.get(userId).stream().filter(meal -> meal.getId().equals(id)).collect(Collectors.toList()).get(0);

Как из List<Meal> взять элемент совпадающий по meal.id?


18 replies
Sergey Zhukov [1 day ago]
а зачем в стрим загонять? repository.get(userId).get(id)


fonto [1 day ago]
Думаю сейчас можно уже показывать свой код)


Sergey Zhukov [1 day ago]
@fonto он просил по id а не все записи


fonto [1 day ago]
Ну да вопрос прочитал не правильно


Also sent to the channel
fonto [1 day ago]
repository.get(userId).get(mealId);


fonto [1 day ago]
Вот весь код


vch [1 day ago]
@fonto У него List, а не Map


fonto [1 day ago]
Я понял, пусть подумает, что лучше мап использовать)


GerKir [1 day ago]
у меня meal.id не совпадает с индексом, вот в чём загвоздка


vch [1 day ago]
@fonto Ну, как я выше написал, ты в качестве Map тоже не лучший вариант выбрал


fonto [1 day ago]
Тогда дело в том как ты задаешь его


fonto [1 day ago]
@vch ну когда выйдет решение от Григория, тогда и посмотрим, какое решение лучше)


Sergey Zhukov [1 day ago]
@vch я и не заметил )) тода стрим                 stream().filter(e -> e.getId().equals(id)).findFirst().orElse(null); (edited)



GerKir [1 day ago]
@Sergey Zhukov спасибо, то что нужноэ


vch [1 day ago]
@fonto если заменишь HashMap на ConcurrentHashMap - гарантирую, что твоё решение станет гораздо лучше. Но при этом парой строк ниже ты умудрился учесть очень редкий сценарий, о котором никто не задумывается, это большой плюс тебе.


Gekov Iliya [1 day ago]
Я все думал о какой проблеме с многопоточностью при сохранении шла речь, а вы имеет в виду просто про ConcurrentHashMap? Вроде на предыдущем уроке уже разобрали этот момент, что используем именно эту реализацию мапы.


fonto [1 day ago]
@vch a с чего ты взял, что у меня не concurrent?)))


Sergey Zhukov [1 day ago]
я думал что юзер может сидеть с нескольких браузеров и еще раздать учетку своим фитнес трнерам, которые будут усердно туда что то загонять, и поставил и внутреннюю мапу тоже канкарент, но уж очень маловероятно


Sergey Zhukov [Yesterday at 10:47 AM]
@Grigory Kislin Привет.  По твоему решению hw2 <T extends Comparable<? super T>> а нужно ли нам сравнивать с суперклассами? я  использовал  <T extends Comparable<T>>
Или это утильный метод и поэтому нужно стараться сделать как можно универсальней?


5 replies
Grigory Kislin [1 day ago]
ну, для сравнения с Comparable это почти правило. см например `Collections.sort(Comparator<? super E>..)`
те если можно без доп. усилий сделать универсальней- то да.


shomnest [20 hours ago]
@Sergey Zhukov в своей реализации, ты лишаешь себя возможностей полиморфизма, в будущем.


Sergey Zhukov [20 hours ago]
я не уверен что будем полиморфить даты или время, тогда уже нужно менять имя класса


Sergey Zhukov [20 hours ago]
я спрашивал про избыточность в данном случае на данном этапе, где-то она лишняя, а где-то запланированная на будущее


shomnest [20 hours ago]
Проекты имеют свойства расширятся, причем в не предсказуемых направлениях, ТЗ имеют свойства изменятся - приучайся заглядывать в будущее))


m.lysiakov [Yesterday at 9:32 PM]
Возник такой вопрос по реализации InMemoryMealRepository. Там у нас один AtomicInteger, и хоть он и не статический, но репозиторий то у нас один на всех пользователей. Соответственно один пользователь может создать еду, к примеру id = 5; На следующий день когда он создаст новую еду она не будет с id = 6; (при условии что у нас больше чем один пользователь и все они создают еду). Верно? Не то что вопрос очень важный, просто ради понимания.


4 replies
Gekov Iliya [20 hours ago]
Насколько я понимаю, каждый объект еды уникальный сам по себе, независимо от пользователей. В базе то еда у нас будет хранится в одной таблице, то есть id будет создаваться уникальный для каждого элемента еды


Sergey Zhukov [20 hours ago]
спринг создает синглетон репозитория, потом у и поле тоже в одном экземпляре


Sergey Zhukov [20 hours ago]
все обращения к методу add будут увеличивать одно и тоже поле, оно потокозащищенное, всегда будет новое значение, т.к. берется через метод IncrementAndGet


m.lysiakov [19 hours ago]
Спасибо


Plotnikov Dmitriy [Today at 9:23 AM]
Всем привет. Не очень понимаю почему у меня логирование работает только для кода проекта, а лог спринга не выводится, или я чего-то не понял, запускаю SpringMain.java
Pasted image at 2018-10-19, 9:23 AM



5 replies
Taras [6 hours ago]
Мы перенаправили обработку логирования спринга в logback. Надо явно указать в `logback.xml` какой пакет каким уровнем «воспринимать». Что-то наподобие `<logger name="org.springframework" level="info"/>`Посмотри видео про логгинг в Занятии 3.


Plotnikov Dmitriy [5 hours ago]
<root level="info">
       <appender-ref ref="file"/>
       <appender-ref ref="console"/>
   </root>


Plotnikov Dmitriy [5 hours ago]
у нас же указано в logback.xml root, или на spring оно не распространяется, просто в видео логи проходили, я ничего не менял ноу меня не проходят, но в отличие от видео у нас теперь нет одной зависимости в pom.xml


Taras [4 hours ago]
Добавь ту строчку, что я написал, возле “нашего” `<logger name="ru.javawebinar......>`. Root —  это указание, какой корневой уровень и какие аппендеры будут «распространяться» вниз по иерархии. А собственно «пакеты» воздействия указаны в `<logger name="...>`. Блин, путано написал, подключи — увидишь и поймёшь.


Plotnikov Dmitriy [4 hours ago]
Спасибо


Стецко Максим [Today at 11:54 AM]
Подскажите, что за переменная param и откуда она взялась в jsp (с вебом у меня еще плохо).


3 replies
Ansseii [6 hours ago]
@Стецко Максим https://stackoverflow.com/questions/1890438/how-to-get-parameters-from-the-url-with-jsp/1890462#1890462
Stack Overflow
How to get parameters from the URL with JSP
In JSP how do I get parameters from the URL? For example I have a URL www.somesite.com/Transaction_List.jsp?accountID=5 I want to get the 5. Is there a request.getAttribute( "accountID" ) like th...
 


Стецко Максим [6 hours ago]
@Ansseii <input type="date" name="startDate" value="${param.startDate}> т.е. этот парам означает, значение будет равно выбранному параметру startDate?


Grigory Kislin [3 hours ago]
ссылки же есть все в уроке! смотрите внимательно перед тем, как спросить


regorov [Oct 20th at 7:33 PM]
Что значит вот этот пункт (подсказки к HW02) 1.3: предусмотрите случай одинаковых User.name (порядок должен быть зафиксированным). ? (edited)


2 replies
Alexey_b [1 day ago]
в компараторе предусмотреть случай с одинаковыми именами, и если он случится, добавить к сравнению еще одно поле, например id (edited)



regorov [1 day ago]
ага, спасибо. Я вообще пропустил этот пункт (список пользователей возвращать отсортированным по имени)..