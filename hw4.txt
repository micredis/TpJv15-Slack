Grigory Kislin [11:46 PM]
joined #hw4.

Grigory Kislin [11:48 PM]
Четвертое занятие нашего проекта: популирование данных через Spring, JPA/Hibernate, HSQLDB
https://github.com/JavaWebinar/topjava/blob/doc/doc/lesson04.md
Материалов по JPA огромное количество. Чтобы не утонуть - не надо пытаться освоить все сразу. Пока достаточно того, что нужно для выполнения HW4
После выполнения этого достаточно несложного ДЗ можно приступать к выполнению выпускного проекта:  канал  #graduation
Миграцию на JUnit 5 будем делать после освоения JUnit 4 (он сейчас самый распространенный) на 7-м занятии (edited)

Gekov Iliya [11:52 PM]
joined #hw4 along with 18 others.

Илья Чиликин [2:53 AM]
Внезапно в проект врывается Travis CI! Приятная неожиданность.


Илья Чиликин [Today at 3:01 AM]
@Grigory Kislin Григорий, поясните, почему в патче 4_3 в InMemoryRepository для проверки на null используется `Objects.requireNonNull`, а в ServiceImpl `Assert.notNull`? (edited)


1 reply
Grigory Kislin [1 hour ago]
для пояснения материала видео. в реальности в одном проекте везде используются один подход. напишу в урок


KaryNaiKo [Today at 8:58 AM]
Что такое meals_index и что с этим делать?


2 replies
Sergey Zhukov [3 hours ago]
индексы были в задании HW3 Optional, если коротко то задаем столбцы для индексирования, поиск по ним будет происходить быстрее
вот же есть ссылка в описании
https://postgrespro.ru/docs/postgresql/9.6/indexes.html
postgrespro.ru
PostgreSQL : Документация: 9.6: Глава 11. Индексы (9 kB)
 


Grigory Kislin [1 hour ago]
@KaryNaiKo ссылки на индексы есть в ДЗ уроке 3. добавил туда эту, по русски


under4eg [Yesterday at 3:35 PM]
после подключения QAPlug идея начала материться на невозможность сохранить настройки, анализ кода, соответственно, тоже не работает
проблема совместимости идеи 2017.2.5 с плагином, который идея сама тянет, версии 1.3.15. установка более новых версий плагина успеха не принесла, решилось обновлением идеи до 2017.3.5 (edited)


2 replies
Grigory Kislin [3 hours ago]
У меня idea 2018.2.5, QAPlug 1.3.18
все работает (edited)


under4eg [2 hours ago]
3.18 не захотел устанавливаться вообще


Roman Baranov [Yesterday at 7:34 PM]
@Grigory Kislin
ссылка
*Comparison Preconditions in Java* (https://www.sw-engineering-candies.com/blog-1/comparison-of-ways-to-check-preconditions-in-java) - битая


2 replies
creilyss [6 hours ago]
похоже правильная теперь тут : https://www.sw-engineering-candies.com/comparison-of-ways-to-check-preconditions-in-java



Grigory Kislin [3 hours ago]
спасибо! поправил в уроке


fibz Yesterday at 11:09 PM
Накатил патчи, настроил persistence data source ,  jpa provider выставил, но тесты на сервис выкидывают org.hibernate.HibernateException: Access to DialectResolutionInfo cannot be null when 'hibernate.dialect' not set.   В чём может быть проблема? (edited)

Dmitriy 14 hours ago
Попробуй SQL Dialects выбрать PostgreSQL

fibz 14 hours ago
@Dmitriy где его прописывать? в SQL скриптах? Если да, то я думаю дело не в этом (edited)

Ilya 13 hours ago
прописывать нужно в jpaPropertyMap , но какой не скажу) сам сейчас мучаюсь, что нить типо такого org.hibernate.dialect.PostgreSQL95Dialect

Ilya 13 hours ago
да это сработало) но чтобы все это работало дальше нужно реализовать JpaMealRepositoryImpl

Grigory Kislin 3 hours ago
это странно. обычно ругается на диалект, если приконектится к базе не может. попробуй убрать и поверить еще раз


fibz [Today at 12:00 AM]
@Grigory Kislin попробовал решить проблему описанную выше копией исходников с гитхаба. Не помогло. В чём может быть проблема? По прежнему пишет  `Access to DialectResolutionInfo cannot be null when 'hibernate.dialect' not set` (edited)


1 reply
fibz [14 hours ago]
Вопрос решился, посмотрел весь лог, после патчей сбились credentionals базы, всё работает


Gekov Iliya [Today at 12:07 AM]
https://habr.com/post/140344/ небольшая статья про travis для тех, кто как и я не сразу понял его назначения) (edited)



1 reply
Grigory Kislin [3 hours ago]
спасибо, добавлю ссылку в урок


Raisa Today at 8:20 AM
у меня еще раз проект topjava форкнулся после интеграции с codacy и travis, это нормально?

Grigory Kislin 3 hours ago
Раиса, ты попробовала отредкатировать read.me в моем репозитории, github сделал fork.
в settings удали topjava-1 и отредактируй свой read.me


Andrew Kalugin [Today at 8:43 AM]
-отключил в настройках (remove pattern) проверку assert в JUnit (проверяем через матчеры)
где??? JUnit tests should include assert() or fail()   это?
-сделал remove pattern на Cross Site Scripting (XSS),
Using unsanitized JSP expression can lead to Cross Site Scripting (XSS) attacks  ????
- и последнее - отключить в настройках meta http-equiv="content-type" в JSP
где искать?


7 replies
Gekov Iliya [5 hours ago]
В настройках на своей странице codacy


Raisa [5 hours ago]
вы бейдж с codacy прямо в readme в master коммитили? вручную?


Gekov Iliya [5 hours ago]
Да


Andrew Kalugin [5 hours ago]
@Gekov Iliya а по подробнее можно


Raisa [5 hours ago]
в конце видео 4_2 Григорий показывает как удалять, с 7:02 (edited)



Gekov Iliya [5 hours ago]
Да, видео методы улучшения качества кода, в конце показано как это делается. Лично я вообще не стал заморачиваться и убрал проверку всей папки webapp) (edited)



Andrew Kalugin [5 hours ago]
Спасибо. В видео видел этот момент. Но что-то понесло меня в настройки искать :slightly_smiling_face:


Raisa [Today at 9:21 AM]
попробовала в настройках проигнорировать md файлы - пропали все issues. Сделала как было, issues не вернулись. Подскажите плиз в чем может быть причина?
Pasted image at 2018-10-26, 1:21 PM



3 replies
Gekov Iliya [4 hours ago]
У меня они тоже проигнорированы, все нормально. Попробуйте запустить анализ заново


Raisa [4 hours ago]
как его запустить повторно?


Raisa [4 hours ago]
нашла, вдруг кому пригодится https://support.codacy.com/hc/en-us/articles/213840489-How-do-I-reanalyze-my-project-
Codacy
How do I reanalyze my project?
Click on the latest commit from your list in the Commit view and click to reanalyze as the latest commit includes all the code of all the PRs'. (46 kB)


fonto Today at 12:20 PM
Я для инициализации базы, создал отдельную базу, в ресурсах добавил отдельные контексты и файлы базы. И делал это через аннотации:
@ContextConfiguration({
        "classpath:spring/spring-app.xml",
        "classpath:spring/spring-db-test.xml"
})
@RunWith(SpringRunner.class)
@Sql (value = {"classpath:dbTest/populateDB-test.sql"}, executionPhase = Sql.ExecutionPhase.BEFORE_TEST_METHOD, config = @SqlConfig(encoding = "UTF-8"))

fonto 1 hour ago
Я создавал актуальные данные, но таким же образом можно и базу инициализировать предварительно. Таким образом с базой для тестов мы можем делать, что угодно и не париться) (edited)


This message was deleted.
 
Marat 1 hour ago
Exception in thread "main" org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name 'jdbcMealRepositoryImpl' defined in file [C:\Users\m.kaziyev\Google Drive\Java\topjava\target\classes\ru\javawebinar\topjava\repository\jdbc\JdbcMealRepositoryImpl.class]: Unsatisfied dependency expressed through constructor parameter 0; nested exception is org.springframework.beans.factory.NoSuchBeanDefinitionException: No qualifying bean of type 'org.springframework.jdbc.core.JdbcTemplate' available: expected at least 1 bean which qualifies as autowire candidate. Dependency annotations: {}
    at org.springframework.beans.factory.support.ConstructorResolver.createArgumentArray(ConstructorResolver.java:767)

Marat 29 minutes ago
Разобрался


Marat [Today at 2:19 PM]
Подкажите с named query
@NamedQuery(name = Meal.ALL_BETWEEN, query = "SELECT m FROM Meal m WHERE m.dateTime " +
               "BETWEEN :startDate AND :endDate AND m.user=:userId")

Ошибка в WHERE m.dateTime


5 replies
vch [6 hours ago]
А точно не с `m.user` проблема?


Marat [6 hours ago]
Type mismatch: number, date or string expected less... (Ctrl+F1)
Inspection info: This inspection controls whether the Persistence QL Queries are error-checked


Marat [6 hours ago]
Именно с возвратом даты


vch [6 hours ago]
Это сообщение об ошибке от IDEA? Или при выполнении вылетел такой текст ошибки? Если ругается IDEA - то см. п. 8 подсказок по HW4


Marat [6 hours ago]
ясно, В IDEA, но она обновленная


Marat [Today at 2:49 PM]
В таблице есть пользователь и его id 100000.
Но при запуске
Message Parameter value [100000] did not match expected type [ru.javawebinar.topjava.model.User (n/a)]
java.lang.IllegalArgumentException: Parameter value [100000] did not match expected type [ru.javawebinar.topjava.model.User (n/a)]


3 replies
Marat [5 hours ago]
Неправильно соединил таблицы?


vch [5 hours ago]
Всё же рекомендую обратить внимание на эту часть запроса: `m.user=:userId` В ней ошибка (edited)


Marat [5 hours ago]
ок


indisbk [3:00 PM]
Господа, подскажите при User ref = em.getReference(User.class, userId);
meal.setUser(ref); ведь присваивается прокси-объект? Потому что при assert, тогда получается User сравнивается с прокси-User и выходит что объекты не равны. Шо делать то?


Zhinko [Today at 3:05 PM]
Есть вопрос. В поле user ставлю @ManyToOne(fetch = FetchType.LAZY). Но при попытке тестирования получаю org.hibernate.LazyInitializationException: could not initialize proxy [ru.javawebinar.topjava.model.User#100001] - no Session


6 replies
indisbk [5 hours ago]
потому что lazy - это инициализация объекта при необходимости, а eager - это глобальная инициализация объекта.


vch [5 hours ago]
Гораздо интереснее вопрос, почему при тестировании происходит обращение к полям User... Это совершенно излишне. С Lazy всё вполне должно работать.


Zhinko [5 hours ago]
При тестировании обращения к полям user не происходит потому что при попытке достать значения из базы я получаю вышеуказанный ексепшн


indisbk [5 hours ago]
Если в своем маппинге вы включите lazy-fetching для этой коллекции, то все обращений будут заменены на "ленивые" прокси, выполняющие подгрузку по мере необходимости. Таким образом, запрос, не затрагивающий каких-либо членов или параметры коллекции, не вызовет ее подгрузку. - такой ответ нашел на стэке


vch [5 hours ago]
В Exception указывается строка кода, где он вылетел. Что в этой строке?
В момент доставания значения из базы он произойти не может - Exception ясно указывает на то, что сессия работы с БД уже закрыта.


Zhinko [5 hours ago]
Все мой косяк, я невнимательно посмотрел. Забыл исключить поле user в  assertMatch


Dmitriy [3:25 PM]
3.3: вывод сводки в конце класса: имя теста - время выполнения - Использовать @ClassRule?

Nikita Ganin [4:31 PM]
Как быть с обновлением meal, тоже нужно создавать запрос jpql? Там же тоже нужно проверять userId

Marat [5:15 PM]
По этой конструкции есть какой-нибудь материал?
User ref = em.getReference(User.class, userId);
meal.setUser(ref);
Как это называется, принцип, стратегия, шаблон?


Sergey Zhukov [Oct 27th at 9:28 PM]
ругается на параметр "name" после патча 4_6
вроде починил, оказалось при интеграции JPA внизу была кнопка fix и я ее нажал, он мне подгрузил в lib библиотеку javaee.jar, удалил ее, но интеграция похоже слетела (edited)
Untitled
@UniqueConstraint(columnNames = "email", name = "users_unique_email_idx")



7 replies
Raisa [1 day ago]
на name или на значение? если на значение, то можно попробовать alt+enter, выбрать ресурс (edited)


Sergey Zhukov [1 day ago]
на сам параметр ругалась


under4eg [1 day ago]
вчера игрался с этим, не собиралось, пока не удалил либу JPA 1.0


under4eg [1 day ago]
пытался найти, кто и откуда тянет именно 1.0 версию, с которой эти нюансы - ни одной зависимости не нашел. ослеп, что ли...


Sergey Zhukov [1 day ago]
у меня подтянула сама idea если пытаешься интегрировать JPA до добавления зависимостей в maven, те. я не накатил патчи
jpa_int.png



Sergey Zhukov [1 day ago]
вот зависимость которая содержит нужную нам javaee.jar
       <dependency>
           <groupId>org.hibernate</groupId>
           <artifactId>hibernate-entitymanager</artifactId>
           <version>${hibernate.version}</version>
       </dependency>


under4eg [1 day ago]
не, я вроде всё делал последовательно, но по итогу сматерилось на либу JPA, пока её не удалил - не работало, при чем все вопросы по этой теме были отвечены, мол, "ну ты поменяй 1.0 на 2.0 в зависимостях и всё", а зависимости как таковой я не обнаружил в проекте вообще


Maxim Valeev [Yesterday at 8:50 AM]
Привет. Если делать апдейт еды, у нас же ни в одной еде нету инициализированного User, в итоге все падает т.к. userId равно null. А если я в апдейте буду делать User ref = em.getReference(User.class, userId);
       meal.setUser(ref); то где тогда проверяется принадлежность еды к юзеру?


5 replies
Maksim [1 day ago]
Может просто вынуть и проверить


Maxim Valeev [1 day ago]
em.merge(meal) не сработает в jpa реализации для Meal? нужно запросом делать чтоб можно было поверять принадлежность еды к пользователю?


Zhinko [1 day ago]
можно вызвать метод get и проверить что он возвращает если null То еды с этим id пользователя в базе нет


Maxim Valeev [1 day ago]
почему не получается это сделать через namedQuery?
Ловлю:
Caused by: java.lang.IllegalArgumentException: Update/delete queries cannot be typed (edited)


Maxim Valeev [1 day ago]
сделал нетипизированный namedQuery. Проверяю что изменилась хотя бы одна запись


Zhinko Yesterday at 9:52 AM
Кто-нибудь сделал вывод в лог время выполнения каждого теста? Как это сделать эффективно?

Dima 20 hours ago
Ну я сделал два TestWatcher, один на методы, другой - на класс. Первый отсчитывал время начала и конца метода, выводил в лог нашим логгером и заодно кидал в мапу "ИмяМетода - Время". А второй просто в конце тестов выводил мапу. Думаю, если покапаться, можно и получше сделать)

Zhinko 18 hours ago
Кстати отличная идея


Vladimir Gorbatenko [6:08 PM]
В этом видео:
Видео: Вячеслав Круглов — Как начинающему Java-разработчику подружиться со своей базой данных?
https://www.youtube.com/watch?v=dFASbaIG-UU
в конце, лектор приводит в пример интересную утилиту - log4jdbc.
Поэкспериментировал, понравилось.
******************************************
1. Добавил в проект зависимость.
<dependency>
           <groupId>com.googlecode.log4jdbc</groupId>
           <artifactId>log4jdbc</artifactId>
           <version>1.2</version>
</dependency>
******************************************
2. В конфиг postgres.properies изменил url и driver:
#database.url=jdbc:postgresql://localhost:5432/topjava
database.url=jdbc:log4jdbc:postgresql://localhost:5432/topjava
#database.driverClassName=org.postgresql.Driver
database.driverClassName=net.sf.log4jdbc.DriverSpy
******************************************
3. В конфиг тестового логирования logback-test.xml добавил такое:
<logger name="jdbc.sqltiming" additivity="false" level="DEBUG">
       <appender-ref ref="console"/>
   </logger>
   <!--
   <logger name="jdbc.connection" additivity="false" level="FATAL">
       <appender-ref ref="console"/>
   </logger>
   <logger name="jdbc.resultset" additivity="false" level="INFO">
       <appender-ref ref="console"/>
   </logger>
   <logger name="jdbc.audit" additivity="false" level="INFO">
       <appender-ref ref="console"/>
   </logger>-->
   <!--<logger name="jdbc.sqlonly" additivity="false" level="DEBUG">
       <appender-ref ref="console"/>
   </logger>-->
То что закомментированно, тоже содержит интересную информацию.
Жаль только проект мутный, и видимо переходил из рук в руки, и в текущей версии не получилось вывести resultsettable, а было бы удобно. (edited)
Еще пара полезных моментов можно добавить в "logback-test.xml" для вывода параметров и просмотра resultSet'a
<logger name="org.hibernate.SQL" level="DEBUG" />
<logger name="org.hibernate.type" level="TRACE" />


Alexey_b [Yesterday at 8:37 PM]
Почему-то не срабатывает валидация   @NotBlank:
 @Column(name = "description", nullable = false)
 @NotBlank
 private String description;
Ввожу в поле ""  и ничего подозрительного в логах не вижу, все работает (edited)


6 replies
Alexey_b [15 hours ago]
Named query не использую


Ilya [14 hours ago]
может не тот импорт подтянулся?


Alexey_b [14 hours ago]
не, вроде все ок . import javax.validation.constraints.NotBlank;


Sergey Zhukov [14 hours ago]
у меня все норм с пустой description валится
empty.png



Sergey Zhukov [13 hours ago]
а да еще в подсказках
```5: При записи в базу через namedQuery валидация ентити не работает, только валидация в бд```


Alexey_b [5 hours ago]
не, я повыше писал, что named не использую, поиграю с этим сегодня вечером, напишу тест (edited)


Sergey Zhukov [11:11 PM]
только сейчас заметил, у нас в pom.xml
       
```<dependency>
            <groupId>org.hibernate</groupId>
            <artifactId>hibernate-core</artifactId>
            <version>${hibernate.version}</version>
        </dependency>```
а в видео говорится что надо под JPA брать
       
```<dependency>
            <groupId>org.hibernate</groupId>
            <artifactId>hibernate-entitymanager</artifactId>
            <version>${hibernate.version}</version>
        </dependency>```
(edited)

fibz [11:43 AM]
после пуша в гитхаб travis не смог собрать проект. Пишет:

[ERROR] COMPILATION ERROR :
[INFO] -------------------------------------------------------------
[ERROR] /home/travis/build/f1bz/topjava/src/main/java/ru/javawebinar/topjava/model/Meal.java:[3,25] package javax.persistence does not exist
[ERROR] /home/travis/build/f1bz/topjava/src/main/java/ru/javawebinar/topjava/model/Meal.java:[4,25] package javax.persistence does not exist

как быть в таком случае? (edited)


Pushkin [2 days ago]
Перед пушем надо было обновить депенденси в мавене. А сейчас: обновить депенденси,  внести какое-то изменение,  чтобы можно было сделать коммит, сделать коммит и пуш. Должно помочь. :slightly_smiling_face:


[Oct 29th at 1:14 PM]
С такой ошибкой никто не сталкивался? ) org.postgresql.util.PSQLException: ОШИБКА: столбец meal0_.datetime не существует
 Подсказка: Возможно, предполагалась ссылка на столбец "meal0_.date_time". (edited)


11 replies
Marat [2 days ago]
У меня было что-то подобное
@Column(name = "date_time", nullable = false)
   @NotNull
   private LocalDateTime dateTime;

Вместо name = "date_time" было name = "datetime"


Marat [2 days ago]
В БД колонка называется date_time

[2 days ago]
интересно


[2 days ago]
Pasted image at 2018-10-29, 2:27 PM



[2 days ago]
все слитно


[2 days ago]
но попоробую с подчеркиванием


[2 days ago]
@Marat работает!) спасибо! только не понятно почему нижнее подчеркивание там, если его там нет


[2 days ago]
да, если смотреть таблицу отдельно, колонка с подчеркиванием...


Marat [2 days ago]
У меня отображало также, пока я не нажал на кнопку обновить всерху где БД настраивается


Marat [2 days ago]
В скриптах по инициализации БД .sql колонка с подчеркиванием. Эти скрипты отрабатывают и создают таблицы, но в IDEA отображение не обновляется


Marat [2 days ago]
пока вручную не нажать кнопку


Zhinko [Oct 29th at 1:47 PM]
Кто нормально HSQLDB смог запустить


10 replies
Chensy [2 days ago]
у меня все ок, проблем не возникло


[2 days ago]
hsqldb (local) и в списке выбираешь in-memory, если надо драйвера подкачиваешь, идея подскажет


Andrey Tolkachev [2 days ago]
ну и не забудь раскомментить/закомментить лишнее в пропертях


Zhinko [1 day ago]
В каком списке. Я почему-то никакого списка не видел


[1 day ago]
Если списка как в видео не было (у меня не было), то аналогичный выбор есть в настройках соединения к этой базе


[1 day ago]
Pasted image at 2018-10-29, 3:58 PM



Zhinko [1 day ago]
У меня вот так выглядит
question.png



Andrey Tolkachev [1 day ago]
это ты в настройках драйвера находишься, тебе надо добавить базу, кликни на + в верхнем левом углу



[1 day ago]
Это не те настройки, нужно сначала добавить эту базу, чтобы она была в списке ProjectDataSource и там уже открыть настройки (edited)


Zhinko [1 day ago]
все разобрался спасибо!


KaryNaiKo [Oct 29th at 8:16 PM]
Подскажите, что такое и зачем нужен jpaVendorAdapter?


1 reply
Taras [1 day ago]
Мы создаем спринговую entityManagerFactort  и в качестве одного из параметров адаптер, который «привязывает» к спрингу конкретную реализацию jpa: в нашем случае Hibernate. А может быть и не hibernate..


Sergey Zhukov [Oct 29th at 8:54 PM]
по JPQL подскажите что IDEA хочет от меня?
а вот такая конструкция не вызывает вопросов
```SELECT m FROM Meal m LEFT JOIN FETCH m.user WHERE m.user.id=:userId AND m.dateTime>=:startDate AND m.dateTime<=:endDate ORDER BY m.dateTime desc```
between.png
 


18 replies
[1 day ago]
8: Старые версии IDEA тупят по поводу проверки BETWEEN. Обновитесь либо не обращайте внимания.


Sergey Zhukov [1 day ago]
ок понял :slightly_smiling_face:

under4eg [1 day ago]
2018 2.5 такая же история


[1 day ago]
Главное работает)


Taras [1 day ago]
Даже 2018.3 EAP тупит..


ABaykov [1 day ago]
кстати, когда делаешь left join fetch в запросе, вытягивается meal с юзером. По идее нам от юзера только его id нужен

Nikita Ganin [1 day ago]
Зачем вообще делать в этом запросе left join fetch?

[1 day ago]
чтобы вытащить юзера и отфильтровать его по ид, можно еще inner join результат будет одинаковый


[1 day ago]
Может я ошибаюсь, но запрос и без этого отлично работает на мой взгляд


[1 day ago]
ну если бы это чистый скл) то работало бы с соединением, а так как тут hql то возможно он обращение через точку поймет и сделает соединение сам


[1 day ago]
надо попробвать


Nikita Ganin [1 day ago]
у меня тоже работает без join, поэтому и спрашиваю


[1 day ago]
Судя по тесту, запрос в базу идет один, юзер не вытаскивается


ABaykov [1 day ago]
ну вот я попробовал сделать с джойном, судя по логу - хибернейт вытаскивает у юзера всё, даже роли


ABaykov [1 day ago]
поэтому запрос делал без джойнов


ABaykov [1 day ago]
отрабатывает корректно, вытягивает только uder_id


[1 day ago]
да дейтвительно без джоинов работает


Vladimir Gorbatenko [1 day ago]
Чтоб красный цвет не раздражал, можно перед классом поставить такое - @SuppressWarnings("all") - "забить на все предупреждения"


Nikita Ganin [Oct 29th at 9:39 PM]
Если реализовывать update еды через merge, как поступить с notfoundexception? Try/catch ведь не рекомендуется


24 replies
Sergey Zhukov [1 day ago]
интересно, а проверять, что возвращает мне get по этому id можно? я пока ничего лучше не придумал


Sergey Zhukov [1 day ago]
ну а потом уже мержить


Alexey_b [1 day ago]
я вытянул еду с таким Id и userId. Если она null, то бросаем


[1 day ago]
Я не делал merge, сделал через namedQuery Update, все работает как и в Jdbc...Impl


Sergey Zhukov [1 day ago]
а зачем бросать исключение, у нас сервис это делает


[1 day ago]
Так же проверяю сколько строк было изменено и возвращаю null если 0, в итоге одно обращение к базе


Alexey_b [1 day ago]
я что-то не нашел, чтобы сервис бросал....


Nikita Ganin [1 day ago]
@Sergey Zhukov если не бросать исключение, то тест updateNotFound не пройдет, т.к. предполагается NotFoundException


Nikita Ganin [1 day ago]
Так можно сразу весь объект обновить, или надо все поля выдергивать?


Sergey Zhukov [1 day ago]
у меня в сервисе
```public void update(Meal meal, int userId) {
        checkNotFoundWithId(repository.save(meal, userId), meal.getId());
    }```
checkNotFoundWithId как раз кинет исключение при null (edited)


[1 day ago]
@Nikita Ganin для этого репозиторий должен соответствующее значение вернуть (null если невозможно выполнить операцию), из-за которого в сервисе уже выкинется исключение, иначе получается не логично и в репозитории исключения и в сервисе...


[1 day ago]
@Nikita Ganin у меня получился запрос вида Update ... SET ...поля, которые апдейтим ... WHERE id... and userId...


[1 day ago]
Соответственно в репозитории вытаскиваем из мила три наших поля и впихиваем в этот namedQuery


[1 day ago]
В результате можем сделать executeUpdate, который вернет нам количество измененных строк и все как и раньше с выкидыванием исключений работает (edited)


Nikita Ganin [1 day ago]
@Sergey Zhukov но так получается что мы делаем два запроса, один чтобы получить еду по userId и проверить на ее наличие, а второй само обновление. Непонятно насколько это рационально


Nikita Ganin [1 day ago]
я тоже думал о таком решении, но через merge получается короче, но не одним запросом


[1 day ago]
Ну, между короче и два запроса к базе и немного длиннее, но один запрос, лично я выберу второе)


Sergey Zhukov [1 day ago]
я пока так оставлю, я думаю сделать через query перед тем как сдавать, мне пока интересно почему тесты не работают (edited)


[1 day ago]
Возможно, есть способ и короче и с одним запросом) в любом случае увидим в четверг)


[1 day ago]
@Sergey Zhukov Посмотри 7 пункт подсказок


Nikita Ganin [1 day ago]
Я полностью согласен за один запрос

Sergey Zhukov [1 day ago]
Спасибо, ослеп уже :nerd_face:


Sergey Zhukov [1 day ago]
вот тесты зеленые, теперь можно оптимизировать запросы :beers:


Sergey Zhukov [1 day ago]
через namedQuery Update действительно все работает за один запрос к базе :+1:


Sergey Zhukov [Oct 29th at 9:54 PM]
По поводу тестов, у нас же теперь User объект, нам надо тесты допилить?
у меня одного они не рабтают? пишут:
```java.lang.AssertionError: 
Expecting:
 <"[Meal{id=100004, dateTime=2015-05-30T20:00, description='Ужин', calories=500},
    Meal{id=100003, dateTime=2015-05-30T13:00, description='Обед', calories=1000},
    Meal{id=100002, dateTime=2015-05-30T10:00, description='Завтрак', calories=500}] (ArrayList@49f3ff41)">
to be equal to:
 <"[Meal{id=100004, dateTime=2015-05-30T20:00, description='Ужин', calories=500},
    Meal{id=100003, dateTime=2015-05-30T13:00, description='Обед', calories=1000},
    Meal{id=100002, dateTime=2015-05-30T10:00, description='Завтрак', calories=500}] (ArrayList@6cfbbff7)">
but was not.```
(edited)


37 replies
[1 day ago]
По этому поводу в подсказках есть пункт



[1 day ago]
это на первый тест ругается? у меня пишет rg.hibernate.LazyInitializationException: could not initialize proxy


[1 day ago]
Да, это из за поля юзера


[1 day ago]
зачем то пользователей хочет вычитать походу


Sergey Zhukov [1 day ago]
по аналогии с UserTestData надо заигнорить поле user


[1 day ago]
Потому что изначально у нас идет сравнение по всем полям


[1 day ago]
так н же сравнивает результат запроса с тестовой едой, нигде нет этого поле вроде


Sergey Zhukov [1 day ago]
берет класс и идет сравнение по всем полям


[1 day ago]
На вывод логов не надо смотреть, там используется toString

[1 day ago]
А в toString user поля нет. Об этом тоже написано в подсказках)


[1 day ago]
а...там сейчас прокси в поле юзера


[1 day ago]
ну можно обойти результат и запихать null в юзера


Sergey Zhukov [1 day ago]
куда ты запихаешь в сервис)


[1 day ago]
Можно, но если руководствоваться исключительно заданием, то не нужно)


[1 day ago]
Да и способ с игнорированием красивее выглядит


[1 day ago]
ок, сделаем с игнорированием)


Sergey Zhukov [1 day ago]
может нужно будет отдельно брать и сравнивать асертом юзера из еды и эталонного


Sergey Zhukov [1 day ago]
сейчас не требуется


Sergey Zhukov [1 day ago]
значит в игнор его


[1 day ago]
все же ради тренировки стримов)


[1 day ago]
service.delete(MEAL1_ID, USER_ID);
       assertMatch(service.getAll(USER_ID).stream()
               .peek(meal -> meal.setUser(null))
               .collect(Collectors.toList()), MEAL6, MEAL5, MEAL4, MEAL3, MEAL2);


[1 day ago]
тест на update() у вас проходит?

[1 day ago]
Да

[1 day ago]
как? он же апдейтит другого юзера

[1 day ago]
нет вру...

[1 day ago]
Получилось? Если ничего не менять в предыдущей реализации, то юзер один и тот же получается


[1 day ago]
да получилось, косяк был апдейте

[1 day ago]
а в чем у нас заключается функциональность @Rule?

[1 day ago]
а, это пункты 3.1,3.2,3.3 с помощью них сделать?

[1 day ago]
Если я все правильно понял, то зарефакторить проверку исключений на ExpectedException (относительно новая и удобная фишка) и добавить подсчет времени выполнения в логи


[1 day ago]
Да

[1 day ago]
Timeout depricated(

[1 day ago]
Я сделал вручную подсчет, вроде неплохо считает, время соответствует тому, что показывает идея +- пару мс

[1 day ago]
через currentTimeMillis?

[1 day ago]
ага

[1 day ago]
и все это в руле?


[1 day ago]
Да


Sergey Zhukov [11:11 PM]
по LEFT/RIGHT JOIN видео просто и понятно
https://www.youtube.com/watch?v=yq3ijmftK9Y
YouTubeGeek Code
15. Операторы LEFT JOIN, RIGHT JOIN

[11:56 PM]
для тестирования исключений, если тоже сначала не понимаете что требуется) https://easyjava.ru/testing/junit/testirovanie-isklyuchenij/
EasyJava
Тестирование исключений
До сих пор мы тестировали только корректное поведение кода (happy path) - проверяли корректную работу на корректных данных. Такой идеальный мир, к сожалению, встречается только в учебниках, да и то, не во всех. Реальный код сталкивается с кривыми руками программистов... #exceptions #junit #unittest
Jun 7th, 2015


Sergey Zhukov [1 day ago]
в этой статье не понятно, что делает строка
```exception.expectMessage(containsString(testString));```
expectMessage(что здесь нужно передавать?)


[1 day ago]
Месседж который идет с исключением


[1 day ago]
Я проверяю что наш нотфаунд выводит именно то сообшение что требуется


Sergey Zhukov [1 day ago]
просто у меня не находит такой метод )
но вроде понял если туда передать часть нашего сообщения из утильного класса он проверит эту подстроку из исключения
```exception.expectMessage("Not found entity with ");```
так?


[1 day ago]
Не обязательно часть, можно всю строку


Sergey Zhukov [1 day ago]
Точно добавил IDшник и тест пройден. Теперь понял, спасибо :+1:


Raisa [22 hours ago]
если вдруг еще актуально - containsString - это статический метод, его можно импортировать


Raisa [Yesterday at 6:53 AM]
привет! кто-нибудь сделал 3.3: вывод сводки в конце класса: имя теста - время выполнения? попробовала собирать все строки в общий лист и выводить через переопределение finished(), @ClassRule, куда выводится так и не нашла, хотя если смотреть по дебагу до sout доходит выполнение после всех тестов. Пробовала и через sout и через log. В чем может быть ошибка?


38 replies
indisbk [1 day ago]
я создал простую рулу, где закидывал имя и время в мапу, а в тестовом классе выводил в методе под аннотацией - @AfterClass


Raisa [1 day ago]
спасибо, попробую


[1 day ago]
Аналогичным путем сделано, в лог выводит


Raisa [1 day ago]
получилось )
Pasted image at 2018-10-30, 12:38 PM



indisbk [1 day ago]
поздравляю)


Sergey Zhukov [1 day ago]
@Raisa тоже так красиво хочу вывести, где почитать?


[1 day ago]
А в чем проблема? Заполняем мапу да выводим как хотим)


Raisa [1 day ago]
@Sergey Zhukov просто в лог выводишь строку "\n-------------------------------\n" в начале и в конце, и в watcher добавляешь символы \n testTimeData.add("\nTest name: " + description.getMethodName() + ", time: " + testTimeExecute + " ms");


Sergey Zhukov [1 day ago]
а нужен тестовый конфиг для logback?


[1 day ago]
Нет


Ansseii [1 day ago]
А вот мое творение.
Screenshot 2018-10-30 at 11.59.56 AM.png



[1 day ago]
@Ansseii красиво) с помощью чего так сделано?


Ansseii [1 day ago]
От наших менторов узнал, что logback позволяет раскрашивать вывод в лог. Делается в конфигурации xml.  Ну а формат текста сделал через format и “всеми любимые” регулярки.
https://logback.qos.ch/manual/layouts.html (edited)



Sergey Zhukov [1 day ago]
время выполнения как считаете, в junit есть что-нибудь стандартное или свое нужно придумывать?

[1 day ago]
Я не нашел стандартное


Ansseii [1 day ago]
@Sergey Zhukov
Есть. Посмотрите на Stopwatch
https://junit.org/junit4/javadoc/4.12/org/junit/rules/Stopwatch.html


[1 day ago]
Оп, плохо искал)

Sergey Zhukov [1 day ago]
@Ansseii спасибо сейчас гляну

Sergey Zhukov [1 day ago]
как-то так
Stopwatch.png



[1 day ago]
баловство одно) IDEA сбоку пишет и время, и метод. Но для понимания @Rule отлично.

[1 day ago]
Ну почему, в логи то идея не пишет, а тут на тебе, бери сравнивай, когда хочешь

Sergey Zhukov [23 hours ago]
как настроить чтобы логи теста писались в файл?


[23 hours ago]
А не пишет? Я если честно файл не проверял, как у компа буду, гляну


[23 hours ago]
в конфигурации логов для теста не указана запись в фаил.

Sergey Zhukov [23 hours ago]
только сейчас заметил у нас есть logback-test.xml ))

Vladimir Gorbatenko [22 hours ago]
что-то в ваших выводах не видно строки TOTAL TIME ) (edited)

Vladimir Gorbatenko [22 hours ago]
но в целом Жуков с Ансеем красавчики!

Ansseii [5 hours ago]
@Vladimir Gorbatenko
Так не было такой задачи)
3.3: вывод сводки в конце класса: имя теста - время выполнения.


Sergey Zhukov [5 hours ago]
даже больше скажу и не было задания логировать состояние теста, нужно только имя - время

[5 hours ago]
@Sergey Zhukov А как ты определял состояние successed в тестах где есть эксепшн?

[5 hours ago]
В вотчерах же на каждый результат теста есть метод для переопределения, успешный, проваленный, просто законченный (успешный или проваленный)


[5 hours ago]
есть, да, но когда тест ловит ошибку, и он успешный он почему то идет и метод фаилд

Sergey Zhukov [5 hours ago]
передавал в состояние из нужного метода
       ```@Override
        protected void succeeded(long nanos, Description description) {
            logInfo(description,"successed ", nanos);
        }```
в методе failed - соответственно "failed"
говорю по заданию - не требуется


[5 hours ago]
понятно что не трубеется) но у меня у двух в логах файлед, хотя в идее все зеленые)


Raisa [4 hours ago]
@Sergey Zhukov, @Ansseii как вы выводили в консоль все пары значений в одном логе? на столбцы разбивали через format? (edited)

Ansseii [4 hours ago]
@Raisa
Да, я задал формат строки через регулярные выражения. Затем результат по каждому тесту складывал в StringBuilder, а затем через @AfterClass просто вывел все содержимое билдера.



Sergey Zhukov [4 hours ago]
@Raisa в format вместо %s можно написать %20s значит под параметр выделится 20 символов строки , тоже в стрингбилдер писал (edited)


Raisa [4 hours ago]
спасибо! да, я формат так же сделала, но пробовала формировать строку по-другому, не через билдер - в этом была ошибка


Стецко Максим [2:15 PM]
у кого-нибудь может есть pdf Java Persistence API и Hibernate на рус?


Sergey Zhukov [Yesterday at 9:11 PM]
Кто-нибудь разбирался как работает merge ?
http://akorsa.ru/2016/07/kak-rabotayut-persist-i-merge-v-jpa/
оказывается он перед update делает select
Вопрос, нужно ли проверять свою ли еду меняет пользователь?
Блог Анатолия Корсакова
Как работают persist и merge в JPA - Блог Анатолия Корсакова
Введение При использовании JPA переходы между состояниями транслируются автоматически в SQL выражения. В этом посте я попытаюсь объяснить когда использовать persist и когда использовать merge. Persist Операция persist должна использоваться только для новых сущностей. В терминах JPA сущность является новой если она была еще связана с строкой в базе данных, это означает что не существует записи в БД …
Jul 25th, 2016 at 2:30 PM


33 replies
Taras [17 hours ago]
да, нужно.


Sergey Zhukov [17 hours ago]
да туплю, тест же не проходит :dizzy_face:


Andrey Tolkachev [17 hours ago]
у меня не проходят 2 теста: updateNotFound и getNotFound, всю голову сломал, выбрасывается javax.persistence.NoResultException. Метод сейв реализовал как раз через persist и merge, и видимо где-то не учел что-то (edited)


Taras [17 hours ago]
NPE?

Andrey Tolkachev [17 hours ago]
для updateNotFound выбрасываемое исключение не совпадает с ожидаемым, метод выделяется желтым в тесте, а в getNotFound вылетает NoResultException


[17 hours ago]
Чтобы получить NotFound нужно чтобы метод save в репозитории вернул null (edited)


Andrey Tolkachev [17 hours ago]
получается надо, чтобы merge вернул null, а по факту он говорит, что нет результата (edited)


[17 hours ago]
Как его заставить это сделать, если это не предусмотрено?)


[17 hours ago]
Надо самостоятельно делать все необходимые проверки и возвращать null, когда это требуется по нашей логике


[17 hours ago]
Я не придумал способа использования merge с нашей логикой, чтобы проверялся id юзера и все это одним запросом к базе (учитывая, что по подсказкам к заданию использование try-catch не желательно). Поэтому использовал обычный namedQuery (уже обсуждали это веткой выше), с помощью которого все это делается за один запрос к базе и логика эксепшенов никак не меняется.


Andrey Tolkachev [17 hours ago]
вот я тоже начал склоняться к этому варианту, поскольку юзер всегда присутствует. Все методы сделал как раз через namedQuery, кроме save, его хотел как раз с помощью persist и merge


Taras [17 hours ago]
Это будет не правильно с точки зрения задания. Я так сделал, но мне сказали переделать под merge. Да, придется за 2 запроса обновляться, обратная сторона медали jpa, как я понял…


[17 hours ago]
@Andrey Tolkachev с persist проблем нет


Andrey Tolkachev [17 hours ago]
да, юзер создается нормально, проблема с обновлением


[17 hours ago]
@Taras А жаль, такое решение выглядит эффективнее с точки зрения количества запросов к базе...


[17 hours ago]
@Taras То есть сначала селект, проверка, потом уже merge? (edited)


Taras [17 hours ago]
Ага

[17 hours ago]
:neutral_face:


Taras [17 hours ago]
Мне тоже больше “ручками” нравится. Больше контроля, тем более что SQL я неплохо знаю,


Taras [17 hours ago]
Есть хорошее видео Алименкова про оптимизацию Hibernate, там хорошо показано, как там легко получить совершенно неоптимальные запросы на ровном месте.


Sergey Zhukov [17 hours ago]
@Taras мне тоже сказали сделать без query
перед merge сделал проверку что get вернет не null

Andrey Tolkachev [17 hours ago]
@Taras видео весьма познавательное)) даже больше понятно стало



Taras [17 hours ago]
Да там прикол в том, что у них тесты не все случаи проверяют. Я в HW03 сделал “для себя” больше проверок.. :slightly_smiling_face:


[17 hours ago]
К примеру?


Taras [17 hours ago]
Ну, крайние варианты диапазонов, например. На этих крайних случаях я как-то частенько обжигался. Ну и нет проверки, а если еды такой в базе нет. Т.е. не чужая еда, а вообще нет, неправильно Meal сделано.


Taras [17 hours ago]
LocalTime.MAX тоже некорректно работает. Это значение в наносекундах, при записе в базу оно округлится до миллисекунд… и получится 0:00 следующих суток. Я “поигрался” с этим делом, дойдут руки, — напишу Григорию об этом. (edited)



Andrey Tolkachev [17 hours ago]
глубоко копнул)

Taras [17 hours ago]
У меня один программный комплекс почти 15 лет работает, в БД более 100 таблиц, столько же вьюх и под 200 процедур. Кое-какой опыт есть..  С этими крайними значениями, на первый взгляд очевидными, бывают удивительные неприятные “открытия“.
 


Sergey Zhukov [16 hours ago]
@Taras мы же не пишем в базу крайние значения, а фильтр я не представляю как можно сломать

Andrey Tolkachev [16 hours ago]
кстати починил тесты, все работает, спасибо всем за помощь :slightly_smiling_face:


Taras [16 hours ago]
Мы можем и написать. И юзер может. Один шанс на миллион… И иногда, рассматривая крайние случаи, ты можешь найти что-то интересное, оптимизировать, например. Короче, полезно..


Sergey Zhukov [16 hours ago]
то что он должен упомянуть это в курсе я согласен, а тут требования ниже к значениям


Taras [16 hours ago]
Это ж не сложно, в конце концов… Я с тестов начал HW01, например, мне так удобнее..


Rasikon [Today at 7:46 AM]
Всем привет. После накатки двух первых патчей в Init.db добавилась еще одна таблица meals. Ну это ладно я ее удалил. Перестали проходить тесты MealServiceTest кроме getNotFound, deleteNotFound и get. В ексепшионах ругается в основном на date_time то нулевое значение то не существует. У кого то было такое?


10 replies
Pavel Mikhalev [7 hours ago]
У всех, в скриптах раньше поле называлось datetime, а стало date_time. При накатке патчей не изменилось в идее название. Надо обновить подключение в идее и в классах написать что поле теперь date_time


Rasikon [6 hours ago]
вот что значит невнимательность. Спасибо большое. Теперь update и updateNotFound ругаются на userId


fibz [6 hours ago]
В проверке assertmatch  надо убрать поле user

Rasikon [6 hours ago]
это где именно ? что то недопонимаю

fibz [6 hours ago]
В MealTestData

Raisa [6 hours ago]
в логах теста можно посмотреть на какой строке и в каком классе падает тест


Rasikon [5 hours ago]
так там же в assermatch параметры только милы


Rasikon [5 hours ago]
вот такая ошибка org.springframework.dao.InvalidDataAccessApiUsageException: No value supplied for the SQL parameter 'userId': No value registered for key 'userId'


Rasikon [5 hours ago]
при update


Rasikon [3 hours ago]
проблема решилась надо было откатится и заново патчи накатить и произошла "магия") Все заработало. Спасибо.


Igor [Today at 12:47 PM]
Как можно раскрашивать логи?


2 replies
[2 hours ago]
https://logback.qos.ch/manual/layouts.html


Igor [2 hours ago]
Спасибо. У меня была даже открыта эта ссылка, просто не долистал до нужного места :joy: