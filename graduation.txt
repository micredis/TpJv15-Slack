Grigory Kislin [11:21 PM]
joined #graduation.

Grigory Kislin [11:40 PM]
Начиная с 4го занятия можнео приступать к выпускному проекту: https://github.com/JavaWebinar/topjava/blob/doc/doc/graduation.md
Обсуждение здесь. Свои решения НЕ публиковать!
Ревью проекта входит в участие с проверкой домашних заданий (*ревьюится один раз!*).
Отдать на ревью нужно до 09.01.2019 (если идешь на Masterjava, то срок до 31.03.2019).
Успехов! (edited)

Gekov Iliya [11:53 PM]
joined #graduation along with 17 others.


Gekov Iliya [Today at 1:03 AM]
@Grigory Kislin Есть ли возможность оплатить ревью только выпускного проекта?



6 replies
Ilya A. Kvyatkovsky [13 hours ago]
Тоже возник этот вопрос.


Zippospb [6 hours ago]
В прошлом выпуске так точно можно было сделать. Если хотели оплатить лишь ревью проекта, нужно было оплатить из личного кабинета интервью. В этот раз, думаю, будет так же


Grigory Kislin [1 hour ago]
да, есть такое. стоимость как и тестового собеседования - 1950р (edited)


Gekov Iliya [1 hour ago]
@Grigory Kislin Спасибо. А оплачивать через личный кабинет?


Grigory Kislin [1 hour ago]
да, или как тестовое интервью из личного кабинета javaops, либо другим способом: http://javaops.ru/view/payment (при этом отписаться мне) (edited)


Gekov Iliya [1 hour ago]
Понял, спасибо!


Илья Чиликин [1:48 AM]
joined #graduation.

Vitaliy Ivkin [12:19 PM]
Я правильно понимаю, что курсовой проект по сути на всех один и тот же, просто мы делаем его самостоятельно?


Ilya [Today at 12:22 PM]
а как же работа в команде?(


1 reply
Grigory Kislin [1 hour ago]
у работы  в команде, кроме плюсов навыка взаимодействия (что освоить несложно) есть большой минус- кажый делает только свою часть и имеет слабое представление про код остальных. поэтому к работе в команде можно переходить только после того, как освоил все технологии на проекте.


Dima [Today at 7:31 AM]
Так а можно пользоваться благами spring data jpa в связке с spring rest? Или делать все руками?


3 replies
Nikita Ganin [12 hours ago]
Я так понимаю вообще надо всем пользоваться, что изучили, и будем изучать.


Dima [12 hours ago]
Мы пока вручную имплиментировали доступ к базе,хотя со spring data это делается за секунду. И комментах кпроекту написано,что не надо плодить не нужных классов.


Nikita Ganin [9 hours ago]
Ну да, я имел ввиду что нужно использовать последние технологии


Zippospb [1 day ago]
Внимательно читайте пояснения к заданию. Там все написано


Grigory Kislin [17 hours ago]
spring data и spring-rest - будут, см. раписание.
если уже с ним знакомы- можно делать. если нет- лучше подождать занятие


Marat [Yesterday at 8:55 AM]
Начал создавать этот проект в IDEA. Но столкнулся с проблемой - как правильно создать проект? Сделать maven проект, потом добавить в него Web framework ? и потом все зависимости?


13 replies
Marat [1 day ago]
Мы ведь в topjava просто склонировали готовый


Taras [1 day ago]
Создай новый maven проект, добавь сначала зависимости в pom.xml, разреши импорт зависимостей, создай папку webapp там, где у нас, сделай web.xml , подключи в свойствах проекта фреймворки. Проверь на пустом пока проекте, что всё правильно — попробуй сделать package.


Taras [1 day ago]
Да, не забудь переписать их нашего pom кодировку и maven-compiler-plugin.


Marat [1 day ago]
Какого-то автоматического создания нет?


Andrey Tolkachev [1 day ago]
автоматически на Spring-Boot можно
https://start.spring.io/


Marat [1 day ago]
А через архетип maven-archetype-webapp


Marat [1 day ago]
Когда создаешь новый проект maven и потом добавляешь Web Framework, то создается папка Web в корне проекта. А у нас в topjava папка webapp и находится в main. Не пойму в чем разница


Dima [23 hours ago]
Лучше наверно разбираться со спринг бутом,он пользуется большей популярностью сейчас.


Marat [23 hours ago]
Возможно. Но там все упрощенно, все методы для ентити готовы. Думаю может сначала сделать без бута, а потом тоже самое с бутом


Dima [23 hours ago]
Не,ну там основное) методы тебе придется все равно добавлять,хотя тоже просто)


Taras [20 hours ago]
> А у нас в topjava папка webapp и находится в main. Не пойму в чем разница
Есть чётко определённая структура папок, которую требует _maven_: где что лежит, откуда брать ресурсы и куда всё в итоге попадает. Если ты собираешь проект не maven’ом, то и размещаешь где угодно. Для веб-приложений надо, чтоб было `src/main/webapp`, это стандартное размещение. Можно переопределить, но смысла в этом нет..


Taras [20 hours ago]
> А через архетип maven-archetype-webapp
Можно и свой архетип сделать. Но тут проект настолько маленький, что проще стандартно сделать и добавить пару зависимостей, чем разбираться, кто там что написал в стороннем архетипе. (edited)


Grigory Kislin [17 hours ago]
maven-archetype-webapp делает что-то очень древнее.
можно взять то, с чего начали topjava, только без Meal


Marat [7:04 AM]
Как правильно сделать таблицы БД ?
Я планирую так:
Пользователь, Блюдо, Меню, Ресторан и Ланч.
В Ланче сводные уже данные из ресторана и меню. А в меню блюда.


Zhinko [2 days ago]
А как ты будешь определять админ это или нет?


Zhinko [2 days ago]
Я планирую: юзер, роли, еда, ресторан(где будет id админа и Id меню), меню (id ресторана и id еды)


Zhinko [2 days ago]
может у кого-то еще какие-нибудь идеи есть?


Marat [2 days ago]
Как определять админа пока не знаю. А сам как будешь определять?


Marat [2 days ago]
Отдельную таблицу делать что-ли для админа? Но он же юзер на самом деле


Zhinko [2 days ago]
у тебя в топджава есть таблица user_roles, я подозреваю, что если здесь есть юзер и админ, то нужно сделать похожим образом


Nikita Ganin [2 days ago]
А зачем делать отдельно блюдо меню и ланч? У нас же только список с едой


Marat [1 day ago]
Поэтому советуюсь здесь с вами, чтобы понять правильно ли я понимаю или нет, как лучше


Nikita Ganin [Oct 29th at 2:27 PM]
В задании есть условие "меню меняется каждый день", т.е. если в новые сутки админ не вввел никакие данные, то собственно и голосовать не за что? Как кто понимает это?


15 replies
Taras [1 day ago]
Я понимаю так, что все данные о меню и голосовании «обнуляются» каждый день, то есть по мере наполнения базы информацией о меню в ресторанах появляется возможность за эти рестораны голосовать. Вчера было меню, а сегодня может и не быть.


Sergey Zhukov [1 day ago]
не обнуляется, голосовать за блюдо в ресторане можно не чаще раза в сутки


Taras [1 day ago]
Речь об этом: каждый день начинается с чистого листа. Ты голосуешь за один день, а в следующем новые данные по ресторанам и меню.


Ilya A. Kvyatkovsky [1 day ago]
Сегодня *29.10.2018*: *Юзер* заходит в апп -> Видит _список ресторанов у которых *есть ланч-меню на сегодня*_ -> Открывает меню ресторана ххх -> Видит *список еды* этого *ресторана* на *сегодня* -> Голосует или нет. (Если у ресторана нет ланч-меню на сегодня, то юзер не увидит этот ресторан в списке и не сможет проголосовать) По рекомендациям, представил весь процесс с точки зрения Админа и Юзера, все возможные действия расписал схематично. Проект получается аналогичный тому, что мы делаем с Григорием. У меня получается 5 таблиц (USERS, ROLES, RESTAURANTS, MENU, VOTES). Не нашел вариант как запаковать поплотнее. (edited)


Marat [1 day ago]
А в таблице MENU как блюда делить? Не нужно разве отдельную таблицу с блюдами?


Marat [1 day ago]
В MENU будет id ресторана к каждому блюду?


Marat [1 day ago]
Я думал что меню статично и Админ его редактирует. Пока не поменяет - ничего не измениться
Menu changes each day (admins do the updates) (edited)


Ilya A. Kvyatkovsky [1 day ago]
В таблице MENU вся еда всех ресторанов. date_time/restaurant_id/dish_name/dish_price
Вот только не могу понять нужно ли поле ID для этой таблицы.
Рекомендация № 13 - нужно хранить историю еды. (edited)


Marat [1 day ago]
А в VOTES будешь хранить id юзера, ресторана и меню?

Ilya A. Kvyatkovsky [1 day ago]
дата_время голосования/user_id/restaurant_id
голос как я понимаю отдается ресторану за его меню (edited)


Marat [1 day ago]
Ну как я понял это не голосование, а бронирование своего обеда на сегодня. Или не так?


Ilya A. Kvyatkovsky [1 day ago]
Да, очень похоже, с небольшими оговорками по структуре и функционалу.

Ilya A. Kvyatkovsky [1 day ago]
Это субъективно мои предположения и я бы не рекомендовал следовать им, т.к. мой опыт СУБД ограничен исключительно школьной программой 10-ти летней давности.


pro [21 hours ago]
@Ilya A. Kvyatkovsky десять лет назад в школе преподавали управление базами?.. Где эта школа, я хочу на нее посмотреть, (сквозь слезы) хотя бы через гугл мап


Ilya A. Kvyatkovsky [20 hours ago]
@pro не понимаю что тут удивительного, школы все разные и преподаватели в них тоже разные, а на дополнительных занятиях рассказывают немного больше чем обычно.


Zhinko [Yesterday at 4:21 PM]
Давайте подумаем как лучше сделать БД. Вот что у меня получилось. Жду предложений.
PUBLIC.png



24 replies
Marat [22 hours ago]
Почему ID ресторана находится в еде?



[22 hours ago]
я в таблицу ресторана добавил поле "дата обновления", чтоб потом использовать его в выдаче списка ресторанов с обновленным меню именно нужного дня. Остальное сделал через таблицы меню и еда. К security и голосам пока не подходил, играюсь пока с выводом нормального jsona


[22 hours ago]
@Marat видимо потому, что потом будет использовать ManyToOne аннотацию


Marat [22 hours ago]
Не наоборот должно быть? В ресторане еда


Zhinko [22 hours ago]
Тогда у тебя будут строки в ресторане повторяться так как ресторан один а еды много


Chensy [22 hours ago]
У меня почти также, только вот зачем в USERS поле VOTED ?


Zhinko [22 hours ago]
Типо поле проголосовал юзер или нет


Chensy [22 hours ago]
Зачем? ты это поле что постоянно менять будешь? эта инфа же есть в таблице VOTES


Zhinko [22 hours ago]
А как тогда сделать так , чтобы юзер мог голосовать только один раз , а не сколько хочешь раз?


Chensy [21 hours ago]
Ограничение DATE+USER_ID в таблице VOTES как вариант



Zhinko [21 hours ago]
В принципе да, ты права, я об этом не подумал)


[19 hours ago]
Когда пытаешься достать ресторан посредством JPA, ругается на то, что отсутствует передаточная таблица ресторан_меню. Как можно вытащить меню из ресторана без этой таблицы?


[18 hours ago]
Почему в JPA есть дофига Query методов для таблицы, но ниодной для обьединения таблиц (JOIN)


Sergey [18 hours ago]
схема на рис. верная, проверяй как ты достаешь ресторан )


Sergey [18 hours ago]
Есть join, вот пример:  https://stackoverflow.com/questions/5478328/jpa-jointable-annotation
Stack Overflow
JPA "@JoinTable" annotation
In which case do you use JPA @JoinTable annotation?
 


[18 hours ago]
та это понятно, я имел в виду что то типа метода findAllRestaurantJoinMenu()


[18 hours ago]
но да, получается я туплю. Когда я достаю ресторан методом findById(Long id) , то с рестораном подтягивается еда. А если findAll(), то нет. какая то мистика, где то закралась ошибка


Sergey [18 hours ago]
Вытаскивать все из 2х таблиц и еще и join-ить очень накладно. Вот hibernate тебя и не слушает ))

[18 hours ago]
ща удалил связующую таблицу ресторан_меню и он отказывается доставать.

[18 hours ago]
111111.jpg



[18 hours ago]
с таблицей связи все ок, даже без всяких @JoinTable


[18 hours ago]
а если хранить отдельно ресторан, отдельно еду, и отдельно сушность еда ресторана?


[18 hours ago]
также отдельно юзером и таблицу за какой ресторан проголосовали юзеры

Marat [4 hours ago]
А у юзера не должно быть email ? Как он будет регистрироваться?


Grigory Kislin [Oct 31st at 9:49 PM]
опрос- не кто не против выкладывания тут готовых решений? не мешает разрабатывать самостоятельно?
 


13 replies
Dima [1 day ago]
ну если не обсуждать свои решения, то смысл вообще в канале) не против


Gekov Iliya [1 day ago]
Мне кажется это лишним, как то чистота эксперимента по проверке своих способностей теряется. Можно обсудить после 09.01 кто как сделал. С другой стороны можно просто отписаться от канала, если нет желания смотреть чужие решения


[1 day ago]
с толку сбивают чужие мысли ) я стараюсь не вникать, буду использовать как "прогресс-бар", чтобы не отставать  :relaxed:
надо было правила что ли придумать заранее, - типа "только вопросы к администрации по пунктам задания, реализация - только в личку"


Gekov Iliya [1 day ago]
Согласен


[1 day ago]
чо пальцы ставим кто  против решений - :-1:


Dima [1 day ago]
:call_me_hand:


Dima [1 day ago]
это типо пофиг)
 


Ilya A. Kvyatkovsky [1 day ago]
Выкладывать готовые решения, безусловно бесполезно для всех кто хочет действительно научиться самостоятельно разрабатывать подобные проекты, а вот если ты в тупике или не знаешь какое решение принять, то думаю, что если ребята накидают своих мыслей, то это реально поможет сдвинуться с мертвой точки. (по себе знаю)). Ну а дальше каждый сам решает какая степень знаний ему нужно, все делать с чужой помощью или полностью самостоятельно. Я бы не прочь получить еще штучек 5 подобных ТЗ, что бы отточить навыки.)  (хотя у самого проект пока процентах на 5-10 :stuck_out_tongue_winking_eye:)


Marat [1 day ago]
Смысл запрещать нет, так как на работе все равно консультируешься с колегами как все-таки правильно сделать. Тот же Слак, только живой


Nikita Ganin [1 day ago]
Одно дело когда ты сам задаешь вопрос, а другое когда просматривает чужие решения. Может просто не стоит выкладывать свое решение, чтобы его оценили. (edited)



YuriyUh [1 day ago]
Максимум вопрос и ответ где почитать, все остальное действительно сбивает с толку.



Andrey Tolkachev [1 day ago]
я согласен с @Ilya A. Kvyatkovsky, не вижу никаких проблем в выкладывании своего решения. Здесь ведь никого из под палки не заставляют учиться и делать проект) Если человек хочет сделать сам, то он и не будет смотреть, или просто отпишется на время. Ну а если есть затык в каком-то месте, то общая группа в этом плане может сильно помочь. Имхо, каждый сам решает, работает он над собой, или просто занимается копипастом :slightly_smiling_face:


Andrew Kalugin [1 day ago]
Я не против. Если ты хочешь сделать все сам, то просто не читай. Если решил все скопировать, то смысл вообще тут учиться? @Andrey Tolkachev согласен, иногда нужен совет, что бы сдвинутся с мертвой точки, а группа может помочь.


Yesterday at 7:44 AM]
имеет ли значение какую СУБД выбирать для проектов в портфолио, чтобы удобно было смотреть работу приложения? наверное, лучше локальную вроде hsqldb? вы делали на hsqldb или на postgers?


1 reply
Gekov Iliya [1 day ago]
В подсказках про это сказано


Grigory Kislin [10:09 AM]
@here
*Коллеги- по опросу - свои решения  НЕ выкладываем. Когда мне задают вопрос- я стараюсь дать полезные ссылки или совет, но чтобы человек дошел до ответа самостоятельно. Учимся думать. Отписаться от канала - не вариант, тк здесь все таки оказываем такого рода поддержку. Можно сделать собственный канал или чат (права есть) и делится решениями там, для тех, кто не против.* (edited)


Marat [Yesterday at 5:44 PM]
Все таки лучше делать глобальный сиквенс или для каждого энтити свой?


2 replies
Marat [23 hours ago]
Вроде бы когда пишут на процедурах в базе данных, то делают для каждого свой сиквенс.
А когда пишут в Java приложении, то как обычно делают? Один глобальный или нет?


Grigory Kislin [5 hours ago]
скорее тут нет как обычно. и как лучше. вроде в занятии была ссылка на + и - (edited)


Raisa [Today at 7:55 AM]
а если в restaurants сделать строку с блюдами и перечислять их через ;, к примеру. Когда они будут нужны просто выделять нужные подстроки. Т.е. не делать отдельную таблицу с едой. Нам ведь нужны только название и цена.


18 replies
Dima [10 hours ago]
Почитай про так называемые нормальные формы таблиц. Перечислять как ты говоришь bad practice, очень бэээд)) доставать из таблицы инфу очень муторно. И если хратить информацию по голосованиям,то возможно придется хранить инфу по еде.А ее тысячи (edited)



Gekov Iliya [9 hours ago]
А еще по тз нужно хранить историю всех ланчей


Raisa [9 hours ago]
я читала и насколько поняла, суть нормализации как раз в том, чтобы предотвратить избыточность данных )  разве 2-5 блюд в день сильно муторно выводить? голосование же не за еду, а за ресторан? еда ведь нужна только для того, чтобы понять интересен ресторан или нет?


Gekov Iliya [9 hours ago]
IMG_20181106_090323.jpg



Dima [9 hours ago]
Ну вот ошиблась ты в цене на еду,она у тебя записывается в строчку,одна за одной,чтоб поменять тебе надо достать всю еду ресторана,потом в ней найти нужную еду,короче это гемор


Gekov Iliya [9 hours ago]
Как хранить в таком случае историю еды? В виде бесконечного стринга? А как разделять название еды и его стоимость? Если это делать через строчку, то тот кто будет писать фронт не сможет сформатировать вывод, он будет вынужден нарисовать фронт так как заложено у вас, а не так как хочет к примеру заказчик (edited)


Sergey Zhukov [9 hours ago]
Закладывай сразу возможность вытаскивать отдельно еду каждого ресторана с помощью запроса к базе. Если это парсинг ячейки - уже должно насторожить


Raisa [9 hours ago]
@Dima если админу нужна возможность доставать по частям - цену, название и т.д, то да, нужна отдельная таблица


Gekov Iliya [9 hours ago]
Это не говоря уже о том, чтобы предусмотреть возможность расширения, к примеру добавления фото еды, состава и т.п.


Raisa [9 hours ago]
@Gekov Iliya говорили не додумывать ) не всегда пока понятно, что является додумыванием, а что нет :woman-shrugging:


Raisa [9 hours ago]
насчет хранения истории еды я не совсем поняла, что имеется ввиду - хранить именно блюда из ресторана или рестораны, где обедали? я склоняюсь к тому, что рестораны. возможно, ошибаюсь


Dima [9 hours ago]
Конечно надо ему доставать) онбудет у себя в javascript писать расположение цены,еды как обьекты. Точно так же как мы в jsp писали



Gekov Iliya [9 hours ago]
На вырезке что я скинул как раз об этом и говорится, что есть базовые вещи а есть неочевидные додумки, рассмотреть разные возможности обращения к данным и расширяемость этих данных - это базовая архитектура


Raisa [9 hours ago]
ок, спасибо! что-то проясняется (edited)


Gekov Iliya [9 hours ago]
Но это в любом случае только наше имхо)


Raisa [6 hours ago]
я поняла: история еды - это дата + выбранный ресторан + еда в данном ресторане в этот день. Так? Список ресторанов статичен, если админ его не меняет, а еда во всех ресторанах каждый день обновляется


Gekov Iliya [6 hours ago]
Да, мне кажется именно так


Grigory Kislin [5 hours ago]
реляционные базы данных- достаточно стандартизированная вещь. И там хранить списками- бывает, но совсем не часто и для особых случаев. В данном случае еда- это конечно же отдельная таблица. Она будет обрастать со временем картинками, описанием и пр..


Zhinko [Yesterday at 1:04 PM]
Вопрос. Нужна ли нам таблица в БД menu? По сути мне кажется, что не нужна если еду можно доставать сразу из таблицы еды.


5 replies
Gekov Iliya [1 day ago]
Я думаю также, если понадобится в дальнейшем можно это сделать в виде ТО


Dmitry Neustupov [18 hours ago]
т.е. у каждой записи в таблице еда будут поля, какому ресторану она принадлежит и дата, к которой эта еда привязана? соответственно у вас будет десять разных яблок к разным ресторанам на разные даты? или есть другие способы реализовать историю меню у ресторанов? ) не проще сделать меню с этими полями и наполнять едой?


Gekov Iliya [18 hours ago]
А что подразумевается под наполнять едой? В каком виде будет еда? Без отдельной таблицы, просто списком текста? В таком случае нет, не думаю, что это проще, такой вариант уже обсуждался выше в ветках


Dmitry Neustupov [18 hours ago]
Есть рестораны(таблица) - у ресторанов есть меню(таблица) - у меню есть еда(таблица).  Ведь в разных ресторанах в разные даты может быть одна и та же еда? Не читал выше каменты, сори, не знаю о чем речь была )


Grigory Kislin [16 hours ago]
можно дату располагать в таблице еды, тогда меню не нужна. а еще лучше сделать еду как справочник...


Dima [Yesterday at 5:41 PM]
а можно пример как пишется readme фаил ? тупо url -> что делает запрос?


1 reply
Grigory Kislin [16 hours ago]
https://github.com/JavaWebinar/topjava/blob/master/README.md (edited)


Dima [Today at 2:03 PM]
появился вопрос по поводу загрузки дополнительных данных при обращении к базе: есть ресторан, у него допустим есть колекция еды, с Fetch.Lazy. Делаю простое ображение к базе select r from Restaurant r where r.id=?1 и вижу, что кроме листа ресторанов подтягиваются листы еды этих ресторанов. Такое вроде бы не должно быть?


3 replies
Gekov Iliya [5 minutes ago]
Прям в обе таблицы запрос идет?


Dima [2 minutes ago]
да, два select, как будто Eager стоит


Gekov Iliya [1 minute ago]
Вроде не должно, сейчас гляну как у меня такой запрос проходит


Marat [Today at 2:05 PM]
Если у меня Votes имеет внешние ключи к Restaurants и Users, то В репозитории сохранения голоса нужно указывать все 3 параметра? Vote, restaurant_id, user_id


1 reply
Dima [< 1 minute ago]
в репозитории можно ничего не указывать, предварительно записав в обьект нужные данные:
```Vote vote = new Vote(); vote.setRestaurantId(restId); vote.setUserId(userId); voteRepo.save(vote);```


Maxim [Yesterday at 10:55 PM]
Кто как планирует\сделал работать с бд: Spring data, Hibernate, JPA?


1 reply
Dima [12 hours ago]
у меня все через spring data, но чувствую все придется через @Query делать, потому что много запросов к базе.


Grigory Kislin [3 days ago]
рекомендую spring-data-jpa


Maxim [3 days ago]
spring data все таки легче чем чисто JPA, может "хлебнуть горя" и получить больше опыта с entitymanagerfactory? или это впоследствии не нужно?


Grigory Kislin [1 day ago]
в тестовом на работу я рекомендую юзать spring-data-jpa


pal548 [Nov 9th at 11:48 PM]
Все ли знают про диаграмму сущность-связь? Помогает при проектировании БД


6 replies
Alexey_b [2 days ago]
не, не встречался раньше, положу в закладки


Sergey Zhukov [1 day ago]
@pal548 есть ссылка с хорошим материалом?


pal548 [1 day ago]
неа, я с института помню. Я щас посмотрел, все предлагают непростые диаграммы, а я делаю просто сущности и связи линиями


pal548 [1 day ago]
Вот пример, тут все линии один-ко-многим. Многие-ко-многим будет соответственно линия с "вилкой" на обоих концах
IMG_20181111_002322.jpg



Gekov Iliya [1 day ago]
Эту диаграмму же идея строит, не?


pal548 [20 hours ago]
Ну смысл в том, чтобы начать проектирование БД не с создания таблиц, а с этой диаграммы. Идея строит диаграмму по сущностям?


Ilya A. Kvyatkovsky [Nov 10th at 1:57 PM]
jar или war? По ТЗ не могу однозначно определить. Думаю что jar но не уверен. Может кто объяснить как по нашему условию можно определить тип приложения? (edited)


5 replies
Zhinko [2 days ago]
Тут же вроде написано
P.P.S.: Asume that your API will be used by a frontend developer to build frontend on top of that.


Zhinko [2 days ago]
Судя по описанию мы делаем веб приложение


Стецко Максим [1 day ago]
как я понял бы делаем бекэнд, а что будет фронтом это уже на усмотрение (API же можно пользоваться и вебом и настольным приложением). Я вообще буду фронт на JavaFx пилить, он только на 11 java отъехал в отдельную библиотеку, но хочу на нем делать и все)


Grigory Kislin [1 day ago]
@Ilya A. Kvyatkovsky а как ты хочешь jar  делать?


Sergey Zhukov [1 day ago]
@Ilya A. Kvyatkovsky
Есть способ сделать *jar* - использовать SpringBoot.
Если Hibernate/Spring/SpringMVC - делаем *war*.


Lamekhova Alisa [Today at 9:11 AM]
Получилась вот такая схема. Чего не хватает?


8 replies
Lamekhova Alisa [7 hours ago]
unnamed.jpg



Lamekhova Alisa [7 hours ago]
Нужно ли поле что-то типо рейтинг ресторана?


Zhinko [5 hours ago]
Даты в еде. Тебе же нужно историю еды хранить


Zhinko [5 hours ago]
Что значит поле in-menu в meals?


Lamekhova Alisa [4 hours ago]
in menu - админ будет выставлять тру, если блюдо входит сегодня в меню, по умолчанию будет фолс


Lamekhova Alisa [4 hours ago]
Точно, даты в еде, 4 раза перерисовала схемку и забыла даты в еду перенести)


Zhinko [3 hours ago]
@Lamekhova Alisa смысл в in menu?. Ты будешь доставать значения из базы чтобы только тру на фолс поменять?


Zhinko [2 hours ago]
Как я понял согласно условию меню меняется каждый день. Ты можешь достать еду из базы совпадающую с сегодняшней датой. Эта еда и будет входить в сегодняшнее меню


Lamekhova Alisa [21 hours ago]
Блин да, это лишнее(


Lamekhova Alisa [Today at 9:51 AM]
В MealRepo есть метод Meal get(int id, int userId); // null if meal do not belong to userId. В своем проекте делаю аналогичный, но в нем ведь не надо проверять принадлежит ли еда к ресторану? Т. е. он просто может гетать еду по id, как в UserRepo


1 reply
Grigory Kislin [1 hour ago]
если еда привязана к ресторану то надо проверять


Lamekhova Alisa [Today at 10:37 AM]
И еще вопрос: в методах типо                                                                      //Get all votes for the restaurant, null if restaurant not found
List<Vote> getAllRestaurantVotes(int restaurantId); лучше возвращать null если ресторан не найден или кидать что-то вроде NotFoundException?


3 replies
Dima [4 hours ago]
Я втаких методах возвращал Optional<Vote> и всамом сервисе получаю List<Vote> voteRepo.getAll(rest).orElseThrow new Exception


Dima [4 hours ago]
И сделал ExceptionHandler,который перехватчвает все мои исключения и отправляет ответ от спрвера красивый


Grigory Kislin [1 hour ago]
1. return List - никогда не возвращай null, всегда пустой список
2. если restaurantId передан с ошибкой- то это ошибка входящих данный, требуется эксепшен


Lamekhova Alisa [3 days ago]
Спасибо за ответы, все встало на места)


lifter4ik [Nov 13th at 6:52 PM]
Что вообще подразумевается под историей? Ведение лога не будет достаточным, что такой-то юзер проголосовал за такой-то ресторан в такое-то время?


18 replies
Gekov Iliya [3 days ago]
Нет, лог нужен разработчику, а не пользователю приложения. Думаю, подразумевается, что, возможно, в дальнейшем появится необходимость предоставить админу возможность просматривать историю, либо предоставить юзеру возможность посмотреть за что и когда он голосовал и т.п. Если это не заложить сразу в основу архитектуры, то придется перелопачивать все приложение для добавления функционала (edited)


lifter4ik [3 days ago]
Тогда получается для этого отдельная таблица нужна по типу Дата, Пользователь, Событие? Не пойму как эту историю увязать в общую картину...


Gekov Iliya [3 days ago]
Не обязательно, достаточно, к примеру, сохранять в таблице еды дату и ресторан - этого будет достаточно для истории еды. И, к примеру, ввести таблицу для голосования, которая будет выполнять две функции - собственно сохранять историю голосования (не забываем про то, что по ТЗ юзер может изменить свой голос, соответственно нам априори надо сохранять в базе его голос) и служить средством подсчета итогов голосования.


Gekov Iliya [3 days ago]
Но варианты могут быть разные, это лишь мое имхо)


lifter4ik [3 days ago]
Подумаю, спасибо! А по поводу блюд в ресторане, мне кажется, что меню-то может миксоваться, в том плане правильно ли закреплять конкретную еду за конкретным рестораном на текущий день? Я смотрю больше в сторону отношения многие ко многим. Кофе например во всех будут подавать))


Gekov Iliya [3 days ago]
Лично мне кажется это слишком сложным. Кофе в одном ресторане это все же не кофе в другом ресторане, тем более если уж так рассуждать, то кофе тоже может быть десятков разных видов. Опять же, если думать о расширяемости в дальнейшем, то предположим, что мы добавляем к еде изображения, состав и т.п. Тогда одно и то же по названию блюдо все равно будет отличаться в двух разных ресторанах. (edited)


Gekov Iliya [3 days ago]
С другой стороны можно сделать еду в виде какого-то каталога, из которого админ может выбирать, либо если блюдо новое и отличается - добавлять новое в список. В общем вариантов на самом деле масса


lifter4ik [3 days ago]
Да, многие ко многим лишнее. Просто каталог побогаче сделать))


lifter4ik [3 days ago]
С ролями тоже думаю, тут по тредам все в отдельную таблицы их отправляют как у нас на обучающем проекте. Но там юзер может быть и админом и пользователем обычным одновременно. А тут в тз же четко, есть админы, есть обычные. Так не лучше роль сразу хранить в таблице users?


Gekov Iliya [3 days ago]
Возможно, как то не задумывался об этом


lifter4ik [3 days ago]
А самое для меня пока непонятное, как нам работать со временем... До 11, после 11, новый день... В реале легко представить: админы встали в 7 утра, меню накидали, пользователи тыкают голоса. Потом дружно идут в один ресторан (коммуна прям какая-то). А как тестировать приложение не понятно. Часики системные подправлять?)) Или в каждом методе время устанавливать


Lamekhova Alisa [3 days ago]
Блин и правда, не нужна тут получается таблица с ролями?


lifter4ik [3 days ago]
Ну вот попробовав учесть историю и отсекая все лишнее, такую картину нарисовал
IMG_20181113_215920.jpg



Lamekhova Alisa [3 days ago]
А есть смысл меню в отдельной таблице делать?


lifter4ik [2 days ago]
На этой структуре я еду представляю как справочник, что бы там не было повторов. А меню будет хранить историю


Pushkin [1 day ago]
Друзья! Григорий вроде говорил сделать историю голосования, а не блюд в меню. Я тоже сделал как на картинке у Лифтерчика, только menu и dishes у меня в одной таблице dishes. Dish имеeт дату создания, restaurantId, price. А история голосования тогда просто из votes выбирается.


Gekov Iliya [1 day ago]
@Pushkin вопрос не в истории меню, а в том, что при таком варианте каждая еда уникальная. Но если представить реальную ситуацию, то сомнительно, что в одном и том же ресторане блюдо в меню не будет повторяться, скажем через неделю. Для того, чтобы можно было выбрать еду из уже существующего списка еды и создается разделение на сам список еды и меню на конкретный день. То есть еда представлена как справочник - об этом Григорий так же говорил в одном из тредов.


Gekov Iliya [1 day ago]
@Pushkin кстати, смотрим пункт 13 подсказок: Историю еды и голосований сделать НУЖНО!... Так что речь шла не только об истории голосований (edited)


Lamekhova Alisa [Nov 14th at 10:57 AM]
Есть смысл делать интерфейсы репозиториев и сервисов в выпускном проекте или можно сразу классы делать? Я понимаю зачем это надо в первом проекте, но зачем тут они нужны непонятно. Или это правила хорошего тона? Или задел на будущее?


4 replies
Dima [2 days ago]
Тогда может получится слишком "толстый контроллер". Это и бизнес логику в нем писать придется,и обработку валидации и тд. Слой сервиса я делал и в нем уже все настраивал,вытаскивал из базы


Lamekhova Alisa [2 days ago]
Я имею в виду интерфейс сервис и имплементация сервиса, то же самое с репозиторием. Мб сразу класс сервис делать без интерфейса? В проекте разные имплементации репозитория, поэтому нужен интерфейс, но в выпускном проекте наверно не нужно это? Или так просто принято ?


Dima [2 days ago]
Для тестового задания,как написал Григорий,надо делать только точто используешь



shomnest [2 days ago]
@Lamekhova Alisa ооп и паттерны ооп, это всегда много дополнительного кода, который в совокупности привносит гибкость и расширяемость.


Ilya A. Kvyatkovsky [11:55 PM]
Глупый Battle
Если делать интерфейс наследующий JpaRepository<T, ID> и назвать его например "MealRepository", то при попытке воспользоваться имплементацией метода save(S entity) вылетает java.lang.StackOverflowError.
Об этом вероятно в лекциях где-то говорилось, но решение оказалось простым и не очевидным, если не знать что, интерфейсы наследующие JpaRepository<T, ID> должны именоваться начиная со слова "Crud" те в моем случае "CrudMealRepository", после чего метод save() чудесным образом все отрабатывает. Есть где об этом информация? (edited)

Grigory Kislin [3:09 PM]
> при попытке воспользоваться имплементацией метода save(S entity) вылетает java.lang.StackOverflowError.
если деграть самого себя - то будет StackOverflowError. почитать скорее про рекурсию


Ilya A. Kvyatkovsky [Nov 17th at 3:11 PM]
Вопрос по поводу условия *without frontend*.
Веб морды вообще никакой не должно быть? Если да то о каких *curl commands* идет речь? Как и где их применять?
Либо, подразумевается примитивный веб интерфейс, чтобы продемонстрировать работу приложения? Кто как понял, поясните, я определенно чего-то не понимаю.


14 replies
Sergey Zhukov [8 days ago]
вроде как фронт не делаем, я сделаю самый примитивный, чтоб видеть с точки зрения пользователя, где косяки


Zhinko [8 days ago]
Типо имеется ввиду фронт на уровне админки чтобы проверить работу приложения


Dima [8 days ago]
я проверяю в Postman



Dima [8 days ago]
можно добавить в зависимости spring-rest-hal-browser, тогда можно смотреть адекватно в браузере весь свой рест


Dmitry Neustupov [8 days ago]
SoapUI и Postman хорошо помогают


Sergey Zhukov [8 days ago]
SoapUI или Postman тут будут на проекте?


Dima [8 days ago]
так а что там не понятно, устанавливаешь, да вбиваешь нужные урлы)


Sergey Zhukov [8 days ago]
а я то думал что там используют на конференциях Евгений Борисов и его друзья ) оказывается Postman


Dima [8 days ago]
Борисов вроде Rest не показывал


Sergey Zhukov [8 days ago]
с Толкачевым в каком видео точно было


Sergey Zhukov [8 days ago]
или про железный банк или про spring boot test

Sergey Zhukov [8 days ago]
а вот тут на 25:49
https://www.youtube.com/watch?v=KABC7Fty3x8
YouTube JUG .ru
Барух Садогурский, Евгений Борисов — Приключения Сеньора Холмса и Джуниора Ватсона
 


Ilya A. Kvyatkovsky [8 days ago]
)) Им осталось написать какую-нибудь РПГ по мотивам Spring.


Grigory Kislin [6 days ago]
без фронта- это значит без UI вообще
в topjava мы будет делать REST контроллеры, тестировать их и  дергать.
postman и  в idea счас очень удобный Tools->HTTP Client-> HTTP Request ... (edited)


Vladimir Gorbatenko [Nov 18th at 12:55 PM]
А вы тоже в своем проекте много лишнего сделали, и понимаете что как минимум 60% нужно будет отчекрыжить из проекта? ))


1 reply
Dima [7 days ago]
я его уже третий раз переписываю, в зависимости от нарытой информации)


Dima [Nov 19th at 3:52 PM]
кто нибудь нарыл нормальных ссылок , кроме документации, по spring rest? и еще вопрос: почему, когда пишешь @Query запрос в репозитории с join они нифига не работают? только после @Entity Grath они начинают работать. Подскажите ссылочки по этим темам


30 replies
Dima [6 days ago]
в частности меня интересует: есть спринг-рест, я делаю @Projection интерфейс допустим на еду, и говорю что будет показываться имя и стоимость. Однако, когда я хочу отображать ресторан с едой, то этот интерфейс уже не работает, и еда в ресторане показывается всеми полями(можно убрать @JsonIgnore). Но если ставить игнор, то при записи у меня эти поля notnull и следовательно я не могу записать уже еду. Можно ли как то в @Projection указать, для каких url будет он работать? (edited)


Grigory Kislin [6 days ago]
1. По spring rest в этот четверг занятие будет
2. Query-как не работает? У нас в CrudMealRepository.getWithUser пользуется


Dima [6 days ago]
ну хз как) может у меня кривые руки))буду разбираться. Но я уже удалил тот код, как к этому подойду, буду внимательнее


Grigory Kislin [6 days ago]
С прожекшен не работал, а вот запись-чтение можно через @JsonProperty(access=) настраивать. Будем делать



Grigory Kislin [6 days ago]
Может fetch забыл?


Dima [6 days ago]
наверняка! но не помню)


Dima [6 days ago]
Григорий, раз ты уже тут, ответь на такой вопрос: я пробовал делать два joina в @Query, и при этом получал дублирование данных первого joina. То есть он находил рестораны (с distinct) , потом еду (дублированную), а потом голоса. Как с этим бороться?


Gekov Iliya [5 days ago]
@Dima Если правильно понял суть вопроса, то вот у меня к примеру такой вариант есть с двумя джойнами: "@Query("SELECT r FROM Restaurant r LEFT JOIN FETCH r.menuDishes m LEFT JOIN FETCH m.dish WHERE r.id=?1")"  Достается без дублирования


Dima [5 days ago]
у меня запрос примерно такой
```select r from Restaurant r join fetch r.dishes d join fetch r.votes v where d.created=?1 and v.created between ?2 and ?3```


Dima [5 days ago]
то есть я плюсую талицы относительно одного ресторана, а в твоем примере ты плюсуешь последовательно

Gekov Iliya [5 days ago]
Посложнее запрос конечно получается, я в ресторан не стал добавлять список голосов


Gekov Iliya [5 days ago]
Хотя может и стоило


Dima [5 days ago]
ну я ща все переделываю, пока с дублированием не сталкивался, вероятно и я где то не то написал. Я добавил голоса в ресторан, потому как потом очень удобно через стрим вытащить среднее арифметическое всех голосов за этот день по этому ресторану


Gekov Iliya [5 days ago]
Опять же вопрос в API и в том, что понадобится фронту. Мне кажется в плане отображения ресторанов для юзера, к примеру в таблице, хватит и простого кол-ва голосов. Простое кол-во я к примеру достаю из БД с помощью countAllByRestaurantId... и т.д.


Dima [5 days ago]
ну я за голос принял обьект, у которого есть некий рейтинг (типо звездочки на фронте под картинкой) , и когда юзер кликает по определенному количеству звездочек, то в базу идет запрос на добавления голоса, с рангом допустим 30 (3 звезды). Потом когда фронт достает ресторан, он получает среднее значение всех голосов и рисует уже сколько звезд у данного ресторана


Gekov Iliya [5 days ago]
Ух, это уже логика посложнее чем в ТЗ) Вообще в голове куча мыслей как это будет отображаться, какие данные понадобятся фронту и т.р. и учитывая, что фронт мы не пишем, не понятно до конца как определить, что потребуется, а что нет...


Dima [5 days ago]
ну я уже скачал себе книгу по Ангуляру, на udemy курс заказал, просто так я этот проект не оставлю на уровне реста. А потом еще под адроид допилю)))


Gekov Iliya [5 days ago]
Это понятно, когда сам пишешь фронт, ты сам видишь, что тебе надо получить и на основе этого допиливаешь сервисы, но вот задача написать так сказать универсальный рест, с точки зрения того, что фронт будет писать другой человек, у которого представление о том, как все должно выглядеть может быть совершенно другое, пока что ставит в тупик. Мне кажется я 90% времени трачу на обдумывание нужна ли та или иная фишка в сервисе или нет)


Dima [5 days ago]
так в моем случае фронт должен знать только что рейтинг от 0 до 100 (от плохого к хорошему). А так приходит среднее арифметическое голосов, хочешь конвертируй в слово "хорошо" или "не советую", хочешь в звездочки.


Dima [5 days ago]
я сужу по себе, я никогда не могу оценить какую либо услугу просто "да" или "нет". Я говорю "да но..." ))


Gekov Iliya [5 days ago]
А рейтинг в таком случае представлен как поле в энтити ресторана (или к примеру в ТО ресторана, как у нас MealTo) или это просто отдельно посылаемое в ответ на запрос число?


Dima [5 days ago]
я впервый раз делал с помощью Spring HATEOAS, там есть как бы отображения, которые будут выдаваться в ресте, и вот там можно в отображения кидать че угодно из того, что ты достал в базе. Это по мотивам книги Spring in Action 5, которая новая. Ща я делаю второй раз через чистый Spring Rest с тем же hateoas, только пользуюсь типо этим api, без ручных преобразований. У ресторана просто List<Vote>, который я выкачиваю вместе с едой. А вот потом я пробегаюсь по этому листу, в итоге, вычисляя рейтинг, и отдаю его на отображение. Эти отображения наверно можно назвать TO.


Dima [5 days ago]
а в Spring Rest есть такие интерфейсы @Projection, вот они выполняют роль отображения. То есть, в них можно настроить ,что будет отображаться, а что нет


Gekov Iliya [5 days ago]
Надо бы почитать


Dima [5 days ago]
первый вариант плох тем, что чтобы добавить какой то url мне придется переписывать котроллер, сервис, репозиторий. Во втором варианте надо только репозиторий обновить новым методом(в самом простом случае)


Gekov Iliya [5 days ago]
На первый взгляд это действительно похоже на продвинутые ТО


Grigory Kislin [5 days ago]
@Dima Spring Rest это наверно Spring Data REST ?
@Projection- интересно
если делаешь подсчет - следи за тем, что по ТЗ юзеров ооочень много
и на каждого делать сложные запросы в базу нельзя


Dima [5 days ago]
да, DATA REST. ну юзеров то много, ну можно разбить на два запроса: ресторан с едой и голосовалка. Делать голосовалку прям в ресторане как то сложно, если учесть как я ее хочу видеть.

Dima [5 days ago]
кэшировать рестораны с едой можно отдельно от голосования?


Dima [5 days ago]
да, ща до меня дошло, что можно отделить ресторан с едой, который не будет меняться целый день, а меняться будут только голоса.


Raisa [Nov 19th at 6:29 PM]
по какому принципу определять нужно ли настраивать связи между сущностями через jpa аннотации в классах: @OneToOne, @ManyToOne и т.д.? у меня сейчас настроены связи только между рестораном и едой. Если в БД у какой-либо сущности есть ссылка на id других сущностей, тоже нужны аннотации? к примеру, в vote есть ссылки на id ресторана и юзера => должны быть аннотации связей в классах?


1 reply
Grigory Kislin [6 days ago]
Если приложению нужно это свойство, то делаешь связь. Обычно как минимум ManyToOne требуются (edited)


Ilya A. Kvyatkovsky [Nov 20th at 12:27 AM]
Возможно ли в одном SQL запросе проверить, что юзер является админом (table ROLES), и в этом случае удалить ресторан (table RESTAURANTS)!? Или полномочия проверять лучше где-нибудь повыше? (edited)


2 replies
Dima [6 days ago]
Посмотри на spring security,доступ к таким запросам там прописывается.


Ilya A. Kvyatkovsky [6 days ago]
Ок. Спасибо!


Lamekhova Alisa [Nov 20th at 8:34 AM]
Юзер может голосовать 1 раз в день или у него только один голос, чтоб проголосовать всего 1 раз?


3 replies
Dima [6 days ago]
Как я понял,юзер может проголосовать только раз в день,при этом до 11 часов он может поменять голос


Lamekhova Alisa [6 days ago]
По условию "Only one vote counted per user" - как будто бы у него есть вообще только 1 голос)


Raisa [6 days ago]
наверное, имеется ввиду, что он может голосовать только за один ресторан и его голос должен быть учтен только один раз. При этом он может поменять свое мнение до 11.00


YuriyUh [Nov 20th at 9:05 AM]
Не совсем пойму, Spring Security прикручивать иль по простому делать, как у нас пока в проекте сделано?


1 reply
Grigory Kislin [6 days ago]
Пока можно по простому


Vladimir Gorbatenko [Nov 20th at 9:33 AM]
А вы делали и таблицу restaurant и сущность Restaurant, и каждый раз пишите это слово? Я сделал проще и удобней - таблица  restaurant, а сущность Resto.


3 replies
Grigory Kislin [6 days ago]
Автодополнения помогают. Не экономь


Lamekhova Alisa [6 days ago]
Хз что в этом полезного, логично когда они одинаково называются


Gekov Iliya [5 days ago]
Какая разница, если идея после пары букв всё подставляет, а вот тому, кто будет этот код смотреть (особенно поверхностно проглядывать, к примеру, потенциальный работодатель) это может сильно не понравиться (edited)


Lamekhova Alisa [Nov 20th at 10:34 AM]
Можно же в сервисе дергать 2 репозитория в 1 транзакции, чтоб получить юзера с голосами, например, и не заморачиваться с аннотациями ManyToOne, JoinColumn и тд.?


7 replies
Sergey Zhukov [6 days ago]
будешь доставать двумя запросами, когда можно сделать за один?


Sergey Zhukov [6 days ago]
через графы, как в учебном


Lamekhova Alisa [6 days ago]
вот что-то у меня не укладывается в голову как это делать( а с 2мя репозиториями все предельно понятно


Sergey Zhukov [5 days ago]
вот из учебного граф
    ```@EntityGraph(attributePaths = {"meals", "roles"})
    @Query("SELECT u FROM User u WHERE u.id=?1")
    User getWithMeals(int id);```
что тут сложного? делаем запрос *дай мне всех юзеров у которых id=*
а с помощью графа говорим подтяни еще всю его еду и роли
по аналогии же можно сделать


Sergey Zhukov [5 days ago]
во всех местах замени "meals" на "голоса"


Grigory Kislin [5 days ago]
@Lamekhova Alisa
вообще можно, но!
> вот что-то у меня не укладывается в голову как это делать
пересматривай topjava. как ты хочешь в разработчики пойти, не уложив это в голову:)? (edited)


Lamekhova Alisa [5 days ago]
Да уже пошла разбираться)))


Vladimir Gorbatenko [Nov 20th at 11:02 PM]
Кто-то делает на H2?
Имею такие проперти для H2 (in-memory/embedded):
database.url=jdbc:h2:mem:voting;DB_CLOSE_DELAY=- 1
database.username=sa
database.password=
database.driverClassName=org.h2.Driver
Не могу понять как она работает. В примерах везде database.url указывают без доппараметра "DB_CLOSE_DELAY=- 1", а у меня без него не работает.
DB_CLOSE_DELAY=- 1 - говорит о том, чтоб не закрывать коннект до shutdown.
Sets the delay for closing a database if all connections are closed. The value -1 means the database is never closed until the close delay is set to some other value or SHUTDOWN is called. The value 0 means no delay (default; the database is closed if the last connection to it is closed). Values 1 and larger mean the number of seconds the database is left open after closing the last connection.
If the application exits normally or System.exit is called, the database is closed immediately, even if a delay is set.
Admin rights are required to execute this command, as it affects all connections. This command commits an open transaction in this connection. This setting is persistent. This setting can be appended to the database URL: jdbc:h2:test;DB_CLOSE_DELAY=-1
Т.е. если не указывать этот параметр, то отрабатывают скрипты по созданию таблиц, популяция таблиц, затем мне непонятно что происходит.
Пример разного поведения после популяции при Postgres и H2:
Postgresql
22:54:11.581 DEBUG o.springframework.jdbc.datasource.DataSourceUtils.doReleaseConnection:340 - Returning JDBC Connection to DataSource
22:54:11.637 DEBUG o.springframework.jdbc.datasource.DataSourceUtils.prepareConnectionForTransaction:176 - Setting JDBC Connection [ProxyConnection[PooledConnection[org.postgresql.jdbc.PgConnection@1e18876d]]]
H2
22:57:10.870 DEBUG o.springframework.jdbc.datasource.DataSourceUtils.doReleaseConnection:340 - Returning JDBC Connection to DataSource
22:57:11.042 DEBUG o.s.jdbc.datasource.DriverManagerDataSource.getConnectionFromDriver:143 - Creating new JDBC DriverManager Connection to [jdbc:h2:mem:voting;DB_CLOSE_DELAY=- 1]
22:57:11.042 DEBUG o.springframework.jdbc.datasource.DataSourceUtils.prepareConnectionForTransaction:176 - Setting JDBC Connection [conn2: url=jdbc:h2:mem:voting user=SA] read-only


4 replies
Vladimir Gorbatenko [5 days ago]
При H2 зачем-то создается еще один драйверменеджер
Creating new JDBC DriverManager Connection


Grigory Kislin [5 days ago]
а что не работает то?


Vladimir Gorbatenko [5 days ago]
Без этого параметра "DB_CLOSE_DELAY=-1", после популяции, при запуске тестов база девственно чистая, нет ни одной таблицы. А с параметром все ок. Но мне-то надо как у всех, без параметра )


Grigory Kislin [7 hours ago]
1. база inmemory создается и удаляется. спасибо за информацию DB_CLOSE_DELAY=-1. был не в курсе. можно сделать в файле
2. >Но мне-то надо как у всех, без параметра
почему нужно без параметра? (edited)


Lamekhova Alisa [Nov 21st at 12:11 PM]
При попытке гетнуть ресторан с историей голосов вываливается  с эксепшн cannot simultaneously fetch multiple bags: [com.example.sweater.model.Restaurant.voteHistory, com.example.sweater.model.Restaurant.mealHistory], т. е. одновременно пытается вытащить и историю голосов и историю еды, как вытащить только историю голосов?


8 replies
Lamekhova Alisa [4 days ago]
В CrudRestaurantRepository  @EntityGraph(value = Restaurant.GRAPH_WITH_VOTE_AND_MEAL_HISTORY)
  @Query("SELECT r FROM Restaurant r JOIN FETCH r.voteHistory WHERE r.id=?1")
  Restaurant getWithVotes(Integer id);


Lamekhova Alisa [4 days ago]
В Restaurant      @NamedEntityGraph(name = Restaurant.GRAPH_WITH_VOTE_AND_MEAL_HISTORY, includeAllAttributes = true)


Lamekhova Alisa [4 days ago]
@OneToMany(fetch = FetchType.LAZY, mappedBy = "restaurant")
   @Fetch(value = FetchMode.SUBSELECT)
   private List<Vote> voteHistory;

   @OneToMany(fetch = FetchType.LAZY, mappedBy = "restaurant")
   @Fetch(value = FetchMode.SUBSELECT)
   private List<Meal> mealHistory;


Lamekhova Alisa [4 days ago]
И что делать если понадобится ресторан и с историей голосов и с историей еды?


Vladimir Gorbatenko [4 days ago]
как-то перемудренно, может стоить вытаскивать историю голосов, в которой есть юзеры и рестораны, и фильтровать по ресторану или юзеру


Dima [4 days ago]
сама история того, что происходило хранится в БД. Можно просто вытаскивать инфу по каким то критериям, например день и ресторан.


Lamekhova Alisa [4 days ago]
Спасибо)


Grigory Kislin [4 days ago]
скажите мне плз- зачем и кому нужны рестораны с историей голосов?? где это есть в ТЗ? (edited)


Sergey Zhukov [Nov 21st at 3:16 PM]
не нравится мне этот смайлик в конце фразы :face_with_raised_eyebrow:  
```P.S.: Make sure everything works with latest version that is on github :)```


1 reply
Vladimir Gorbatenko [4 days ago]
этот лучше чем такой :joy:


Dima [Nov 21st at 10:35 PM]
Есть вопрос по Exception. Свои исключения все равно пригодятся (вроде UserNotFoundException, TooLateForVoteException...), как правильнее их обьявлять: в отдельном пакете и отдельных классах, или прям в том классе,где они будут использоваться, например в классе сервиса?


2 replies
Grigory Kislin [4 days ago]
мы в отдельных объявляем. обычно так


Vladimir Gorbatenko [4 days ago]
Мне наоборот казалось что логичней все эксепшены держать вместе...


Raisa [Nov 22nd at 5:22 AM]
подскажите, какая функциональность для приложения будет базовой, по умолчанию т.е. что нужно обязательно реализовать, даже если об этом не написано в задании? к примеру, там написано хранить историю еды и пользователей. Это буквально значит, что нужно ее хранить в БД на случай если она понадобится для реализации каких-либо методов, или это значит, что нужно реализовать функционал, который отображает эту историю на фронте по запросу пользователя?

Я проектирую интерфейсы для каждой сущности, придумала два вопроса:
1. Какие данные должны отображаться на фронте?
2. Какие данные нужны для реализации методов бизнес-логики?

Что-то еще нужно учесть?
В интерфейсе для каждой сущности должна быть базовая CRUD-функциональность или на усмотрение? К примеру, нужна ли возможность удалять голос? (edited)


7 replies
shomnest [4 days ago]
Делай максимально преближенным к реальному приложению


Sergey Zhukov [4 days ago]
это мое имхо:
минимальная функциональность указана в задании
админ - добавить ресторан, добавить еду (по одной или целое меню за раз) в ресторан
юзер - госовать за ресторан (наверное для этого он должен иметь возможность видеть все рестораны с рейтингами и каждый ресторан с его меню)
ну а дальше фантазия


Raisa [4 days ago]
да, это специфическая функциональность, которая прямо указана в ТЗ и большую специфическую функциональность додумывать нельзя. а какая должна быть базовой независимо от того, что есть в задании? там ведь не было указано, что нужно историю  еды и голосований выводить сейчас при этой функциональности, пока говорилось только о том, что ее нужно хранить


Sergey Zhukov [4 days ago]
я пока думаю что история - это таблица в базе


Sergey Zhukov [4 days ago]
История голосования нужна как минимум для расчета рейтингов.
Может для графиков популярности, анализировать что люди предпочитают в какое время года, тут уже история еды пригодится. :hamburger::coffee:


Raisa [4 days ago]
да, вот я тоже склоняюсь к тому, что это пока таблица в базе


Gekov Iliya [3 days ago]
Я решил все таки добавить выборку истории. Это всего пара лишних методов, зато API будет полнее.


Raisa [Nov 22nd at 5:34 AM]
еще я придумала как определить ресторан, победивший в голосовании. Тут можно поделиться своим вариантом и обсудить (без кода)?


2 replies
Grigory Kislin [3 days ago]
можно:) еще - по опыту проверки тестовых заданий большинство ошибок делается имеено на манипуляции с голосами- те то, чего совсем нет в ТЗ


Raisa [3 days ago]
взять из базы лист vote, за текущую дату, вместе с ресторанами; через стрим сделать мапу - ресторан на количество голосов и так получить ресторан с максимальным количеством голосов


Grigory Kislin [1:59 PM]
напомню, что чем с хорошим баллом за выпускной дается сертификат с отличием и для тех, кто готов трудоустроится в Москве/СПб сейчас возобновили стажировку в at consulting.


Zhinko [Nov 22nd at 5:58 PM]
Предположим, что у меня есть класс Vote в котором поля юзер и ресторан, за который юзер проголосовал. Как достать ресторан вместе с голосами?


1 reply
Gekov Iliya [3 days ago]
Так же как мы достаем юзера с милсами в topjava. По сути одинаковая ситуация: юзер - мил = ресторан - голос (edited)


Lamekhova Alisa [Nov 26th at 9:05 AM]
Методы типо getAllRestorants/Votes/Users/Meals не нужны получаются? Или это что-то очевидное, что должно быть обязательно?


4 replies
Raisa [18 days ago]
я добавила.. похоже, что это базовые методы, которые должны быть в любом случае. Сделала выборку сущностей по id владельца, где он есть: id ресторана - выборка еды, по id юзера - выборка голосов. Там где нет владельца - выборку всех, что есть. По аналогии с topjava


Lamekhova Alisa [17 days ago]
Просто непонятно зачем и кому нужна выборка голосов по айди юзера. А вот выборка голосов по айди ресторана по идее нужна юзеру при выборе ресторана.


Raisa [17 days ago]
юзеру, чтобы у него отображалась история его голосований в личном кабинете


Raisa [17 days ago]
ИМХО выборка голосов по id ресторана, мне кажется, уже специфическая функцональность, т.к. ресторан не является владельцем голосов, поэтому ее нужно другими средствами осуществлять


Dima [Nov 26th at 12:33 PM]
Есть вопрос по названию ссылок на ресурсы при ответе сервера. Как называть их принято?есть какие то правила. У меня например вот так названо. Надо ли как то намекать на методы запросов(GET, POST, DELETE) или это все только в документации указывается?
halResponse.jpg



3 replies
Grigory Kislin [17 days ago]
правиля url недавно искал- там рекомендуют через дефис
а название ресурсов проще так оставить. только почему у тебя один- с маленькой буквы, а второй- с большой?


Dima [17 days ago]
ну да, просто код уже глаз замыливает)т.е. правильно "registration-new-user" ? типо такого?


Grigory Kislin [16 days ago]
я не знаю, погугли. data-rest не так распространено.  просто с переименованием ресурсов и линками между ними думаю что могут всплыть проблемы. но можно и попробовать


Sergey Zhukov [Nov 28th at 9:01 AM]
можно пользоваться регулярными выражениями в переменных мапинга или не стоит так делать?
```@PutMapping("/restaurants/{id:\\d+}")```


3 replies
Vladimir Gorbatenko [16 days ago]
думаю будешь проклят потомками )



fonto [16 days ago]
Есть такое выражение. "У меня одна проблема, я решил не добавив регулярку - появилось ещё три проблемы")


fonto [16 days ago]
Но иногда без них никак)


Sergey Zhukov [Nov 28th at 10:17 AM]
Интересно кто как разруливает когда рестораны называются одинаково, добавить адрес, или достаточно города?


12 replies
Dmitry Neustupov [16 days ago]
Админ может написать Romashka_Msk или Romashka_Spb ) зачем себе голову этим сейчас забивать?


Sergey Zhukov [16 days ago]
Я понимаю, можно индекс сделать (имя, город),
а можно без индекса, задать адрес с улицей.


Dmitry Neustupov [16 days ago]
Можно и так, по разному можно ) Главное не накрутить лишнего )


Sergey Zhukov [16 days ago]
у ресторана должно же быть что-то из этого


Sergey Zhukov [16 days ago]
:slightly_smiling_face:


Dmitry Neustupov [16 days ago]
У меня индекс по имени)


Sergey Zhukov [16 days ago]
найти бы этого админа и распросить :grin:


Dmitry Neustupov [16 days ago]
:grin:


Lamekhova Alisa [15 days ago]
Не могут рестораны одинаково называться

Lamekhova Alisa [15 days ago]
В ГК вроде сказано, что организации, осуществляющие схожую деятельность не могут одинаково называться)


Dima [15 days ago]
однако я имя ресторана unique не делал. Имя может совпадать, а вдруг этот сервис станет всемирным))


Raisa [15 days ago]
я сделала ограничение в базе имя+физический адрес. да, думаю, имя может совпадать на практике, пока компании будут судиться, нужно как-то за них голосовать ))


Dmitry Neustupov [10:28 AM]
@Sergey Zhukov я на уровне базы не даю этого сделать


ABaykov [Nov 28th at 10:52 AM]
Вопрос. Рейтинг ресторанов ведь должен каждый день обнуляться для нового голосования ? Вот это не совсем ясно


16 replies
Sergey Zhukov [16 days ago]
ну можно запросить рейтинг за день или все время


ABaykov [16 days ago]
Т.е. рейтинг сам по себе не отображается сразу? у меня почему-то мысль, что пользователь заходит в систему, видит список ресторанов с текущим рейтингом. Ну и голосует. На следующий день, админ обновляет везде меню, рейтинг сбрасывается


Sergey Zhukov [16 days ago]
мы храним историю голосования, рейтинг любой можешь формировать, просто запрашиваешь за период


ABaykov [16 days ago]
Спасибо. Примерно понял мысль)


Sergey Zhukov [16 days ago]
надо не забывать делаем rest, а вот что там на фронте будет - никому не известно


Dima [16 days ago]
+ к запросу за день,в 0:00 он автоматически не найдет голосов и поуажет 0


Sergey Zhukov [15 days ago]
поф, раз в 100 лет такой будет, статистику не испортит :grin:

Grigory Kislin [15 days ago]
в ТЗ ни слова нет про рейтинг...



Vladimir Gorbatenko [15 days ago]
Григорий, спасибо успокоил ) А то я как-то про рейтинг не задумывался пока тут не увидел обсуждения.. И тоже решил - раз голосование, значит должен быть и рейтинг )


ABaykov [15 days ago]
Мда. Что-то я про рейтинг действительно не учёл, что этого в тз нет. Просто как-то мысль сама пошла. Раз есть голосование, слало быть подавай рейтинг :)))


Dima [15 days ago]
голосовалка за день есть, на фронте уже можно делать рейтинг.Надо же что то кроме картинок и слайдеров оставить)


Vladimir Gorbatenko [15 days ago]
а как насчет показать пользователю не только рейтинг ресторана, но еще к ресторану показать список юзеров, которые голосовали за него? )
и пикчу с пальцем вниз  для ресторана за который меньше всего голосовали ) (edited)


Dima [15 days ago]
это уже на какой то facebook начинает походить)

ABaykov [15 days ago]
это уже всё потом) за деньги заказчика, как я полагаю) сейчас нужно показать, что мы кое-что умеем, кое в чем шарим, и в принципе понимаем основные концепции)


Lamekhova Alisa [15 days ago]
@Dima, а что за "голосовалка за день"?


Dima [15 days ago]
@Lamekhova Alisa я имел в виду рейтинг.


Lamekhova Alisa [Nov 29th at 8:08 AM]
А если надо было бы вытаскивать рейтинг ресторана, делать это нужно через ресторан или голоса фильтровать по айди ресторана?


5 replies
Vladimir Gorbatenko [15 days ago]
через запрос, который просто соберет количество голосов.
Типа
Select votes.date, restaurants.name, count(*) rate
from votes
join restaurans on votes.restaurants_id  = restaurans.id
group by 1,2 (edited)


Lamekhova Alisa [14 days ago]
@Vladimir Gorbatenko а если разом надо получить несколько ресторанов с рейтингом?


Vladimir Gorbatenko [14 days ago]
@Lamekhova Alisa предыдущий запрос немного не точный.
вот пример на быструю руку
Select dm.date, restaurants.name,
       sum(case
             when votes.rest_id is null then 0
             else 1
           end
           ) rate
from
    (select distinct date, rest_id
            from daily_menu) dm
join restaurants on dm.rest_id = restaurants.id
left join votes on votes.rest_id  = dm.rest_id and dm.date = votes.date
--where dm.date = '2018-11-11'
group by 1,2
order by 1,2 (edited)



Vladimir Gorbatenko [14 days ago]
Выбираем даты и рестораны, которые участвовали в конкурсе, затем привязываем рестораны, и голоса


Lamekhova Alisa [14 days ago]
Пойду-ка я хибернейт учить)))


Vladimir Gorbatenko [12:43 PM]
А потом, если количество голосов одинаковое, то манипулировать избирателями можно демпингом цен на еду ))
И еще прикрутить левых пользователей анонимусов, или ботов, которые кушать не пойдут, но проголосовали ))) (edited) 


Lamekhova Alisa [Nov 29th at 7:32 PM]
А вот с такой фигней никто не сталкивался в постмане? Причем это только при попытке манипуляции с голосами, все остальное норм и урлы не дублирует
Без имени-1.jpg



5 replies
Grigory Kislin [13 days ago]
spring-boot ?


Lamekhova Alisa [13 days ago]
@Grigory Kislin ага


Grigory Kislin [13 days ago]
а в чем вопрос собственно:)?


Lamekhova Alisa [13 days ago]
Не могу понять почему путь такой странный и связано ли это с тем, что у меня голоса нормально не сериализуются)


Grigory Kislin [9 days ago]
какой из браузера путь приходит, такой и тут. вкладка networkв браузере


Raisa [Dec 1st at 5:46 PM]
делаю unit-тесты, возник вопрос: зачем в тестах topjava нужны классы InMemory...?  InMemoryMealRepositoryImpl сейчас вообще не задействован, InMemoryUserRepositoryImpl какую функцию выполняет? инжектится в InMemoryAdminRestControllerSpringTest, в самих тестах, вроде, не задействован..


1 reply
Grigory Kislin [11 days ago]
в учебных целях


Maxim [Dec 1st at 9:35 PM]
помогите с выборкой LocalDateTime в postgres к полю TIMESTAMP через Query. ругается что LocalDateTime это не Date. в учебно проекте как это обошли?


5 replies
Grigory Kislin [11 days ago]
LocalDateTime это TIMESTAMP
LocalDate это DATE
должно работать, дай весь эксепшен (edited)


Maxim [11 days ago]
Кратко:
org.springframework.dao.InvalidDataAccessApiUsageException: Parameter value [2018-12-02T12:46:57.752993200] did not match expected type [java.util.Date (n/a)]; nested exception is java.lang.IllegalArgumentException: Parameter value [2018-12-02T12:46:57.752993200] did not match expected type [java.util.Date (n/a)]
Подробнее: http://prntscr.com/lpn0lo
Lightshot
Screenshot
Captured with Lightshot (140 kB)


Maxim [11 days ago]
в БД init http://prntscr.com/lpn16s
Lightshot
Screenshot
Captured with Lightshot (11 kB)


Maxim [11 days ago]
РЕШЕНО: При пересмотре выявился косяк. В Entitiy поле подтянулось из БД как TIMESTAMP. заменил на нужное и все заработало


Grigory Kislin [11 days ago]
для именований в базе не используй case в буквах.


Lamekhova Alisa [Dec 3rd at 12:28 PM]
5.2 НЕ надо делать абстрактных контроллеров на всякий случай.Значит ли это, что можно обойтись 3 контроллерами (root(для всех), admin and user).  Т. е. получится, что в админКонтроллер мы будем пихать все операции с юзерами, едой и ресторанами? Норм вообще так делать? С точки зрения ООП это не правильно, но как по-другому без абстрактных контроллеров? (edited)


4 replies
Dima [10 days ago]
Можно делать много контроллеров,и у каждого свой @RequestMaping


Grigory Kislin [10 days ago]
@Lamekhova Alisa совсем не значит. пихать все в один контроллер- ненормально. а для чего ты хочешь делать абстрактный контроллер?


Lamekhova Alisa [10 days ago]
@Grigory Kislin Один из вариантов как в топджаве с user. Например, в restaurant -> AbstractRestaurantController - ProfileRestaurantController и AdminRestaurantController и т. д. Но тогда на каждую сущность будут контроллеры по такому же принципу создаваться, т. е. их будет очень много. 2) Либо так: Общий контроллер, профиль контроллер и 3 контроллера для админа (мил, ресторан и юзер). Как вообще правильно?)


Grigory Kislin [10 days ago]
ресторан не принадлежит к профилю юзера, не думаю что ProfileRestaurantController  правильное название.
а вообще правильно- нет такого... сделай как считаешь красивее. я написал что на всякий случай не делать


Raisa [Dec 4th at 6:22 AM]
подскажите, пожалуйста, почему spring  может не находить драйвер jdbc при запуске тестов для service?
initDb работает, значит jdbc настроен, но spring его не видит

java.lang.IllegalStateException: Failed to load ApplicationContext
Caused by: org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'entityManagerFactory' defined in class path resource [spring/spring-db.xml]: Cannot resolve reference to bean 'dataSource' while setting bean property 'dataSource'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'dataSource' defined in class path resource [spring/spring-db.xml]: Error setting property values; nested exception is org.springframework.beans.PropertyBatchUpdateException; nested PropertyAccessExceptions (1) are:
PropertyAccessException 1: org.springframework.beans.MethodInvocationException: Property 'driverClassName' threw exception; nested exception is java.lang.IllegalStateException: Could not load JDBC driver class [org.hsqldb.jdbcDriver]

в spring-db (то же, что и в topjava):

<jdbc:initialize-database data-source="dataSource" enabled="${database.init}">
       <jdbc:script location="classpath:db/${jdbc.initLocation}"/>
       <jdbc:script encoding="utf-8" location="classpath:db/populateDB.sql"/>
   </jdbc:initialize-database>

   <context:property-placeholder location="classpath:db/hsqldb.properties" system-properties-mode="OVERRIDE"/>

   <bean id="dataSource"    class="org.springframework.jdbc.datasource.DriverManagerDataSource"
         p:driverClassName="org.hsqldb.jdbcDriver"
         p:url="${database.url}"
         p:username="${database.username}"
         p:password="${database.password}"/>

properties
database.url=jdbc:hsqldb:mem:voter
database.username=sa
database.password=
database.init=true
jdbc.initLocation=initDB_hsql.sql
jpa.showSql=true
hibernate.format_sql=true
hibernate.use_sql_comments=true (edited)


4 replies
Lamekhova Alisa [10 days ago]
А в настройках DataSourse and Drivers правильный драйвер выбран?


Raisa [10 days ago]
вроде бы, да:
Pasted image at 2018-12-04, 12:44 PM



Lamekhova Alisa [10 days ago]
А <scope> у hsqldb в помнике какой указан? У меня такое было с H2, когда <scope>test стоял


Raisa [10 days ago]
спасибо большое! поправила помник, помогло


Vladimir Gorbatenko [Dec 4th at 4:52 PM]
Делаю выпускной проект, и он получается ну какой-то слишком бедный на функционал.
Сейчас, дабы не морочиться со скриптами, при популяции базы, меню по ресторанам формируется хранимой процедурой - от текущей даты на 4-5 дней вперед,
Имею сущности: юзер (с ролями), ресторан, блюдо, меню_на_день, голос.
Итого из функционала получается только:
1) выбор даты, для отображения меню ресторанов на эту дату.
2) кнопка "проголосовать" - которая сохраняет голос (на самом деле сохранение происходит на клацаньи по radio).
По ТЗ вроде как больше и не надо. Но меня подмывает сделать полноценное приложение, причем основной функционал будет на админской стороне - управление ресторанами, блюдами, меню. (юзерами - делаю сразу параллельно с topjava).
Может я что-то упустил?
Морда голосовалки
voting.JPG



11 replies
Raisa [9 days ago]
а зачем сущность "меню на день"? можно ведь из базы брать по дате и ресторану?


Vladimir Gorbatenko [9 days ago]
Each restaurant provides new menu each day.
Каждый день у ресторана меняется меню. Т.е. на определенный день рестораны показывают что они готовы предложить.


Raisa [9 days ago]
да, к примеру, есть таблица meals, в ней колонки id ресторана, дата и по ним делать выборку, так и получится - вся еда определенного ресторана определенный за день. я просто хочу понять, может я что-то не учла и исправить


Vladimir Gorbatenko [9 days ago]
если твоя meals содержит еще и еду, то это практически аналог моей daily_menu, только в моей таблице находятся айдишки еды, которые привязаны к ресторану.
у меня есть таблица с едой, и она общая для всех ресторанов.
предполагается, что администратор на день выбирает ресторан и формирует меню, выбирая еду из доступного списка (который сам же и пополняет) . (edited)


Raisa [9 days ago]
аа, т.е. админ из каталога выбирает еду, а не вносит новую


Vladimir Gorbatenko [9 days ago]
ну да, зачем дублировать...


Raisa [9 days ago]
по поводу доп.функционала ИМХО при выполнении тестовых заданий как никогда подходит "лучше когда нечего отнять, чем когда нечего добавить". Читала несколько печальных историй, когда отказывали после выполнения тестового, если был функционал, к-рого не было в ТЗ. Это, мне кажется, тоже проф.навык - сделать именно так как нужно заказчику. Работодатель навряд ли оценит энтузиазм в этом случае, т.к. подумает, что соискатель будет тратить время на выполнение того, что ему не говорили, а потом еще на удаление всего этого после ревью, а время программиста дорого стоит. Тут нужно как-то умудриться найти баланс (edited)


Lamekhova Alisa [9 days ago]
@Raisa а зачем "вся еда определенного ресторана за день", если можно одним запросом вытянуть сразу все рестораны с меню на сегодня (или на любую дату)?


Raisa [9 days ago]
@Lamekhova Alisa т.е. вытащить все нужные рестораны с их едой за день? да, это общий случай. Просто интересно стало, нужна ли сущность "меню на день". Оказалось, что тут вообще другая концепция обработки информации о еде.


Raisa [9 days ago]
в ТЗ говорится Admin can input a restaurant and it's lunch menu of the day. Т.е. не choose, а input. Насколько буквально понимать ТЗ? :slightly_smiling_face:
и еще Each restaurant provides new menu each day - т.е. блюда новые каждый день и дублирования не будет. Или он provides новые комбинации уже имеющихся блюд и это считается новым меню?  :slightly_smiling_face: :exploding_head: (edited)


Lamekhova Alisa [9 days ago]
Так это уже детали, кто как понимает, тот так и делает, если норм сохраняется история меню, то какая разница как он его заводит. Новое меню, имеется в виду новое меню-новая дата. Блюда конечно, могут повторятся. По-моему все минимальные требования по ТЗ выполнены. Только голосование бы нормальной кнопкой сделать)


Lamekhova Alisa [8:01 AM]
Кто юзает Spring Boot, как настраивали логирование? Я просто смотрю там в зависимостях уже есть и slf4j, и logback и все каким-то образом уже логируется.


Sergey Zhukov [Dec 5th at 8:49 AM]
>13: Историю еды и голосований сделать НУЖНО!
*как правильно удалять голоса?*
- удаляем юзера вместе с его голосами, удаляем ресторан вместе с голосами
- удаляем юзера и в его голосах обнуляем юзера, удаляем ресторан вместе с голосами


9 replies
Raisa [9 days ago]
а зачем весь ресторан удалять? достаточно соотв. строки в votes удалить, голоса других юзеров сохранятся


Lamekhova Alisa [9 days ago]
у меня пока сделано - удаляем юзера вместе с его голосами, удаляем ресторан вместе с голосами


Vladimir Gorbatenko [9 days ago]
Юзера то за что удалять?


Vladimir Gorbatenko [9 days ago]
Если таки нужно убить юзера, то надо в базе делать каскадное удаление. Грохнул юзера, автоматом удалились все строки где он участвовал.



ABaykov [9 days ago]
А зачем удалять голоса юзера? Если он голосовал, то статистика не должна пострадать. Полагаю, что удалять голоса нужно только при удалении конкретного ресторана.


Sergey Zhukov [9 days ago]
@Lamekhova Alisa так же буду удалять


Grigory Kislin [8 days ago]
я с голосами вообще никаких операций не далал (кроме голосования), когда выполнял это тестовое


Sergey Zhukov [8 days ago]
Короче уже вообще все в кучу смешалось :dizzy_face:
@Grigory Kislin Получается что Admin это не глобальный админ, который всем правит, как у нас в учебном, а "Администратор" своих ресторанов, другие Админы админят свои рестораны?


Grigory Kislin [8 days ago]
@Sergey Zhukov это все - допы к ТЗ, которые сильно усложнят ваши решения и привнесут туда большое ко-во ошибок (edited)


Lamekhova Alisa [Dec 5th at 1:26 PM]
И все-таки, кто какие контроллеры сделал и из каких соображений? Я что-то не могу нормальной инфы найти на тему: как правильно делать контроллеры. Пока остановилась на варианте: общий контроллер (просомтреть меню на сегодня, гетнуть ресторан, гетнуть мил, гетнуть результат голосования), профиль контроллер (проголосовать, получить свои голоса, изменить информацию о себе, удалить себя и т.д) и админские контроллеры для операций над юзером, милами и ресторанами. Либо нельзя в одном контроллере делать методы над разными сущностными?


8 replies
Vladimir Gorbatenko [8 days ago]
Кстати интересный момент "удалить свой голос на дату", типа передумал голосовать... Я такого не реализовывал, а вы? )


Lamekhova Alisa [8 days ago]
@Vladimir Gorbatenko нет, норм идея, если додумывать дальше функционал, можно и такое сделать)


Sergey Zhukov [8 days ago]
как минимум 3 нарисовались, ресторана, админа, голосов(юзера) (edited)


Lamekhova Alisa [8 days ago]
@Sergey Zhukov в админ контроллере методы типо создать мил, создать ресторан? а в ресторане тогда что?


Sergey Zhukov [8 days ago]
в админе аналогично учебному, управлерие пользователями, в ресторане действия с рестораном и едой, в юзере голосовалка


Gekov Iliya [8 days ago]
Я помимо вышеназванного разделил контроллеры ресторана и еды, т.к. мне кажется, логика разная. С ресторанами стандартный crud для работы непосредстенно с ними, с едой  отдельные методы для работы с едой.


Grigory Kislin [8 days ago]
как я вижу контроллеры
-  рестораны
-  юзеры
-  меню/еда
-  ...
все от фантазии и модели зависит


Lamekhova Alisa [8 days ago]
Спасибо, есть над чем подумать)


Егорро [Dec 5th at 3:57 PM]
Всем привет! Добрался до попыток написания проекта, уже несколько дней мучаюсь с таким вопросом: как все же  полноценно доставать onetomany-коллекции, если в аннотации стоит Lazy? Т.е. использую, например, такой запрос:
SELECT DISTINCT r FROM Restaurant r JOIN FETCH Dish d ON d.actual=true
Вроде бы, судя по всей куче перелопаченных материалов, JOIN FETCH как раз и должен мне подтягивать саму коллекцию объектов dishes для объектов Restaurant, но в результате нифига - получаю все равно тупо неинициализированные прокси.... Уже просто все мысли закончились, как эта ерунда может работать (и может ли она работать вообще)...


14 replies
Sergey Zhukov [8 days ago]
DISTINCT зачем
еще надо попробовать обратиться к колекции в той же транзакции, дебагер не покажет (edited)


Егорро [8 days ago]
Без DISTINCT он у меня возвращал вообще список из 10 ресторанов вместо 2))
Насчет обращения - на данный момент рабочим вариантом является как раз такой:
       List<Restaurant> all = getAll();
       all.forEach(restaurant -> restaurant.getDishes().removeIf(dish -> !dish.getActual()));
       return all;
Но все же хотелось бы разобраться, можно ли это же все сделать сразу через запрос...


Sergey Zhukov [8 days ago]
getAll() это что за метод? у тебя слой сервиса? не тянет может из за того что не в транзакции обращаешься к колекции (edited)


Егорро [8 days ago]
Это пока в репозитории, но скорее всего по смыслу в сервис пойдет


Егорро [8 days ago]
getAll - просто получение общего списка через "SELECT r FROM Restaurant r"

Grigory Kislin [8 days ago]
1. SELECT DISTINCT r FROM Restaurant r JOIN FETCH Dish - вот так попробуй

Grigory Kislin [8 days ago]
ON у тебя мне не нравится. попробуй в WHERE его перенести


Егорро [8 days ago]
Вроде уже пробовал такой вариант - еще раз сделал, падает с исключением "ошибка синтаксиса".  Запустилось только с таким:
SELECT DISTINCT r FROM Restaurant r JOIN FETCH Dish d ON d.restaurant=r WHERE d.actual=true
Но при этом коллекция так и не инициализируется (проверяю в main через GenericXmlApplicationContext)


Егорро [8 days ago]
Самое тупое что в соседней строчке такой запрос для 1 ресторана:
SELECT r FROM Restaurant r JOIN FETCH Dish d ON d.actual=true WHERE r.id=:id
Все отлично достает, сразу с отфильтрованной коллекцией... (edited)


Sergey Zhukov [7 days ago]
у меня вот так работает
```SELECT DISTINCT r FROM Restaurant r LEFT JOIN FETCH r.dishes d WHERE d.added=?1```
выбирает все рестораны с едой за указанный день
*так не работает*:
```SELECT DISTINCT r FROM Restaurant r LEFT JOIN FETCH Dish d WHERE d.added=?1```
(edited)


Егорро [7 days ago]
@Sergey Zhukov спасибо! Вот оно, не то в join писал)) Разбираться и разбираться еще в этих премудростях


Grigory Kislin [6 days ago]
@Егорро лучше всего взять пример. потому что на глаз непонятно... в topjava это
CrudMealRepository.getWithUser или CrudUserRepository.getWithMeals- по истории коммитов с FETCH патч 6_06_HW5_optional_fetch_join
разницы же никакой (edited)


Егорро [6 days ago]
@Grigory Kislin спасибо, по урокам я сейчас только 6 заканчиваю пересматривать - даже и не подумал, что дальше еще можно посмотреть по репозиториям))


Grigory Kislin [6 days ago]
ну, если по topjava FETCH не проходил- рано его делать в выпускном


Gekov Iliya [Dec 6th at 12:01 AM]
Столкнулся с проблемой рекурсивного маппинга в Json, когда достаю, к примеру, ресторан с едой (в json мапится ресторан, еда, снова ресторан в еде и т.д. до бесконечности, хотя на стороне сервера естественно это все один и тот же объект-ресторан). Нашел следующее решение путем добавление аннотаций @JsonManagedReference  и @JsonBackReference над соответствующими полями, может кому пригодится: https://stackoverflow.com/questions/3325387/infinite-recursion-with-jackson-json-and-hibernate-jpa-issue

*UPD*:
Данный способ работает только в одну сторону, то есть, к примеру, ресторан с едой сериализуется отлично, но если попробовать получить еду с ресторанами, то рестораны будут игнорироваться. В той же ссылке чуть ниже описан способ с аннотацией @JsonIgnoreProperties, он позволяет работать в обе стороны. Т.е. если мы фетчим ресторан с едой, то у еды не будет сериализоваться поле ресторана, если фетчим еду с ресторанами, то у ресторанов не будет сериализоваться поле с едой. (edited)



6 replies
Lamekhova Alisa [8 days ago]
Такая же проблема была на той неделе и таким же способом решилась)


Vladimir Gorbatenko [8 days ago]
Я использовал @Transient, так как ресторан со списком еды мне нужен только при формировании TO и показа его пользователю.


Vladimir Gorbatenko [8 days ago]
Хмм... Когда вытягиваю в XML формате, еда нормально вытаскивается, а когда JSON, то наш ObjectMapper вырезает геттер еды...
Пришлось отказаться от мэппера.... (edited)


Alexey_b [8 days ago]
тоже порешал первым способом.  Хочу вопрос по теме задать,  я правильно понимаю что одним пост запросом создать ресторан  уже сразу с листом еды нельзя?


Vladimir Gorbatenko [7 days ago]
@Alexey_b можно! Только перед постом, через джаваскрипт надо сформировать строку блюд, типа
?dishes=dish1;dish2;dish3.
И запихнуть либо в гет, либо в элемент инпут (например hidden).


Alexey_b [7 days ago]
не, я использовать это в проекте не буду, но хотелось узнать, вдруг это все же возможно без всяких фокусов


Raisa [Dec 6th at 6:14 AM]
напомните, пожалуйста, как в topjava добились того, чтобы UserTest не падал с org.hibernate.LazyInitializationException: failed to lazily initialize a collection .... could not initialize proxy - no Session, т.е. по причине, что в model.User есть ассоциированная коллекция meals с FetchType.LAZY?

   @OneToMany(fetch = FetchType.LAZY, mappedBy = "user")//, cascade = CascadeType.REMOVE, orphanRemoval = true)
   @OrderBy("dateTime DESC")
//    @JsonIgnore
   protected List<Meal> meals;

Для своего проекта нашла на stackoverflow решение:
   @OneToMany(mappedBy = "user")
   @LazyCollection(LazyCollectionOption.FALSE)
   @Fetch(FetchMode.SELECT)
   private List<Vote> votes;

Т.е. вместо lazy стратегии сразу вытаскивать из базы родительскую сущность с ассоц.коллекциями, но одним запросом, а не N+1
Но все же, хотелось бы разобраться. Заодно интересны мнения по поводу такого решения :arrow_up: (edited)


3 replies
Grigory Kislin [8 days ago]
дак не сравнимай в тестах meals, где мы ее не достаем (edited)


Raisa [8 days ago]
аа, это потому что я поля в игнор не добавила.. глупая ошибка


Grigory Kislin [6 days ago]
в topjava мы подключаем Hibernate5 в JacksonObjectMapper- он автоматически не сериализует lazy ассоциации


Alexey_b [Dec 10th at 4:48 PM]
По поводу авторизации есть вопросы,  нужно сделать эндпойнт по которому юзер/админ может авторизоварься,  и получить кУку, и в следущих curl запросах эту куку прикладывать, или как-то иначе? (edited)


1 reply
Grigory Kislin [3 days ago]
проще всего rest+basic auth (см topjava) (edited)


Lamekhova Alisa [Dec 11th at 7:27 PM]
Не могу понять в чем проблема, в юзерРепозитории есть метод, он удаляет юзера из базы, но возвращает 0. @Transactional
   @Modifying
   @Query("DELETE FROM User u WHERE u.id=?1")
   int delete(Integer id);


14 replies
Lamekhova Alisa [2 days ago]
Из за этого валится проверка checkNotFoundWithId, милы и рестораны удаляются нормально такими же методами


Lamekhova Alisa [2 days ago]
Думаю в ролях дело, но не могу понять в чем конкретно


Grigory Kislin [1 day ago]
ты проверяешь- точно удаляет?


Sergey Zhukov [1 day ago]
вот безопасный способ без Query не кидающий никаких WARN и эксепшенов при удалении несуществующих записей
    ```@Transactional
    int removeById(int id);```


Lamekhova Alisa [1 day ago]
@Grigory Kislin да, точно удаляется


Lamekhova Alisa [1 day ago]
@Sergey Zhukov в этом методе валится с org.springframework.dao.PessimisticLockingFailureException: could not execute statement; SQL [n/a]; nested exception is org.hibernate.PessimisticLockException: could not execute statement


Sergey Zhukov [1 day ago]
ну тут уже надо смотреть в класс User и как генерится таблица БД, может где-то несоответствие
сверь с учебным, как у тебя достаются роли
у меня все способы удаления работают, делал по аналогии с учебным


Sergey Zhukov [1 day ago]
этот метод
    ```@Transactional
    int removeById(int id);```
отрабатывает вот так
```Hibernate: 
    /* select
        generatedAlias0 
    from
        User as generatedAlias0 
    where
        generatedAlias0.id=:param0 */ select
            user0_.id as id1_3_,
            user0_.EMAIL as EMAIL2_3_,
            user0_.ENABLED as ENABLED3_3_,
            user0_.NAME as NAME4_3_,
            user0_.PASSWORD as PASSWORD5_3_,
            user0_.REGISTERED as REGISTER6_3_ 
        from
            users user0_ 
        where
            user0_.id=?
Hibernate: 
    /* delete collection org.voting.model.User.roles */ delete 
        from
            ROLES 
        where
            USER_ID=?
Hibernate: 
    /* delete org.voting.model.User */ delete 
        from
            users 
        where
            id=?```

достает юзера, если получилось, то удаляет его роли потом самого юзера


Lamekhova Alisa [1 day ago]
Вот у меня, видимо, с ролями и проблема, он их удалить не может и валится

Lamekhova Alisa [1 day ago]
Как в потджаве роли сделаны. @Enumerated(EnumType.STRING)
@CollectionTable(name = "roles", joinColumns = @JoinColumn(name = "user_id"))
@Column(name = "role")
@ElementCollection(fetch = FetchType.EAGER)
private Set<Role> roles;


Sergey Zhukov [1 day ago]
роли в базе есть?

Lamekhova Alisa [1 day ago]
@Sergey Zhukov да, роли нормально добавляются при создании юзера, и вытаскиваются нормально с юзером


Lamekhova Alisa [1 day ago]
Авторизация нормально работает по ролям


Grigory Kislin [1 day ago]
@Lamekhova Alisa перегружалась? PessimisticLockException- это возможно что-то в базе залочилось


Sergey Simonov [Today at 11:36 AM]
Вполне возможно что в будущем в это приложение захотели бы внести дополнения в виде составления меню и голосований ещё и для breakfast, dinner  и ид. (Теоретически)
Должен ли я учитывать это при проверке на критерий "простое для доработки"?


7 replies
Grigory Kislin [12 hours ago]
а сам как думаешь? и - как ты хочешь это доработать? (edited)


Sergey Simonov [12 hours ago]
@Grigory Kislin я бы хотел оставить такую возможность, потому что это в принципе может понадобиться клиенту в дальнейшем

Как сделать: 
1. Сделать в Votes и Dishes в базе и в entity отдельные поля для Date и Time , а не одно DateTime.
2. Не делать в Vote уникальности по (userId, date). 
Тогда в java коде, не трогая базу можно было бы:
1. Вынимать из базы блюда и трансформируя в меню не только по restaurantId, но и + ещё по Time, например считать что блюда с 7:00 до 10:00 это завтрак .
2. Тогда при обновлении меню у блюд выставлялась бы автоматически только Date, а Time задавал бы админ сам, что бы указать к какому приему пищи сие относит 

Таким же образом считать голосовал ли юзер или нет (edited)


Grigory Kislin [11 hours ago]
1. - да. причем может пригодиться для чегото другого- например анализа поведения. 2- мое мнение - нет. на базу всегда можно миграцию сделать (edited)


Sergey Simonov [11 hours ago]
То есть это уже чисто на мое усмотрение? На качество архитектуры это в данном случае не влияет ? 

Или 1 - относится к тому что я написал про базу и entity? (edited)


Grigory Kislin [11 hours ago]
2. если index по дате не сделаешь- конечно повлияет. на скорость доступа и консистентность (edited)


Vladimir Gorbatenko [11 hours ago]
@Sergey Simonov однозначно к приложению можно придумать (добавить) еще бесконечную гору функционала - для веганов и для обычных, первые/вторые/десерты/напитки, учитывать сезонность, национальность и т.д.


Sergey Simonov [11 hours ago]
@Vladimir Gorbatenko придумать то конечно можно все что угодно,
Я спрашивал про то должен ли я предусмотреть вышеописанную доработку на уровне базы, т.к java код больше шансов изменить, а бд может быть очень далеко и нельзя так просто её  переделать (edited)


indisbk [Dec 14th at 7:10 AM]
Господа, подскажите - сделал уникальный индекс по user_id и date в таблице vote, но при дублировании голоса все равно сохраняется в базу. Не могу понять как так получается.(Timestamp и localdatetime пробовал, такая же фигня).


31 replies
indisbk [5 days ago]
и да айдишники все у меня в bigint так как использую long, может ли быть в этом проблема?


Vladimir Gorbatenko [5 days ago]
используй тип Date, ограниченный только датой, без времени.
И соответственно индекс date+userId



Dima [4 days ago]
Там в задании есть пункт про 11 часов дня,сравнение поэвремени все равно должно быть. Date не обойдешься


indisbk [4 days ago]
сравнение я думал делать на слое веба, в контроллере.


Sergey Zhukov [4 days ago]
я храню LocalDate как Date а время проверяю перед сохранением


indisbk [4 days ago]
странно при LocalDate все равно сохраняет


Sergey Zhukov [4 days ago]
может проблема в логике


Dima [4 days ago]
я храню как timestamp, потом проверяю перед сохранением по юзеру и времени


Sergey Zhukov [4 days ago]
ну наверно надо проверить сначала был ли голос, если нет - сохранить, если да - апдейтить


Sergey Zhukov [4 days ago]
или всю логику свалить на базу?


Dima [4 days ago]
так и есть, запрашиваю у базы голос по юзеру, потом ,если он есть, проверяю дату голоса, потом все остальное


indisbk [4 days ago]
епт, так сложно)


indisbk [4 days ago]
я думал что при сохранении дубликата, просто выкинет DataAaccessException и ни фига не сохранит


Dima [4 days ago]
так если голос есть надо посомтреть сколько сейчас времени, если до 11 то можно перезаписать

indisbk [4 days ago]
Это понятно, я про то что одному юзеру нельзя голосовать дважды в день.


Dima [4 days ago]
можно, но до 11)

Dima [4 days ago]
я эту логику не кидал на базу, а оформил в сервисе при сохранении голоса


indisbk [4 days ago]
да не в этом дело, когда я создаю дубликат голоса он его почему то сохраняет, хотя в базе стоит ограничение на уникальность по дате и юзеру


indisbk [4 days ago]
в этом моя проблема)


Sergey Zhukov [4 days ago]
открой базу и руками в IDEA попробуй добавить такую же запись


Sergey Zhukov [4 days ago]
должна ругаться


indisbk [4 days ago]
ругается в том то и дело)


Dima [4 days ago]
ну продебаж, че приходит на метод сохранения.Проверь голос приходщий и в базе


Sergey Zhukov [4 days ago]
щас убрал свою проверку перед сохранением в базу, два раза шлю одинаковые данные и база ожидаемо ругается в ответ
```</pre><p><b>Root Cause</b></p><pre>java.sql.SQLIntegrityConstraintViolationException: integrity constraint violation: unique constraint or index violation: VOTES_UNIQUE_DATE_USER_IDX```


indisbk [4 days ago]
собсно, проблема решена, но я ни черта не понял)

indisbk [4 days ago]
я инжектил сразу интерфейс spring-data

indisbk [4 days ago]
когда добавил как в topjava отдельный интерфейс и его имплементацию, тогда все заработало)

indisbk [4 days ago]
нет проблема оказалась в аннотациях spring-boot, если ставить @DataJpaTest, тогда все сохраняет, если поставить @SpringBootTest тогда начинает кидать эксепшн))


indisbk [4 days ago]
действительно Spring Test то еще проклятие)

Sergey Zhukov [4 days ago]
:grin: что же сразу не сказал что в тестах не работает


Grigory Kislin [1 day ago]
1. консисетнси на уровне базу (как и индексы)- очень желательно
2. бизнес логика оптимально должна быть в сервисах. и по любому не в репозиториях!


Raisa Dec 14th at 3:35 PM
сделала проверку на текущее время сохранения голоса на уровне репозитория - теперь часть тестов отваливается после 11.00, как быть? (edited)

Dima 4 days ago
Я забил на тесты)) может потрм как нить.

Sergey Zhukov 4 days ago
а почему не делаешь сервис для этой логики?

Raisa 4 days ago
@Sergey Zhukov :thinking_face: отдельно репо протестировать.. это идея!

Sergey Zhukov 4 days ago
сделала проверку на текущее время сохранения голоса на уровне репозитория
я оставил интерфейсы, меньше тестов писать

Grigory Kislin 1 day ago
еще решение- инжектить время проверки

Lamekhova Alisa 1 day ago
у меня сеттер в классе для тестов сделан

Sergey Zhukov 1 day ago
держу время в утильном классе-бине, сетю из xml нужное значение

Zippospb 4 hours ago
ReflectionTestUtils вам в помощь. Перед тестом с помощью данного класса меняем поле, с которым сравнивается нынешняя дата. (edited)


Raisa [4 days ago]
заинженктила класс с временем, спасибо :+1: (edited)


Grigory Kislin [4 days ago]
@Zippospb зачем ReflectionTestUtils, если можно сделать обыкновенный сеттер? (edited)


Zippospb [4 days ago]
@Grigory Kislin а есть ли смысл делать сеттер, который нужен лишь для пары тестов?


Grigory Kislin [2 days ago]
ну... мне кажется лучше, чем рефлекшен
потом- егоже можно в конфигурацию вынести


Raisa [Dec 14th at 6:57 PM]
а учитывать ситуацию, если рестораны наберут равное количество голосов? :slightly_smiling_face:  или вообще никто не проголосует? (edited)


5 replies
Sergey Zhukov [4 days ago]
а мне другое интересно, можно ли голосовать за ресторан у которого нет меню на сегодня?


Raisa [3 days ago]
@Sergey Zhukov я думаю, такого не может быть, т.к. по ТЗ каждый ресторан предоставляет новое меню каждый день


fonto [3 days ago]
Ну или если не предоставляет, то числится в списках ресторанов, но в голосовании в этот день просто не участвует


fonto [3 days ago]
Вообще много, чего можно напридумывать, все зависит он требований заказчика)


Grigory Kislin [1 day ago]
Раиса, по вопросу сужу, что сдалано чтото, чего нет в ТЗ. обычно еще и с кучей ошибок


Raisa [4 days ago]
@Grigory Kislin ресторан, который победил, получается, не нужно определять по ТЗ? :slightly_smiling_face: только голосовать?


Grigory Kislin [4 days ago]
нет:) а где ты увидела в ТЗ?


Lamekhova Alisa [Dec 19th at 12:31 PM]
Как в спринг бут сделать, чтоб при запуске приложения база сразу наполнялась тестовыми данными из sql-ных файлов?


4 replies
Taras [4 days ago]
А в чем у тебя проблема? При старте, если у тебя есть файлы `schema.sql` и `data.sql`, — они будут автоматически считаны. А можно, не связываясь с ручным вводом данных, сделать так: создать бин `@Component`, в него заинжектить нужные сервисы, и в методе с `@PostConstruct` инициализировать данные путем вставки.



Grigory Kislin [4 days ago]
еще вариант для наполнения кодом: https://stackoverflow.com/questions/27405713/running-code-after-spring-boot-starts
Stack Overflow
Running code after Spring Boot starts
I want to run code after my spring-boot app starts to monitor a directory for changes. I have tried running a new thread but the @Autowired services have not been set at that point. I have been...
 


Marat [4 days ago]
В resources положить файлы schema.sql и data.sql


Lamekhova Alisa [4 days ago]
Спасибо) они лежали в ресурсах, но в еще одной папке и не запускались)


Sergey Zhukov [Today at 12:38 AM]
если время голосования вышло, каким статусом лучше ответить?
я склоняюсь к SERVICE_UNAVAILABLE, 503


14 replies
Vladimir Gorbatenko [17 hours ago]
я использовал
406 Not Acceptable


Vladimir Gorbatenko [17 hours ago]
SERVICE_UNAVAILABLE - скорей говорит о том что зайдите позже, сейчас все нафиг сломалось )



Sergey Zhukov [17 hours ago]
интересно а свой статус можно
100500 Vote ended :face_with_rolling_eyes:


Vladimir Gorbatenko [17 hours ago]
Решил посмотреть коды и нашел прикольный )
418 I’m a teapot («я — чайник»);



Zippospb [17 hours ago]
по мне так это конфликт 409


Sergey Zhukov [17 hours ago]
что насчет 412 Precondition Failed
"Предварительное условие не выполнено"


Vladimir Gorbatenko [17 hours ago]
мне не нравится... пользователь будет думать что же он сделал не так


Sergey Zhukov [17 hours ago]
пользователь не увидит этих кодов, они для разработчика UI


Sergey Zhukov [17 hours ago]
Пользователю красиво намекнут - иди читай условия


Vladimir Gorbatenko [17 hours ago]
тогда разработчик задумается что не так с условием


Sergey Zhukov [17 hours ago]
в том то и дело есть условие до 11


Vladimir Gorbatenko [17 hours ago]
разраб тогда и почитает что он опоздал )


Vladimir Gorbatenko [17 hours ago]
может задать вопрос Григорию?


Sergey Zhukov [17 hours ago]
я думаю взять что то из этих, в реале статусы надо согласовывать, в ТЗ наверняка должны быть указаны


under4eg [Today at 7:43 PM]
Как всегда "везет" получать интересные проблемы. Caused by: java.lang.ClassNotFoundException: com.fasterxml.jackson.databind.ObjectMapper при создании objectMapper, при этом все зависимости на месте и даже специально вручную пробовал выключать все конфликтующие библиотеки, чтобы облегчить Мавену жизнь. Никто не встречал такого? Версии jackson пробовал разные, в том числе и делал так, чтобы они 100% совпадали (на учебном проекте аннотации имеют версию пониже и это там жить не мешает), гугл и стаковерфлоу верещат только про версии зависимостей и про наличие зависимостей в целом. (edited)


2 replies
under4eg [2 hours ago]
В общем, проблема была в том, что зависимости не попадали в out/lib. Надо было добавить ручками, но я всё сломал и потому создавал заново artifact.


Grigory Kislin [1 hour ago]
руками ничего нельзя добавлять! только чз maven


under4eg [3 days ago]
мавен наотрез отказался добавлять конкретные зависимости. возможно, бага какая-то


Grigory Kislin [1 day ago]
> мавен наотрез отказался добавлять конкретные зависимости
это как??? может у тебя режим оффлайн? или локальный каталог повредился
в любом случае это надо чинить


Sergey Zhukov [1 day ago]
На более ранний комит откатись, попробуй заново добавить зависимости.
Я когда переходил на JUnit5, удалил старые зависимости, добавил новые, у меня IDEA стала говорить что системы тестов вообще не обнаружила :hushed:. Голову поломал, где только не чистил, но помог только откат на предыдущий комит.


Grigory Kislin [1 day ago]
отделяйте мух от котлет. при чем тут idea? взяли и запустили в консоли


Grigory Kislin [1 day ago]
@Sergey Zhukov открыл:)


Raisa [Dec 26th at 4:37 PM]
еще вопрос: curl ссылку для голосования размещать в обычном виде? она до 11.00 будет работать, это же не правильно? (edited)


11 replies
Gekov Iliya [3 days ago]
Хороший кстати вопрос, не задумывался даже об этом)


Grigory Kislin [3 days ago]
@Raisa не понял... где ссылку размещать? (edited)


Gekov Iliya [3 days ago]
я думаю имелась ввиду curl ссылка в описании api


Raisa [3 days ago]
да, ссылка для голосования в readme


Raisa [3 days ago]
It should contain the code and README.md with API documentation and curl commands to get data for voting and vote


Sergey Zhukov [3 days ago]
странный вопрос, если в задании приложение должно принимать голоса до 11


Sergey Zhukov [3 days ago]
или есть незадекларированные возможности?


Raisa [3 days ago]
@Sergey Zhukov в тестах у меня, к примеру, два варианта before и after.. может тут тоже как-то так можно


Sergey Zhukov [3 days ago]
в тестах я менял на нужное мне значение до теста, и после теста восстанавливал


Grigory Kislin [3 days ago]
в read.me- в обычном виде


Dima [3 days ago]
А я делал так,чтобы те ссылки,что недоступны юзеру или просто незалогиненому человеку не показывались в ответе


Vladimir Gorbatenko [12:33 PM]
Я вот что думаю - ведь по правилам хорошего тона надо писать javadoc на все подряд, на каждый класс и метод. Кто писал? )


Sergey Zhukov [Dec 30th at 9:52 PM]
У кого-нибудь было что Postman получает в ответ на DELETE и PUT с базовой авторизацией
```There is no PasswordEncoder mapped for the id &quot;null&quot;```
даже до метода контроллера не доходит
а в IDEA RESTfull тулза с PUT и DELETE работает (edited)


1 reply
Sergey Zhukov [4 days ago]
нашел проблему, сохраняю пароль без кодировки


ABaykov [7:17 PM]
кто-нибудь сталкивался?

ABaykov [Jan 1st at 7:17 PM]
20:16:32.755 WARN  o.h.e.j.s.SqlExceptionHelper$StandardWarningHandler.logWarning:230 - SQL Warning Code: -1100, SQLState: 02000
20:16:32.756 WARN  o.h.e.j.s.SqlExceptionHelper$StandardWarningHandler.logWarning:231 - no data


1 reply
under4eg [2 days ago]
И при этом всё работает как надо, верно?


under4eg [Yesterday at 12:50 AM]
Интересно, почему хендлер исключений, сделанный по образу и подобию оного из учебного проекта, категорически не желает ловить что-либо кастомное и на всё отвечает отвалом в 500-й код? При этом возвращая нужный объект с нужной информацией в JSON (кроме кода), если есть обработчик непосредственно общих исключений Exception и убрать обработчики кастомных исключений. Всё аннотировано и расставлены приоритеты, где общий обработчик где-то совсем внизу. (edited)


7 replies
Sergey Zhukov [23 hours ago]
закоментируй на время общий метод где ловишь Exception.class и увидишь в стектрейсе какое исключение нужно отлавливать в данной ситуации


under4eg [23 hours ago]
в том-то и дело, что обработчик нижнего выбрасываемого исключения есть, а обрабатываться не хочет никак


Sergey Zhukov [23 hours ago]
покажи метод в котором ловишь кастомное


under4eg [13 hours ago]
@ResponseStatus(value = HttpStatus.BAD_REQUEST)
   @ExceptionHandler(IllegalRequestDataException.class)
   @Order(Ordered.HIGHEST_PRECEDENCE + 2)
   @ResponseBody
   public ErrorInfo votingDuplicate(HttpServletRequest req, NotFoundException e) {
       return new ErrorInfo(req.getRequestURL(), e.getLocalizedMessage());
   }


under4eg [13 hours ago]
допустим, так, это уже даже с попытками насильно просунуть его по важности выше обычного эксепшна


Sergey Zhukov [12 hours ago]
ловишь
   ```@ExceptionHandler(IllegalRequestDataException.class)```
в методе обрабатываешь
```NotFoundException e```
потому и не работает


under4eg [12 hours ago]
внимательность - моё второе я... спасибо


Dima [Yesterday at 6:10 PM]
При заполнении формы для выпускного проекта есть поле резюме,я его не заполнял,потому что не делал,так прокатит?


2 replies
Grigory Kislin [6 hours ago]
можно. поле не обязательное


Dima [5 hours ago]
Вот как раз там звездочка стоит,я там просто написал "пока нет"


Vladimir Gorbatenko [Yesterday at 6:52 PM]
Кто-то уже столкнулся с проблемой EET и EST? Как решали? Мне не очень нравится вариант указывания необходимого мне EET в аннотации к полю.


1 reply
Vladimir Gorbatenko [5 hours ago]
Решилось, в JacksonObjectMapper, добавил
```setTimeZone(TimeZone.getTimeZone("EET"));```
Работает корректно, но есть сомнения, еще сам не знаю какие. (edited)


Sergey Zhukov [1 day ago]
оно обязательно?


Vladimir Gorbatenko [1 day ago]
Нет. У меня получилось так, что я отправлял дату, чтоб мне выдало список ресторанов с едой. Контроллер её правильно принимал, правильно делался запрос в базу, правильно формировался список, в списке есть поле date, оно по ui не нужно, но по правилам хорошего тона должно быть (чтоб читая json/xml было сразу видно о какой дате идёт речь). Так вот в браузере, в json дата всегда была -1 день, а меню на правильный день. Я этот момент давно увидел, но отложил решение на потом, вот и наступило это потом.
Начал копать и понял что у приложения дата в timezone EET, а на клиент она приходит EST, т.е. маппер меняет timezone. И собственно решение - в маппере указать конкретную зону. Я бы кстати на эту тему что-то почитал бы или посмотрел видео, тема интересная.


Raisa [Yesterday at 8:44 AM]
я все думаю, что можно удалить из проекта.. что значит пункт рекомендаций "16: Используйте DATA-JPA (можно без лишней делегации, напрямую из сервиса/контроллера дергать Repository)" - из сервиса же и так напрямую репозиторий дергается, как-то еще можно? а из контроллера уже сервис. Еще Григорий говорил, что с голосами только голосование делал. Разве не нужны CRUD методы для каждой сущности?


7 replies
Dima [1 day ago]
Я не делал crud для голосов,только save,это ж задпние позиционируется как тестовое ,а не сам проект


Raisa [1 day ago]
значит нужен только тот функционал, к-рый позволяет curl-ы проверить, к-рые в ТЗ? (edited)


Sergey Zhukov [1 day ago]
в основном да, но я для ресторанов меню и юзеров сделал crud, а то как тестировать


Raisa [1 day ago]
для тестов мне и в голосах нужны get, getAll. Да и update, разве не нужен?


Vladimir Gorbatenko [1 day ago]
@Raisa, Григорий говорил о том что слой "сервис" нам не особо нужен, по причине отсутствия "сложной логики" приложения. Поэтому из контроллера сразу в репозиторий. Хотя в условии есть фраза - "P.P.S.: Asume that your API will be used by a frontend developer to build frontend on top of that." - т.е. надо сделать так, чтоб на апи можно было построить фронтэнд, а я так себе понимаю, что фронтэнд это не только интерфейс для юзеров, но и для админов, которые - "Admin can input a restaurant and it's lunch menu of the day (2-5 items usually, just a dish name and price)"... Т.е. как бы мы должны сделать полнофункциональный бэкэнд.
Пока это все писал, понял как можно было сделать лучше )))


Raisa [1 day ago]
я тоже, вроде бы, кое-что поняла ) (edited)


Grigory Kislin [12 hours ago]
:slightly_smiling_face:.
- crud для голосов совсем не факт, что и в приложении потребуется
- если в сервисе ничего, кроме делегирования, можно без него


Илья Чиликин [11:26 PM]
Кто-нибудь нашёл удачный Http-код ответа, когда проголосовать уже слишком поздно?
Как насчёт 405? (edited) 

Vladimir Gorbatenko [12:32 PM]
После изменения (улучшения :slightly_smiling_face: ) структуры БД, вылезла одна неприятность - поля аннотированные *@Transient* перестали сериализоваться в json.
В моем случае в классе _Restaurant_ есть поле _@OneToMany List<Dish> dishes_ которое используется только для ТО, которое отдается на UI и там пользователь видит, что в ресторане есть еда (на выбранный день). Так вот чтоб сказать Hibernate-у не "связывать" это поле с полем в БД (которого нет), это поле было аннотировано *@Transient*. После реструктуризации БД и добавления сущности, почему-то поле _List<Dish> dishes_ перестало сериализоваться, ресторан есть, а еды в нем нет. В контроллере, в формируемом списке ресторанов - все ок.
Битва со злым змеем решилась вот таким отключением в нашем JacksonObjectMapper:
```Hibernate5Module jacksonHibernateModule = new Hibernate5Module();
jacksonHibernateModule.disable(Hibernate5Module.Feature.USE_TRANSIENT_ANNOTATION);
jacksonObjectMapper.registerModule(jacksonHibernateModule);``` 
Но если честно, так и не понял почему раньше работало, а затем перестало, ведь объект (ТО) для сериализации не изменялся.
Статья из которой взял решение.
https://code.i-harness.com/en/q/138fa0 (edited) 
