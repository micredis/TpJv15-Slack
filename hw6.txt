Grigory Kislin [11:52 PM]
joined #hw6.

Grigory Kislin [11:52 PM]
set the channel topic: https://github.com/JavaWebinar/topjava/blob/doc/doc/lesson06.md

Grigory Kislin [11:55 PM]
- Обновил видео Обзор JDK 9/11. Миграция проекта Topjava с 1.8 на 11
  http://javaops.ru/view/resources/jdk8_11
- Добро пожаловать на урок 6: https://github.com/JavaWebinar/topjava/blob/doc/doc/lesson06.md
 HW6 достаточно большое, поэтому делаем перерыв. Кто все сделал занимается выпускным проектом, кто нет- подтягивает хвосты. (edited)
Занятие 7 по расписанию: 22.11
https://github.com/JavaWebinar/topjava (edited)

Tanya [12:00 AM]
joined #hw6 along with 18 others.

Стецко Максим [2:01 PM]
кому нужно ссылка spring 5 для профессионалов http://diamail.com.ua/book/8303.html (поступление декабрь), а пока сегодня заказал Java Persistence API и Hibernate 1700р (https://www.chitai-gorod.ru/catalog/book/1061404/) похоже последнюю забрал (стоит 2019, видимо новая редакция).
diamail.com.ua
Spring 5 для профессионалов, 5-е издание
книга Spring 5 для профессионалов, 5-е издание, Юлиана Козмина, Роб Харроп, Крис Шефер, Кларенс Хо: Книга Spring 5 для профессионалов представляет собой многолетний бестселлер, который обновлен с целью отражения функциональных средств, предлагаемых последней версией платформы Spring Framework 5 - одного из самых популярных фреймворков для разработки приложения на Java. Книга безоговорочно считается наиболее исчерпывающим и авторитетным руководством по Spring. Вы изучите основы и ключевые темы, связанные с платформой Spring. Авторы поделятся с вами собственным реальным опытом в области удаленной обработки, использования Hibernate и работы с EJB - книжный Интернет-магазин
chitai-gorod.ru
Java Persistence API и Hibernate (Бауэр К., Кинг Г., Грегори Г.)  – купить книгу с доставкой в интернет-магазине «Читай-город». ISBN: 9785970601808.
В книжном интернет-магазине «Читай-город» вы можете заказать книгу «Java Persistence API и Hibernate» (Бауэр К., Кинг Г., Грегори Г.) по низкой цене. Бесплатная доставка по всей России, скидки и акции по карте любимого покупателя!



Стецко Максим 20 hours ago
https://dmkpress.com/catalog/computer/programming/java/978-5-97060-180-8/ тут вообще 999р) но доставка только почтой России
 dmkpress.com
Java Persistence API и Hibernate (82 kB)

 
Стецко Максим 20 hours ago
это сам издатель


Zhinko [Yesterday at 3:29 PM]
После накатки патча hibernate cache стала в pom  версия hsql красным показываться. У кого такое было?
question2.png



2 replies
Grigory Kislin [19 hours ago]
если реимпорт не подтягивает- попробуй удалить
org.hsqldb.hsqldb из локального maven репозитория



Zhinko [18 hours ago]
Это помогло спасибо


fibz [Yesterday at 10:34 PM]
У меня томкат 7 не может запустить сервер в InteliJ с 11 jdk.  Это решается только апгрейдом томката?


1 reply
fonto [12 hours ago]
9.0.12 ставь


Andrew Kalugin [Nov 9th at 12:59 PM]
после патча 6_05 должны работать тесты. Почему-то ничего не работает, не только тесты. В ошибках:
13:43:13.665 WARN  o.s.context.support.AbstractApplicationContext.refresh:554 - Exception encountered during context initialization - cancelling refresh attempt: org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.annotation.AnnotationCacheOperationSource#0': Initialization of bean failed; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.config.internalCacheAdvisor': Cannot resolve reference to bean 'org.springframework.cache.annotation.AnnotationCacheOperationSource#0' while setting bean property 'cacheOperationSource'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.config.internalJCacheAdvisor': Cannot resolve reference to bean 'org.springframework.cache.jcache.interceptor.DefaultJCacheOperationSource#0' while setting bean property 'cacheOperationSource'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.jcache.interceptor.DefaultJCacheOperationSource#0': Cannot resolve reference to bean 'ehCacheManager' while setting bean property 'cacheManager'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'ehCacheManager' defined in class path resource [spring/spring-tools.xml]: Cannot create inner bean 'org.springframework.cache.jcache.JCacheManagerFactoryBean#43d65a81' of type [org.springframework.cache.jcache.JCacheManagerFactoryBean] while setting bean property 'cacheManager'; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'org.springframework.cache.jcache.JCacheManagerFactoryBean#43d65a81' defined in class path resource [spring/spring-tools.xml]: Invocation of init method failed; nested exception is java.lang.NoClassDefFoundError: javax/xml/bind/JAXBContext (edited)
ошибки в тестах.jpg



36 replies
Andrew Kalugin [3 days ago]
откатился, залил патчи по 6_02, тесты не работают :disappointed: что за ....

Gekov Iliya [3 days ago]
Посмотрите в pom зависимость по .*jaxb есть?

Andrew Kalugin [3 days ago]
<artifactId>jaxb-runtime</artifactId>
<version>2.4.0-b180830.0438</version>
такое есть


Andrew Kalugin [3 days ago]
может в ней какие проблемы. в mavan подтягиваться на отрез отказывалась. Только после обновения  IDEA и ручной заливки в репозиторий появилась в mavon


Gekov Iliya [3 days ago]
Вообще эта ошибка появляется из за этой зависимости

Gekov Iliya [3 days ago]
При переходе на джаву 11ю

Gekov Iliya [3 days ago]
Посмотрите в мавене ничего красным не подчеркнуто? А в таргет папке в либах jar - jaxb-api... И jaxb-runtime... есть?


Andrew Kalugin [3 days ago]
раньше она была красная в mavan - обновил IDEA и залил сам в jar - jaxb-api


Andrew Kalugin [3 days ago]
попробовать удалить?

Gekov Iliya [3 days ago]
Да, надо добиться чтобы мавен сам подтянул

Gekov Iliya [3 days ago]
Удалить из либ, удалить из пом, подождать пока мавен сделает апдейт и снова на место поставить зависимость, мне обычно это помогает (edited)

Andrew Kalugin [3 days ago]
щас попробую


Gekov Iliya [3 days ago]
Если не поможет, то удалить из локального репозитория мавена, чтобы он снова загрузил из инета



Gekov Iliya [3 days ago]
Ну и там соответственно clear сделать у мавена и пересобрать проект


Gekov Iliya [3 days ago]
По итогу в target -> WEB-INF ->lib должны попасть jaxb-api-2.3.1.jar и jaxb-runtime-2.3.1.jar


Andrew Kalugin [3 days ago]
почему 2.3.1? а 2.4.0-b180830.0438?


Andrew Kalugin [3 days ago]
я 2.4.0-b180830.0438 пытаюсь воткнуть

Gekov Iliya [3 days ago]
В pom мавена да, но в итоге в либы попадает этот jar (edited)

Gekov Iliya [3 days ago]
Думаю версия не столь важна, главное чтобы мавен увидел и добавил

Andrew Kalugin [3 days ago]
ааа... но 2.4.0-b180830.0438 все равно подчеркнут красным. удалил из локального репозитория - такая же хрень. По идее mavan должен же скачать новый jar


Gekov Iliya [3 days ago]
Реимпорт в мавене не помогает?


Andrew Kalugin [3 days ago]
нет


Gekov Iliya [3 days ago]
И соответственно в папке таргет как выше писал эти джарники мавен не добавляет?


Andrew Kalugin [3 days ago]
было уже это все - поэтому в ручную и заливал его в локальный репозиторий, но толку чуть


Gekov Iliya [3 days ago]
Проблема точно в этом. Если совсем ничего не помогает, может попробовать скачать самостоятельно мавен и в идее переключиться на него, вместо встроенного, может он с этой задачей справится


Andrew Kalugin [3 days ago]
неа... пробовал, в настройках уже изменил на свой mavan


Andrew Kalugin [3 days ago]
печалька :disappointed:


Gekov Iliya [3 days ago]
Черт, у меня идеи иссякли)


Andrew Kalugin [3 days ago]
у меня уже давно иссякли :))


Andrew Kalugin [3 days ago]
не.. одна осталась, пойду попробую


Andrew Kalugin [3 days ago]
@Grigory Kislin все, здаюсь. не знаю в чем дело


Grigory Kislin [3 days ago]
привет!
Илья верно сказал:
1. удалить каталог `org.glassfish.jaxb` из локального maven репозитория
2.  на всякий случай еще можно удалить `javax.xml` и `javax.activation`
3. сделать mvn clean test
можно поставить свой maven и сделать вообще из консоли, чтобы idea не мешала


Andrew Kalugin [3 days ago]
@Grigory Kislin удалил эти каталоги из локального репозитория - теперь красных строчек стало больше. Mavan просто ни чего не грузит вместо удаленных файлов. Обновил Mavan до последней версии. В чем дело не знаю.
ошибки в тестах2.jpg



Grigory Kislin [3 days ago]
@Andrew Kalugin
у тебя кнопочка опущена в idea- работа в оффлайн
в таких случаях надо отделять проблему- как я советовал из консоли мавен запускать
нажми 5ю справа кнопку в окне maven (edited)


Andrew Kalugin [3 days ago]
@Grigory Kislin спасибо!!!! я тут доки mavan как раз изучал и тоже на эту плохую... кнопку наткнулся. 2 дня убил из-за какой-то хрени.... еще раз спасибо!


Grigory Kislin [3 days ago]
это к тому, что надо к проблеме грамотно подходить.  те отделать ее последовательно- в idea проблема или в mvn например...


Dima [Nov 9th at 2:31 PM]
пункт задания 1.1 это шарада? что за mock.xml и классы тестов?


1 reply
Grigory Kislin [3 days ago]
поправил `mock.xml`->`inmemory.xml`
переименовали (edited)


Dima [3:36 PM]
и еще вопрос: куда делись style.css в патче 6.14, upd:увидел, но не сразу) (edited)


fonto [Nov 9th at 5:31 PM]
@Grigory Kislin
Вопрос такой, почему внутренние классы JdbcMealRepositoryImpl, вы сделали static?? Чтобы Спринг смог их заинжектить, я правильно понимаю?)


2 replies
Sergey Zhukov [3 days ago]
да все падает если не статик... спринг не может создать инстанс класса без создания экземпляра внешнего класса... а он абстрактный, вообще такое не провернуть ))
реализация не для слабонервных...
я делал проще, чтобы избавится от дублирования кода (чтобы не вызывать конструкторы суперкласса)
        ```public TimestampJdbcMealRepositoryImpl(JdbcTemplate jdbcTemplate, NamedParameterJdbcTemplate namedParameterJdbcTemplate) {
            super(jdbcTemplate, namedParameterJdbcTemplate);
        }```
заинжектил уже настроенный бин
    ```@Autowired
    private JdbcTemplate jdbcTemplate;
    @Autowired
    private NamedParameterJdbcTemplate namedParameterJdbcTemplate;
    @Autowired
    private SimpleJdbcInsert insertMeal;

    @Bean
    public SimpleJdbcInsert getSimpleJdbcInsert(){
        return new SimpleJdbcInsert(jdbcTemplate)
                .withTableName("meals")
                .usingGeneratedKeyColumns("id");
    }```
с новой версией HSQLDB уже не актуально


fonto [3 days ago]
Ну то что с новой версией не актуально то я понял)), мне просто было интересно, вдруг есть какая-то другая причина)


Grigory Kislin [7:30 PM]
если классу не нужен родитель, его следует делать статик

Taras [11:19 PM]
Это общее правило (рекомендация spring)?

YuriyUh [10:49 AM]
После накатки патча со спринговой локализацией, приложение при вызове из браузера падает с ошибкой, стоит ubunta, думал мож проблема с путями, но нет, локальный репозиторий мавена обновлял, в идее с помощью мыши и контрл скачет куда надо в проперти с локализациями.
org.apache.jasper.JasperException: An exception occurred processing [/WEB-INF/jsp/fragments/headTag.jsp] at line [8]

5: <head>
6:     <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
7:     <title><spring:message code="app.title"/></title>
8:     <link rel="stylesheet" href="resources/css/style.css">
9: </head>


YuriyUh [Nov 10th at 10:50 AM]
Root Cause

javax.servlet.jsp.JspTagException: No message found under code 'app.title' for locale 'ru_RU'.
    org.springframework.web.servlet.tags.MessageTag.doEndTag(MessageTag.java:293)
    org.apache.jsp.WEB_002dINF.jsp.fragments.headTag_jsp._jspx_meth_spring_005fmessage_005f0(headTag_jsp.java:174)
    org.apache.jsp.WEB_002dINF.jsp.fragments.headTag_jsp._jspService(headTag_jsp.java:135)
    org.apache.jasper.runtime.HttpJspBase.service(HttpJspBase.java:70)
    javax.servlet.http.HttpServlet.service(HttpServlet.java:741)


2 replies
vch [2 days ago]
Походит на проблемы с переменной окружения. Она точно выставлена?


YuriyUh [2 days ago]
Спасибо за подсказку, локально была выставлена, а вот  в системном окружении нет. Заработало.


lifter4ik [Nov 10th at 2:27 PM]
На что здесь IDEA возмущается? При этом все запускается нормально. У всех так?
trouble.png



13 replies
Dima [2 days ago]
Обычно так подчеркивает,если идея не может определить отображения( нет страницы jsp) с таким именем по тому пути ,который написан в viewResolver


lifter4ik [2 days ago]
Вопрос почему она не может определить-то. Все строго по патчам, ничего не менял.


Dima [2 days ago]
Ну у меня точно не подчеркивает, попробуй сделать мэйвену clean и переподключи зависимости


lifter4ik [2 days ago]
Делал, не помогает(

lifter4ik [2 days ago]
Удалил модуль Spring из Project Structure. Потом он сам находит и подчеркивания исчезают. Но в контекст автоматом не влетает spring-tools.xml. Когда вручную делаешь - подчеркивать снова начинает. Морока какая-то


lifter4ik [2 days ago]
Хотя spring-tools.xml же импортится, так что все ок


lifter4ik [2 days ago]
Понять бы просто почему при autodetected ничего не подчеркивает, а когда вручную делаешь, начинает тупить...


Dima [2 days ago]
111111.jpg



Dima [2 days ago]
ну вот у меня так выглядит структура springa, при этом ничего руками не делал


Dima [2 days ago]
и все поддерживается и не подчеркивает


lifter4ik [2 days ago]
Я про тоже, что автоматически если, то все ок сразу.


Grigory Kislin [1 day ago]
структура Spring должна быть такой, как на картинке в уроке после 9. Spring Web MVC. проверь (edited)


lifter4ik [1 day ago]
если делать в точности как на картинке из урока, то начинает подчеркивать в контроллере. первый скрин как раз при такой структуре


Zhinko [Nov 10th at 3:51 PM]
У одного меня проблема с накаткой патчей из-за bodyHeader.jsp? (edited)


1 reply
Grigory Kislin [1 day ago]
у меня все хорошо. ссылку куда смотреть кинул в личку


KaryNaiKo [Nov 10th at 4:16 PM]
Лол, как быть?
1. Не понимаю как работает и не понимаю, что не понимаю :smile:
Зачем нам mappedBy = "user" в
   @OneToMany(fetch = FetchType.LAZY, mappedBy = "user")
   @OrderBy("dateTime DESC")
   protected List<Meal> meals;
2. Как через обычный sql взять user с его едой, у нас же нет в БД связей таких


2 replies
pal548 [1 day ago]
Через обычный sql 
`Select u.*, m.*`
`From users u`
          `Left join meals m on m.user_id = u.id`
`Where u.id = :user_id` (edited)



Sergey Zhukov [1 day ago]
Если не указать *mappedBy = "user"* то связь будет односторонняя. Этот параметр указывает хиберу, что надо искать аннотацию *@ManyToOne* на поле *user*.


KaryNaiKo [Yesterday at 11:48 AM]
Я правильно понимаю, что у нас в проекте 3 способа избежать проблемы "N+1"?
1. Fetch join в запросе;
2. @BatchSize(size = 200) при jpa реализации
3. @EntityGraph при datajpa реализации
И их не обязательно все вместе использовать, так?


2 replies
Grigory Kislin [1 day ago]
+
использовать что-то одно


Grigory Kislin [1 day ago]
+ вроде еще есть варианты. например FetchMode.SUBSELECT


Gekov Iliya [Yesterday at 12:17 PM]
https://youtu.be/KuCqVD9rDqA хорошее видео по проблеме N+1
YouTube Java World
Lesson 31 - N + 1 Selects Problem
 


30 replies
Ilya [1 day ago]
да, интересно, получается что выборка н+1 при больших объемах данных выгоднее вычитывания сразу всех?


Gekov Iliya [1 day ago]
Если правильно понимаю, то да, но с использованием BatchSize


Ilya [1 day ago]
а, чтобы порциями читал, так в запросе мы такое указать не можем?


Gekov Iliya [1 day ago]
Вот этого не знаю, это же получается разбивка на несколько запросов в завистмости от объема выборки, указанного в батчсайзе, одним запросом то как это провернуть


Ilya [1 day ago]
select first 100 from user where id not in ( тут указываются ид которые уже вычитали )

Gekov Iliya [1 day ago]
Да, но мы получается получим эти 100 и всё, а нам нужно вычитать все, но запросами по 100, то есть нам нужно N/100 таких запросов (edited)


Ilya [1 day ago]
да, но если мы вычитываем с eager то там получается на каждый 100 записей 100 запросов


Ilya [1 day ago]
а просто вычитывание N/100 запросов

Ilya [1 day ago]
N - записей в таблице

Gekov Iliya [1 day ago]
Ну да, получается если мы запросы будем вручную писать, то нам нужно высчитать это N/100 и отправить это количество запросов, а аннотация батчсайз сделает это за нас, если я правильно понимаю


Ilya [1 day ago]
она работает с namedQuery?


Gekov Iliya [1 day ago]
Не знаю


Ilya [1 day ago]
я так понял что батчсайз вычитывает к примеру 200 записей и делает 200 запросов еще на связанные данные.


Ilya [1 day ago]
причем на каждую связанную таблицу


Ilya [1 day ago]
тоесть их может быть не 200))


Ilya [1 day ago]
если студен связан с курсом, с группой, историей обучения, еще какой таблицей) то вычитывание умножается на все эти списки(


Gekov Iliya [1 day ago]
Да, все это очень не просто) надо книжки серьезные почитать по хибернейту


Ilya [1 day ago]
понятно почему его не любят)


Gekov Iliya [1 day ago]
Ну если не любят, пусть придумают лучше, будем только рады, а пока придется разбираться)


Ilya [1 day ago]
я так понял просто запросами обычно делаеют)


Ilya [1 day ago]
без объектной модели


Ilya [1 day ago]
зависит конечно от задачи.


Gekov Iliya [1 day ago]
В сложных случаях по любому приходится заморачиваться


Gekov Iliya [1 day ago]
Так что к серьезной книжке по хибернейту надо прибавить серьезную книжку по sql'у)


Ilya [1 day ago]
это точно,а к ней книжку по проектированию бд и так до бесконечности) (edited)


Dima [1 day ago]
Если имплементироваться от PageAndSortRepository,то можно читать столько записей сколько хочешь.


Ilya [1 day ago]
он списки не вычитывает?


Gekov Iliya [1 day ago]
Это да, вопрос в ситуации, когда мы хотим считать именно все записи, получить адекватное время вычитки и не положить базу (edited)


Dima [1 day ago]
Он читает так ,как укажешь,eager или lazy. Надо смотреть по логам


Dima [1 day ago]
Ща приеду с работы,тоже посмотрю видос,буду с вами в теме


KaryNaiKo [3:22 PM]
В чем отличия spring cache в UserServiceImpl и hibernate cache в User?


lifter4ik [Yesterday at 4:05 PM]
Почему style.css если подключать напрямую к jsp не подключается, а через фрагменты подключается?


1 reply
lifter4ik [24 hours ago]
торможу. мы же файл перенесли в патче, а путь не поменяли. все работает.


Sergey Simonov [Yesterday at 4:39 PM]
кто как указывал что нужно игнорировать метод валидации в jdbcXXXServiceTest? Assume.assumeTrue(boolean) в начале тела метода?
когда условие игнора теста выпослняется то выводит в лог такую штуку

org.junit.AssumptionViolatedException: got: <false>, expected: is <true>
    at org.junit.Assume.assumeThat(Assume.java:95)
    at org.junit.Assume.assumeTrue(Assume.java:41)
...

кто знает как покрасивше сделать? (edited)


2 replies
Dima [22 hours ago]
в инете куча вариантов, этот самый простой. В JUnit 5 есть для этого аннотации @Disabled, но у нас пока 4-й


pal548 [21 hours ago]
можно добавить сообщение в метод `Assume.assumeTrue(String, boolean)`


pal548 [Yesterday at 8:03 PM]
Делаю контроллер спринг-МВС, но у нас в прошлом контроллере было много логики. По идее хорошо бы сделать сервис, куда всю эту логику переместить, и уже его дергать из мвс-контроллера ?


2 replies
Grigory Kislin [20 hours ago]
для юзеров есть UserServiceImpl и AbstractUserController


pal548 [20 hours ago]
так сделано, чтобы аутентификация была не в сервисах, например?


Sergey [Yesterday at 8:14 PM]
Я совсем не могу понять блок datajpa  в spring-db: зачем нужны все эти строки с "<entry key" ?
не могу понять блок datajpa  в spring-db
​
  <beans profile="jpa,datajpa">
    <bean id="entityManagerFactory" class="org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean"
       p:dataSource-ref="dataSource"
       p:packagesToScan="ru.javawebinar.**.model">
      <!--p:persistenceUnitName="persistenceUnit">-->
​
      <property name="jpaPropertyMap">
        <map>
          <entry key="#{T(org.hibernate.cfg.AvailableSettings).FORMAT_SQL}" value="${hibernate.format_sql}"/>
          <entry key="#{T(org.hibernate.cfg.AvailableSettings).USE_SQL_COMMENTS}"
              value="${hibernate.use_sql_comments}"/>
          <!--<entry key="#{T(org.hibernate.cfg.AvailableSettings).HBM2DDL_AUTO}" value="${hibernate.hbm2ddl.auto}"/>-->
​
          <!--https://github.com/hibernate/hibernate-orm/blob/master/documentation/src/main/asciidoc/userguide/chapters/caching/Caching.adoc#caching-provider-jcache-->
          <entry key="#{T(org.hibernate.cfg.AvailableSettings).CACHE_REGION_FACTORY}"
              value="org.hibernate.cache.jcache.internal.JCacheRegionFactory"/>
          <entry key="#{T(org.hibernate.cache.jcache.ConfigSettings).PROVIDER}"
              value="org.ehcache.jsr107.EhcacheCachingProvider"/>
          <entry key="#{T(org.hibernate.cfg.AvailableSettings).USE_SECOND_LEVEL_CACHE}" value="true"/>
          <entry key="#{T(org.hibernate.cfg.AvailableSettings).USE_QUERY_CACHE}" value="false"/> <!--default-->
​
<!--
          <entry key="#{T(org.hibernate.cfg.AvailableSettings).HBM2DDL_SCRIPTS_ACTION}" value="drop-and-create"/>
          <entry key="#{T(org.hibernate.cfg.AvailableSettings).HBM2DDL_SCRIPTS_CREATE_TARGET}" value="${TOPJAVA_ROOT}/config/ddl/create.ddl"/>
          <entry key="#{T(org.hibernate.cfg.AvailableSettings).HBM2DDL_SCRIPTS_DROP_TARGET}" value="${TOPJAVA_ROOT}/config/ddl/drop.ddl"/>
          <entry key="#{T(org.hibernate.cfg.AvailableSettings).HBM2DDL_AUTO}" value="create"/>
-->
        </map>
      </property>
​
      <property name="jpaVendorAdapter">
        <bean class="org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter" p:showSql="${jpa.showSql}">
        </bean>
      </property>
    </bean>
​
    <tx:annotation-driven/>
​
    <!-- Transaction manager for a single JPA EntityManagerFactory (alternative to JTA) -->
    <bean id="transactionManager" class="org.springframework.orm.jpa.JpaTransactionManager"
       p:entityManagerFactory-ref="entityManagerFactory"/>
​
    <bean class="ru.javawebinar.topjava.repository.JpaUtil"/>
  </beans>
Collapse


2 replies
Dima [18 hours ago]
https://docs.spring.io/spring/docs/4.2.x/spring-framework-reference/html/expressions.html#expressions-beandef


Dima [18 hours ago]
entry key -это пара - ключ значение.


Zhinko [Yesterday at 8:39 PM]
Делаю JspMealController так у меня при старте приложения почему то перестали работать css стили , хотя в стилях я ничего не менял. У кого такое было?


2 replies
pal548 [19 hours ago]
стили в meals.jsp прописаны в самой странице, а нужно подключать тег `<jsp:include page="fragments/headTag.jsp"/>`


Dima [18 hours ago]
попробуй в headTag.jsp заменить обьявление стилей на такое
```<link rel="stylesheet" href="${pageContext.request.contextPath}/resources/css/style.css">```


pal548 [Yesterday at 11:01 PM]
сделать сервлет без action, это нужно из браузера посылать запросы методом DELETE например, но это возможно только джаваскриптом?


3 replies
Dima [17 hours ago]
я делал get запрос meals/delete/{idMeal}


Zhinko [16 hours ago]
Я тоже так делал


pal548 [16 hours ago]
да, сам до этого тоже догадался


ABaykov [6:06 PM]
В реальном проекте часто проблему можно решить простым обновлением версии:
топовый совет
:+1:


KaryNaiKo [Yesterday at 8:22 PM]
Как в хроме сделать английское отображение проекта?


3 replies
Grigory Kislin [18 hours ago]
под видео есть
https://github.com/JavaWebinar/topjava/blob/doc/doc/lesson06.md#-10-spring-internationalization


KaryNaiKo [8 hours ago]
Я так делал, ничего не получилось(


Gekov Iliya [6 hours ago]
Еще надо в настройках выбранного языка ( chrome://settings/languages )поставить пункт, что то вроде "отобразить chrome на этом языке"


Vladimir Gorbatenko [Today at 11:10 AM]
Ребята, а кто-то понял про пункт "Занятие 6: Добавил тесты на валидацию"?
Мы ловим исключения javax, который валидирует энтити. Так вот зачем оно нам надо? (edited)


7 replies
Gekov Iliya [3 hours ago]
Ага, создаем невалидные энтити и ждем исключений (edited)


Chensy [3 hours ago]
Да, чтобы проверить что для всех полей ограничения установлены и не прокатит безнаказанно, например, создать энтитю с пустым именем


Vladimir Gorbatenko [3 hours ago]
Понял, тупо проверка того что там навалидировалось, посмотреть как проругался на кривые поля и при этом ожидаем эксепшены.


Vladimir Gorbatenko [3 hours ago]
Но что нам мешает в тестах прописать такое?
@Test(expected = ConstraintViolationException.class)
и обойтись без велосипеда... (edited)


Chensy [3 hours ago]
а ты попробуй и увидишь)


Gekov Iliya [3 hours ago]
В материалах урока по этому поводу все описано, мы же получаем целый стек исключений, а нам нужно только первоначальное, Test(expected..) его просто не увидит (edited)


Vladimir Gorbatenko [3 hours ago]
Да... Оказалось не так как ожидал.  :slightly_smiling_face:
Всем спасибо!


Maxim Valeev [Today at 12:24 PM]
После 13-го патча, запускаю плагин cargo:run и получаю это. Кто знает в чем проблема?
Untitled
"C:\Program Files\Java\jdk-11.0.1\bin\java.exe" -agentlib:jdwp=transport=dt_socket,address=127.0.0.1:62018,suspend=y,server=n -Dmaven.multiModuleProjectDirectory=D:\Study\Java\topjava "-Dmaven.home=C:\Program Files\JetBrains\IntelliJ IDEA 2018.2.2\plugins\maven\lib\maven3" "-Dclassworlds.conf=C:\Program Files\JetBrains\IntelliJ IDEA 2018.2.2\plugins\maven\lib\maven3\bin\m2.conf" -javaagent:C:\Users\Max\.IntelliJIdea2018.2\system\captureAgent\debugger-agent.jar=file:/C:/Users/Max/AppData/Local/Temp/capture2.props -Dfile.encoding=UTF-8 -classpath "C:\Program Files\JetBrains\IntelliJ IDEA 2018.2.2\plugins\maven\lib\maven3\boot\plexus-classworlds-2.5.2.jar;C:\Program Files\JetBrains\IntelliJ IDEA 2018.2.2\lib\idea_rt.jar" org.codehaus.classworlds.Launcher -Didea.version=2018.2.5 -DskipTests=true cargo:run -P postgres
Connected to the target VM, address: '127.0.0.1:62018', transport: 'socket'
[INFO] Scanning for projects...
[INFO]                                     
[INFO] ------------------------------------------------------------------------
[INFO] Building Calories Management 1.0-SNAPSHOT
[INFO] ------------------------------------------------------------------------
[INFO] 
[INFO] --- cargo-maven2-plugin:1.7.0:run (default-cli) @ topjava ---
[INFO] [en2.ContainerRunMojo] Resolved container artifact org.codehaus.cargo:cargo-core-container-tomcat:jar:1.7.0 for container tomcat9x
[INFO] You did not specify a container home nor any installer. CARGO will automatically download your container's binaries from [http://repo.maven.apache.org/maven2/org/apache/tomcat/tomcat/9.0.12/tomcat-9.0.12.zip].
[INFO] ------------------------------------------------------------------------
[INFO] BUILD FAILURE
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 1.391 s
[INFO] Finished at: 2018-11-13T20:20:29+10:00
[INFO] Final Memory: 10M/37M
[INFO] ------------------------------------------------------------------------
[ERROR] Failed to execute goal org.codehaus.cargo:cargo-maven2-plugin:1.7.0:run (default-cli) on project topjava: Execution default-cli of goal org.codehaus.cargo:cargo-maven2-plugin:1.7.0:run failed: Failed to create deployable with implementation class org.codehaus.cargo.container.tomcat.TomcatWAR for the parameters (container [id = [tomcat9x]], deployable type [war]). InvocationTargetException: Failed to parse Tomcat WAR file in [D:\Study\Java\topjava\target\topjava.war]: Failed to find file [D:\Study\Java\topjava\target\topjava.war]: D:\Study\Java\topjava\target\topjava.war (Системе не удается найти указанный путь) -> [Help 1]
[ERROR] 
[ERROR] To see the full stack trace of the errors, re-run Maven with the -e switch.
[ERROR] Re-run Maven using the -X switch to enable full debug logging.
[ERROR] 
[ERROR] For more information about the errors and possible solutions, please read the following articles:
[ERROR] [Help 1] http://cwiki.apache.org/confluence/display/MAVEN/PluginExecutionException
Disconnected from the target VM, address: '127.0.0.1:62018', transport: 'socket'
Process finished with exit code 1
Collapse


9 replies
Maxim Valeev [2 hours ago]
а если запускаю командой  mvn clean package -DskipTests=true org.codehaus.cargo:cargo-maven2-plugin:1.7.0:run  то получаю  [ERROR] Failed to execute goal org.apache.maven.plugins:maven-compiler-plugin:3.7.0:compile (default-compile) on project topjava: Fatal error compiling: invalid target release: 11 -> [Help 1]

Taras [2 hours ago]
>После 13-го патча, запускаю плагин cargo:run и получаю это
У тебя не собран .war файл (если ты запускал ранее через Run Intellij, то он делал .war exploded.
>а если запускаю командой  mvn clean package
Да, это war надо с помощью этой команды сделать. Ошибка говорит, что у тебя с версией java проблема. Проверь, мавен должен запуститься под 11-й. Скорее всего, у тебя базовая — 8-я. В таком случае (чтоб не менять базовую), из Intellij сделай в панельке Maven package (со skipTest).



Maxim Valeev [2 hours ago]
@Taras попробовал без тестов сделать пакедж, не сработало. Переключил версию джава. Теперь с команды получаю такую ошибку:
[ERROR] Failed to execute goal org.apache.maven.plugins:maven-clean-plugin:2.5:clean (default-clean) on project topjava: Failed to clean project: Failed to delete D:\Study\Java\topjava\target\cargo\installs
\tomcat-9.0.12\apache-tomcat-9.0.12\lib\websocket-api.jar -> [Help 1]


Maxim Valeev [2 hours ago]
а нет стоп, я просто не остановил старый сервер. Версия везде стоит 11 но все равно Fatal error compiling: invalid target release: 11


Taras [2 hours ago]
>Переключил версию джава
Каким образом? Поменял `JAVA_HOME` и т.п.? `java -version` что выдаёт? Перезапускал IntelliJ после этого? (edited)


Maxim Valeev [2 hours ago]
поменял переменные среды. идею не перезапускал, ща попробую


Taras [2 hours ago]
>а нет стоп, я просто не остановил старый сервер.
Поэтому файл нельзя удалить, он используется. Теперь должно сработать, если с версиями java не накосячил.


Maxim Valeev [1 hour ago]
да, все запустился. Спасибо)


Taras [1 hour ago]
:smiley:


Raisa [3 days ago]
у меня сервер запускается, но не открывается в браузере
Pasted image at 2018-11-13, 11:12 PM



Taras [3 days ago]
А что браузер пишет? Какой ты адрес пытаешься открыть?

Raisa [3 days ago]
браузер вообще не открывается , хотя сервер запустился:
Pasted image at 2018-11-14, 8:10 AM



Raisa [3 days ago]
когда без мавена запускаю, все нормально работает


Maxim Valeev [3 days ago]
Ну когда через мавен запускаешь, надо самому заходить на адрес куда приложение разворачивается, браузер сам не откроется


Raisa [3 days ago]
да, значит все работает, спасибо


Sergey Zhukov [Nov 13th at 9:11 PM]
сделал метод
```@PostMapping("filter")
...
return "meals";```
на странице
```<form method="post" action="filter">```
он работает но в урл пишет */filter*... как сделать форвард как в сервлете, чтобы после фильтра возвращал */meals*  ???


23 replies
Gekov Iliya [3 days ago]
А зачем? Можно сделать "redirect:\meals", но тогда атрибуты модели сбросятся


lifter4ik [3 days ago]
Хочется конечно, что бы фильтр сохранялся при других операциях, удалить/добавить. А он у нас и до mvc слетал. А то что в строке браузера фильтр... фильтр так фильтр, не страшно)


Sergey Zhukov [3 days ago]
в сервлете не слетал и атрибуты передавались
```request.getRequestDispatcher("/meals.jsp").forward(request, response);```


Gekov Iliya [3 days ago]
есть return "forward:/meals", но он не поддерживается при POST, так как /meals у нас - GET (если я правильно понимаю) (edited)


Sergey Zhukov [3 days ago]
ага forward из POST-метода работает только на POST-метод, я проверил, создавал @PostMapping("/meals")


Sergey Zhukov [3 days ago]
точно, сделать action=meals на странице


Sergey Zhukov [3 days ago]
все работае


Gekov Iliya [3 days ago]
Да, вариант)


Sergey Zhukov [3 days ago]
url не меняется


Sergey Zhukov [3 days ago]
:grin:


pal548 [3 days ago]
а почему вообще работает указывать action=meals, он же должен переводить на meals/meals ? У меня работает одинаково, если указывать в action="", и если action="meals" (edited)


Gekov Iliya [3 days ago]
Потому что это будет не /meals GET а /meals POST - это два разных маппинга


pal548 [3 days ago]
это понятно, у меня же маппинг стоит
@Controller
@RequestMapping(JspMealController.MEALS_PATH)
public class JspMealController extends AbstractMealController {
.....
   @PostMapping("")
   public String filterMeals(...)

и я проверил, запросы уходят в обоих случаях одинаковые


Gekov Iliya [3 days ago]
Думаю action="/meals" изменит ситуацию


pal548 [3 days ago]
да, это будет абсолютный путь, но это не подходит. Еще есть ${pageContext.request.contextPath}, но это уже если все остальное не помогло.


Gekov Iliya [3 days ago]
Я могу ошибаться, но думаю дело в том, что action="meals" без "/" и без ${pageContext.request.contextPath} - это переход на контроллер, замапленный на meals, а так как /meals указан в RequestMapping над классом, то action="" и action="meals" работают одинаково


pal548 [3 days ago]
это глюк файрфокса! Под хромом ожидаемо работает, шлёт на meals/meals


Gekov Iliya [3 days ago]
У меня не шлет


Gekov Iliya [3 days ago]
остается на /meals

pal548 [3 days ago]
а откуда браузер знает, что надо дописать вначале /topjava/, если в исходном коде страницы проставлено
<a href="meals/create">Добавить еду</a>
Страница по адресу /topjava/meals


Gekov Iliya [3 days ago]
Ну потому что адрес без "/" - это относительный путь


Gekov Iliya [3 days ago]
А вообще почти в любом обсуждении этого вопроса на стековерфлоу советуют всегда использовать ${pageContext.request.contextPath}


pal548 [3 days ago]
да, тоже к этому склоняюсь


pal548 [Nov 13th at 11:42 PM]
Вопрос по ссылкам в jsp. Сервер генерирует html `<a href="meals/create">Добавить еду</a>`, а браузер откуда-то понимает, что это ссылка на http://localhost:8080/topjava/meals/create , откуда он берет это */topjava/* ? (edited)


14 replies
Gekov Iliya [3 days ago]
https://stackoverflow.com/questions/2005079/absolute-vs-relative-urls (edited)


pal548 [3 days ago]
это всё находится на странице http://localhost:8080/topjava/meals, т.е. ссылки должны давать meals/meals


Gekov Iliya [3 days ago]
Это относительная ссылка, если мы указываем "meals" уже будучи на /meals, то путь остается этот же. Укажем другой относительный путь, то к имеющемуся уже приплюсуется новый


pal548 [3 days ago]
я для проверки задеплоился на http://localhost:8080/topjava/test, ссылки те же, "meals/create" на http://localhost:8080/topjava/meals/create


Gekov Iliya [3 days ago]
Не, вру, если указать другой относительный путь не приплюсуется, останется topjava/новый путь. Но опять же это все из-за того, что путь относительный (edited)


Gekov Iliya [3 days ago]
Тоже попробовал, все как ожидается, ссылки меняются на "http://localhost:8080/topjava/test/filter" "http://localhost:8080/topjava/test/meals/create" и т.п.


Gekov Iliya [3 days ago]
http://localhost:8080/topjava/meals/create соответственно не находит


pal548 [3 days ago]
сменил контекст? Я неточно выразился, не задеплоился на тест, а страницу с едой замаппил на /test. Пробовал и задеплоиться на другой аппликейшн-контекст, да, браузер откуда-то узнал об этом новом контексте


Gekov Iliya [3 days ago]
Ну как раз получается берется наш базовый путь http://localhost:8080/topjava/ и к нему все относительные ссылки и плюсуются


pal548 [3 days ago]
да, но откуда браузер знает про этот путь, непонятно


shomnest [2 days ago]
@pal548 у тебя же в конфигурации томката деплой стоит на /topjava


Grigory Kislin [20 hours ago]
относительная ссылка когда браузер берет текущий url и меняет его последнюю часть


pal548 [19 hours ago]
@Grigory Kislin вроде он к контексту приложения добавляет, нет?


Grigory Kislin [1 hour ago]
нет. браузер понятия не имее что это такое


Sergey Zhukov [Nov 14th at 10:24 AM]
```6: В MealController общую часть @RequestMapping(value = "/meals") лучше вынести на уровень класса```
что это означает?


6 replies
Gekov Iliya [2 days ago]
Над классом вешаем эту аннотацию, все остальные маппинги над методами будут плюсоваться к этому


Dima [2 days ago]
Значит под @Controller написать @RequestMapping, и следовательно в методах отталкиваться от этого


Sergey Zhukov [2 days ago]
это рекомендация, можно этого и не делать?


Gekov Iliya [2 days ago]
Ну да, но так симпатичнее имхо


Sergey Zhukov [2 days ago]
плюсоваться будут если нет вначале мапинга слеша "/" ?
т.е относителььные (edited)


Sergey Zhukov [2 days ago]
переделал, но css отваливается в фильтре, пришлось добавить
```${pageContext.request.contextPath}```


Marat [Nov 14th at 11:14 AM]
Удалить сервлеты и перенести функциональность MealServlet в JspMealController контроллер (по аналогии с RootController). По аналогии в методе идет Model, а нам нужно userId взять из HttpServletRequest request


1 reply
Sergey Zhukov [2 days ago]
userId уже установлен в SecurityUtil
меняется в RootController
из request его доставать не нужно, его там нет (edited)


Maxim Valeev [Nov 14th at 11:30 AM]
я правильно понимаю что в web.xml листенер поднимает контексты апп и дб? (edited)
Untitled
<listener>
    <listener-class>org.springframework.web.context.ContextLoaderListener</listener-class>
</listener>
<context-param>
    <param-name>contextConfigLocation</param-name>
    <param-value>
      classpath:spring/spring-app.xml
      classpath:spring/spring-db.xml
    </param-value>
</context-param>
Collapse


2 replies
Taras [2 days ago]
Да. Контрекст Spring MVC не поднимает их автоматически.


Maxim Valeev [2 days ago]
Спасибо


Marat [Nov 14th at 12:27 PM]
Подскажите зачем в проекте ru.javawebinar.topjava.to.MealTo ?


2 replies
Ansseii [2 days ago]
Это Transfer Object? И везде отдаем мы именно его?


Taras [2 days ago]
Да, было объяснение в видео ранее.


Andrew Kalugin [Nov 14th at 12:54 PM]
Как сделать, например, update? нужно данные передать на mealForm.jsp. Как это сделать?
делаю так

   @GetMapping("/meals/update/{id}")
   public String updateMeals(@PathVariable int id, Model model) {
       int userId = SecurityUtil.authUserId();
       Meal meal = service.get(id, userId);
       model.addAttribute("meal", meal);
       return "forward:/mealForm";
   }
как достать данные в mealForm.jsp?


7 replies
Sergey Zhukov [2 days ago]
Без forward отдавай mealForm.
На странице доставай из meal.
В сервис можно не лазить, если наследовался от существующего контроллера, используй унаследованные методы. (edited)


Andrew Kalugin [2 days ago]
??? так можно было? :slightly_smiling_face: имеешь ввиду MealRestController?


Sergey Zhukov [2 days ago]
```1.3.2 в одном контроллере нельзя использовать другой. Чтобы не дублировать код можно сделать наследование контроллеров от абстрактного класса.```


Andrew Kalugin [2 days ago]
в 1.3.2 вообще не понимаю о чем речь. Я пишу свой контроллер, ни какой другой  не использую.  Или нужно запилить общий абстрактный контролер и от него унаследовать MealRestController и мой контроллер?


Andrew Kalugin [2 days ago]
просто строчка выше сбивает - MealRestController у нас останется, с ним будем работать позже.


Sergey Zhukov [2 days ago]
правильно - пилим абстрактный класс и наследуемся... как в 5 с тестами, тут так же. MealRestController будет пустым, ничего страшного :slightly_smiling_face:



Andrew Kalugin [2 days ago]
спасибо, буду пробовать!:+1:


Marat [Nov 14th at 5:35 PM]
Почему у нас каскадное удаление в еде?
Разве не должно быть наоборот у юзера?
@ManyToOne(fetch = FetchType.LAZY)
   @JoinColumn(name = "user_id", nullable = false)
   @OnDelete(action = OnDeleteAction.CASCADE)
   @NotNull
   private User user;


1 reply
Dima [1 day ago]
эта аннотация будет влиять, если ты будешь генерировать таблицы автоматически hibernatом. У нас внешний ключ и соответственно каскадное удаление обьявляется в таблице meals, следовательно и @OnDelete должен присутствовать в сущности Meal


pal548 [Nov 14th at 11:20 PM]
Подзабыл, зачем у нас профиль tomcat ? В настройках профилей в web.xml стоит профиль postrgres. И еще, где мы указываем, что настройки пула брать из resources/tomcat/context.xml ?


3 replies
Gekov Iliya [1 day ago]
Для запуска приложения с cargo плагина. Указываем в pom в конфигурации этого плагина <file>src/main/resources/tomcat/context.xml</file>


pal548 [1 day ago]
спасибо!


Gekov Iliya [1 day ago]
Там же кстати и профиль этот указывается <spring.profiles.active>tomcat,datajpa</spring.profiles.active>


Raisa [Yesterday at 6:06 AM]
подскажите, пожалуйста, как разрезолвить бин JpaUtil в JdbcUserServiceTest? я нагуглила способы как устранить unsatisfied dependency при поднятии контекста через JavaConfig, но в этом проекте используются аннотации + xml



19 replies
Sergey Zhukov [1 day ago]
в видео сказано как починить, я вынес в отдельный абстрактный класс


Raisa [1 day ago]
да, посмотрела, после того как добавляешь пакет для сканирования, нужно как-то сказать ему какую именно реализацию репозитория брать. но как?

Raisa [1 day ago]
я посмотрела видео Тестирование UserService через AssertJ начиная с 11.30 - не добавилось понимания, т.к. там другая ситуация разбирается (когда всего две реализации - для одной сужали пакет сканирования, для другой добавляли xml-файл в директорию test, сейчас их 4 и xml в test - не вариант, насколько я понимаю), хотя проблема та же; пересмотрела два видео Борисова про спринг контекст, там не говорится про выбор конкретной реализации бина. Может я вообще не то смотрю?


Sergey Zhukov [1 day ago]
не пойму это Optional что-ли или 1.1?


Raisa [1 day ago]
это еще 1.2 Починить Jdbc тесты (валидацию исключить) :joy:


Raisa [1 day ago]
у меня только jdbc тесты для meal работают, для user отваливаются. Интересно, у всех так? или я патчи не так накатила? (edited)


Sergey Zhukov [1 day ago]
JpaUtil не должен попадать в JdbcUserServiceTest и не должно быть обращение к нему в @Before


Sergey Zhukov [1 day ago]
поэтому все это я вынес в отдельный абстрактный класс, jpa это все наследует, а jdbc наследует общий класс
 


Sergey Zhukov [1 day ago]
видео 6_03 с 12 минуты


Sergey Zhukov [1 day ago]
я валидацию исключил без условия, у нас все равно есть разделение по профилям, просто переопределил в классах testValidation и вызвал Assume.assumeTrue(false);


Raisa [1 day ago]
починила контекст, спасибо :+1: только не уверена, что правильно, глубокого понимания пока нет. После выделения абстрактного класса для jpa тесты в JdbcUserServiceTest работают, падают только валидация и getAll: ожидался один юзер с ролью null, а пришло два с ролями админ и юзер. Проблема с getAll - это отдельная проблема, не связанная с контекстом или я неправильно починила?


Sergey Zhukov [1 day ago]
это в Optional надо проверять и роли, еще добавить роль админу... а в 1 пункте мы все еще игнорим поля roles в тестах, должно все проходить


Raisa [1 day ago]
наверное да, роли игнорятся, а тест не проходит, потому что два юзера приходит, а ожидается один

Sergey Zhukov [1 day ago]
почему один?

    ```@Test
    public void getAll() throws Exception {
        List<User> all = service.getAll();
        assertMatch(all, ADMIN, USER);
    }```


Raisa [1 day ago]
наоборот, наверное, нужно два, а приходит один
Pasted image at 2018-11-15, 2:10 PM


Sergey Zhukov [1 day ago]
с кэшем то правильно все? потому что в jdbc надо тоже инвалидировать кеш в @Before (edited)



Igor [1 day ago]
@Sergey Zhukov Подскажи, зачем в `JdbcMealServiceTest.testValidation()` нужно `Assume.assumeTrue(false);`? Почему не оставить без реализации? И почему false, а не true?


Sergey Zhukov [1 day ago]
@Igor задание игнорить
потому что пустой тест выглядит странно, зачем тогда его создавать :slightly_smiling_face:
*true* это же значит делай все что следует далее
я сначала сделал в базовом классе с перебором профилей, строк больше )


Igor [1 day ago]
Все. Понял. Почитал документацию Assume.assumeTrue: _If called with an expression evaluating to false, the test will halt and be *ignored*._ (edited)


Andrew Kalugin Yesterday at 12:20 PM
Подскажите тесты JdbcUserServiceTest перед Optional должны ведь работать. В 1.2 их же чинили. Все работало. Делал 2.1, стал проверять тесты - отвалились.
Ругается на:
org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name 'ru.javawebinar.topjava.service.jdbc.JdbcUserServiceTest': Unsatisfied dependency expressed through field 'jpaUtil'; nested exception is org.springframework.beans.factory.NoSuchBeanDefinitionException: No qualifying bean of type 'ru.javawebinar.topjava.repository.JpaUtil' available: expected at least 1 bean which qualifies as autowire candidate. Dependency annotations: {@org.springframework.beans.factory.annotation.Autowired(required=true)}.
Раньше наличие JpaUtil не мешало им работать.

Sergey Zhukov 1 day ago
не должно отваливаться, в 1.2 нужно не только заигнорить валидацию, но и сделать так чтобы JpaUtil  не попадал в JdbcUserServiceTest

Andrew Kalugin 1 day ago
логично.... блин,  до этого он нормально работал. JpaUtil вроде не трогал. Может перетощил что-нибудь случайно :slightly_smiling_face: буду разбираться

Gekov Iliya 1 day ago
Это не случайно, это часть задачи по починке тестов

Andrew Kalugin 21 hours ago
@Gekov Iliya в том-то и дело, что все работало - 10 раз проверил, все отлично запускалось, валидация игнорилась, а тут оказывается не все так просто. Сейчас починил уже!
Но вот теперь думаю.... до 12 ночи нельзя сазиживаться.... вероятно я вместо JdbcUserServiceTest 10 раз запускал JdbcMealServiceTest :rolling_on_the_floor_laughing: другого объяснения не могу придумать :slightly_smiling_face:



Ilya A. Kvyatkovsky [Yesterday at 12:43 PM]
А особого приглашения на HW7 не будет? Или я что-то пропустил? (edited)


7 replies
Dima [1 day ago]
22 ноября


Ilya A. Kvyatkovsky [1 day ago]
@Dima как это? :open_mouth: почему?


Ansseii [1 day ago]
Смотрите расписание курса


Dima [1 day ago]
@Ilya A. Kvyatkovsky ну типо сложное задание + выпускной проект пилить


Ilya A. Kvyatkovsky [1 day ago]
Спасибо! Пилю.


Sergey Zhukov [23 hours ago]
@Ilya A. Kvyatkovsky домашку всю запилил?


Ilya A. Kvyatkovsky [22 hours ago]
Unfortunately no! I have problems with base knowledges in Spring/Hibernate and now I try pull up my knowledges with help graduate project.


indisbk [Yesterday at 2:24 PM]
Подскажите по пункту 2.2 Добавить еще одну роль к ADMIN (будет 2 роли: ROLE_USER, ROLE_ADMIN). И так же две роли есть, куда добавлять то?)


10 replies
Dima [1 day ago]
имеется в виду добавить юзеру Admin вторую роль


indisbk [1 day ago]
ясно, а в чем цимес? это ради последующих пунктов?


Dima [1 day ago]
ну к тому, что админ тоже является юзером, да и потом, когда будем делать security, там разным ролям будем разрешать что либо. Админ должен уметь все)


indisbk [1 day ago]
странно, почему нельзя просто делать проверку на админ и юзер, а нужно делать на юзер и админ + юзер)


Taras [1 day ago]
Так проще. Ты разрешаешь выполнение метода человеку с ролью USER, и тебя не волнует больше ничего. Админ с ролью юзер, или не админ — не важно. Наглядно видно: вот этому с конкретной ролью разрешено. На практике у меня есть программа, где я хоть с ролью админ, но не во всех других ролях прописан, чтоб интерфейс не мешал (ну или случайно чек не мог подписать).


indisbk [24 hours ago]
ясно, спасибо)


Grigory Kislin [20 hours ago]
вообще мы делаем пример того, как у юзера может быть несколько ролей. и смотрим на грабли, которые вылезают с базой


Sergey Zhukov [17 hours ago]
@Grigory Kislin это ситуация когда *у всех* роль ROLE_USER и у админов вторая роль ROLE_ADMIN? тогда запрос будет проще, а одну роль будет сетить всем пользователям, которых достаем из базы (edited)


Grigory Kislin [17 hours ago]
нет. роли произвольные. мы счас на логику приложение как оно с ролями работает вообще не смотрим


Sergey Zhukov [16 hours ago]
:slightly_smiling_face: берем длиииинные грабли


Maxim Valeev [Yesterday at 2:50 PM]
Всем привет. Уже видел этот вопрос в одном из обсуждений, но не смог разобраться все равно. Как сделать так чтоб фильтр не сбрасывался после других манипуляций с едой на странице?


7 replies
Andrew Kalugin [1 day ago]
Я делал action="filter" на jsp странице. И соответствующий обработчик в контроллере. Правда адрес меняется, но все работает


Maxim Valeev [1 day ago]
а если ты филтруешь а потом жмешь например на "добавить еду" адрес же стакается с фильтром и получается что-то типа http://localhost:8080/topjava/meals/meals/create


Maxim Valeev [1 day ago]
или ты в jsp везде используешь ${pageContext.request.contextPath} для пути ? например ${pageContext.request.contextPath}/meals/create (edited)


Andrew Kalugin [1 day ago]
сейчас не могу точно сказать, от компа далеко. проверить нужно. вроде работало норм.


Maxim Valeev [1 day ago]
а в delete redirect:/meals возвращал, не помнишь? (edited)


Andrew Kalugin [1 day ago]
помоему да - redirect:/meals


Andrew Kalugin [22 hours ago]
@Maxim Valeev проверил. у меня тоже фильтр сбрасывается. но все операции после фильтрации корректно работают.
какая-то хрень творится, точно помню фильтр не сбрасывался, может в идеи что-то изменил, а в браузере еще старый кэш висел и подумал, что все отлично. (edited)


Vladimir Gorbatenko [Yesterday at 5:13 PM]
2.4 Починить тесты в JdbcUserRepositoryImpl (добавить роли). Доставать можно двумя способами: одним запросом с JOIN либо двумя запросами: отдельно users и отдельно roles.
Не могу найти инфу, как одним запросом (c JOIN) уложить все роли в юзера,
С самим запросом проблем нет. Непонятка именно в том как воткнуть роли в юзера.


1 reply
Zhinko [21 hours ago]
Ну я лично свой ResultSetExtractor делал


Maxim [Yesterday at 8:50 PM]
Помогите с 1.1, никак не пойму как должен родиться WebApplicationContext в inmemory.xml


2 replies
Gekov Iliya [19 hours ago]
Посмотри в чем проблема в InMemory тестах, идея подсказывает - не получается инжектить бины контроллера. Соответственно нам нужно указать в inmemory, где их искать


Maxim [19 hours ago]
спасибо. решение проще чем я думал.


Sergey Zhukov [Yesterday at 11:04 PM]
Кто еще делает одним запросом к базе?
Нормально  возвращать пользователей с ролями в виде такой таблицы, которую мой мапер раскладывает по полям?
subselect1.png



4 replies
pal548 [17 hours ago]
чукча хитрый однако)


Grigory Kislin [17 hours ago]
c join по другому никак:)


Sergey Zhukov [16 hours ago]
вот тут интересные примеры по различным JOIN, мне помогли немного разобраться
http://www.skillz.ru/dev/php/article-Obyasnenie_SQL_obedinenii_JOIN_INNER_OUTER.html
skillz.ru
Объяснение SQL объединений JOIN: LEFT/RIGHT/INNER/OUTER - Блог разработчика
Объяснение SQL объединений JOIN: LEFT/RIGHT/INNER/OUTER. Блог разработчика
 


Vladimir Gorbatenko [7 hours ago]
костыль-way )


fibz [10:07 AM]
Когда будет 7 урок?

Tanya [10:54 AM]
через неделю
https://topjava15.slack.com/archives/CDXHK5KKJ/p1541627814003300 (edited)


Raisa [Today at 11:27 AM]
вопрос по заданию 1.3.1: почему, когда нажимаю "update" в браузере, не мапится сюда:
@GetMapping("/meals/update/{id}"), а сюда попадает: @GetMapping({"/meals", "/meals/all"})?
в адресной строке отображается: http://localhost:8080/topjava/meals?action=update&id=100007 (edited)


3 replies
Dima [4 hours ago]
потому что у тебя передается параметр action, который надо ловить в контроллере. Чтоб работало как у тебя, надо из jsp страницы делать запрос
```/meals/update/{id}```


Dima [4 hours ago]
Если поточнее, то
```/meals/update/${meal.id}```


Raisa [4 hours ago]
спасибо!


Sergey Zhukov [Today at 1:13 PM]
Сейчас тест *update* для обновления записи в базе работает, я его даже не менял, потому что мы не меняем роли у юзера,
Надо делать тест на изменение роли?
Роль может быть user, admin, user+admin. Если надо менять роль, то логика какая будет?
*user --> admin, admin --> user*  удаляем роль и добавляем новую или меняем существующую? Проще конечно удалять все роли и добавлять из переданного объекта. (edited)



1 reply
Grigory Kislin [1 hour ago]
я сделал тут как проще:)


Sergey Zhukov [9:54 PM]
2.4.2 можно делать через SimpleJdbcInsert, циклом по ролям?? мне кажется batchUpdate() делает что-то подобное, да и метод еще нужно городить для этого :thinking_face:

Vladimir Gorbatenko [12:03 PM]
Григорий, в pom.xml в разделе <build><plugins>, изначально у нас было 2 плагина. Зачем они были нужны, какую роль выполняют? Затем мы подключили еще  плагин cargo, в котором есть контейнер и конфигурация. Если честно, совершенно непонятно что это все, и как оно работает. Объясни пожалуйста хотя бы вкратце, а то этот раздел как черный ящик, которому приходится верить "на слово".
Сюда же можно еще спросить про раздел <profiles>:
1) почему hsqldb указан как "самостоятельный" профайл, а в postgres дополнительно присутствует зависимость tomcat.
2) связаны эти профайлы или нет с разделом plugins? и с вот этим указанием активных профайлов <spring.profiles.active>tomcat,datajpa</spring.profiles.active>?
Как-то у меня все закашилось.... (edited)


Raisa [Nov 17th at 12:09 PM]
добавляю локализацию в mealForm.jsp, в этой строке <h2><${param.action == 'create'? 'Create meal' : 'Edit meal'}></h2> можно без скриплета сделать локализацию?


11 replies
Sergey Zhukov [8 days ago]
я через *<c:if* по id сделал, я так и не понял как в тернарник ${... вставлять ${.. (edited)


Raisa [8 days ago]
спасибо, попробую через с:if


Raisa [8 days ago]
@Sergey Zhukov я чет не пойму как связать ссылку на create c условием.. присвоить ссылке id, а как его достать в c:if? (edited)


Dmitriy [8 days ago]
я добавил в model атрибут add и так сделал ${add == 'add' ? 'Create meal' : 'Edit meal'}


Sergey Zhukov [8 days ago]
@Raisa всегда передаем meal на эту jsp, meal.id или null(когда create) или нет, вставляем переменные локализации вместо слов


Raisa [8 days ago]
спасибо :+1:


Sergey Zhukov [8 days ago]
@Raisa нашел способ короче - прямо в spring:message вставить тернарник  :grin:


Raisa [8 days ago]
@Sergey Zhukov :+1: попробую тоже :slightly_smiling_face:


Raisa [6 days ago]
@Sergey Zhukov как ты его туда вставил? :exploding_head:


Sergey Zhukov [6 days ago]
@Raisa ну месадж начни <spring:message .. "meals.${тернарник...}"/>


Raisa [6 days ago]
и ведь работает :slightly_smiling_face: спасибо, теперь знаю, что еще и так можно


Vladimir Gorbatenko [Nov 17th at 12:22 PM]
Вопрос про spring_db.xml и профиль tomcat.
<beans profile="tomcat">
       <jee:jndi-lookup id="dataSource" jndi-name="java:comp/env/jdbc/topjava"/>
       <context:property-placeholder location="classpath:db/tomcat.properties" system-properties-mode="OVERRIDE"/>
</beans>
Как я понимаю, данный БД-профиль как обертка над драйвером к БД, у нас это postgres, но можно подсунуть и любой другой драйвер (из поддерживаемых). Правильно ли я понимаю? И зачем оно нам в проекте, показать что такая возможность есть, или смысл где-то глубже ?


1 reply
Sergey Zhukov [8 days ago]
Вроде этот профиль для настройки пула конектов к базе, т.к. создавать конекты дорого. Можно это настроить в xml самого tomcat'a


Roman Baranov [Nov 17th at 8:27 PM]
кто нибудь сталкивался:
запускаю server с приложением из intellij idea.
если через run то все работает корректно
а если через debug то получаю `HTTP Status 500 – Internal Server Error` из за
```javax.servlet.jsp.JspTagException: No message found under code 'app.title' for locale 'en_US'.
    org.springframework.web.servlet.tags.MessageTag.doEndTag(MessageTag.java:293)```


2 replies
Grigory Kislin [6 days ago]
а в run ты параметр JVM с -DTOPJAVA_ROOT не настраивал?


Roman Baranov [6 days ago]
@Grigory Kislin да я переменную настраивал через Intellij IDEA.
большое спасибо, разобрался. я не обращал внимание а там оказывается есть отдельная настройка переменных для разных режимов запуска приложения - `Run, Debug, Coverage`.
думаю что произошли какие то изменения в самой Intellij (я как раз перед этим обновлся на новую версию), т.к. раньше все работало


Vladimir Gorbatenko [1:16 PM]
Григорий, скажи, если у нас есть такое:
<dependencyManagement>
       <dependencies>
           <dependency>
               <groupId>org.springframework</groupId>
               <artifactId>spring-framework-bom</artifactId>
               <version>${spring.version}</version>
               <type>pom</type>
               <scope>import</scope>
           </dependency>
       </dependencies>
   </dependencyManagement>

тогда зачем мы держим отдельно еще и такую зависимость?

<dependency>
           <groupId>org.springframework</groupId>
           <artifactId>spring-test</artifactId>
           <scope>test</scope>
</dependency>
ведь она входит в состав spring-framework-bom.
Или все дело в <scope>test</scope>?


Nikita Ganin [Nov 18th at 3:03 PM]
Что нужно сделать с пунктом 2.1 добавление транзакционности? Просто добавить DataSourceTransactionManager в spring-db и прописать transactional над нужными методами? Как протестить что все в одной транзакции?


1 reply
Vladimir Gorbatenko [7 days ago]
Да, просто добавить. И над классом тоже.
Тестить можно так:
log.debug("Transaction active:::: {}", TransactionSynchronizationManager.isActualTransactionActive());


Nikita Ganin [Nov 18th at 3:10 PM]
Для чего в пункте 2.2 нужно добавить еще роль для админа?


1 reply
Vladimir Gorbatenko [7 days ago]
Для того чтоб потом чинить JDBC реализацию.


fonto [Nov 18th at 11:58 PM]
Почему у нас поле registered Date, а не LocalDate или LocalDateTime?


2 replies
Sergey Zhukov [7 days ago]
вроде чтобы часовой пояс учитывать
т.е. если одновременно регятся с разных континентов, время в базе было одно и тоже
а вот еду с разных континетов добавленную в одну секунду - будет уже хранить с конкретным временем и датой не зависещей от временной зоны
:face_with_rolling_eyes:


fonto [7 days ago]
Ну а разве localdatetime.now() не тоже самое делает?


Andrew Kalugin [Nov 19th at 8:57 AM]
Как 2.4  делали? Достать пользователя вместе с ролями.
Сделал с помощью JOIN и ResultSetExtractor парсит запрос, но порядок не сохраняет. Может кто подскажет с направлением решения? :slightly_smiling_face:


14 replies
Sergey Zhukov [7 days ago]
порядок чего? роли в сете не нуждаются в порядке, а записи запросом *Order by* должны в нужном порядке вернуться


Andrew Kalugin [7 days ago]
порядок отсортированных user-ов почему-то ломается. ResultSetExtractor собирает все в map, а потом отдает list. и где-то все это ломается, может слишком заглул с обработкой :slightly_smiling_face:


Alla Protopopova [7 days ago]
https://docs.oracle.com/javase/tutorial/collections/implementations/map.html
docs.oracle.com
Map Implementations (The Java™ Tutorials >                     Collections > Implementations)
This collections Java tutorial describes interfaces, implementations, and algorithms in the Java Collections framework


Alla Protopopova [7 days ago]
Смотри разницу между HashMap, TreeMap и LinkedMap. Я тоже на это напоролась)


Andrew Kalugin [7 days ago]
@Alla Protopopova спасибо за наводку :slightly_smiling_face: что-то я ступил конкретно, очевидная вещь.


Alla Protopopova [7 days ago]
Не ты один грешен)))))))


Zhinko [6 days ago]
А почему сразу не сделать чтобы собирало в list? Я так делал


Sergey Zhukov [6 days ago]
:joy: от ребенка иногда слышится МаПа, я думаю какая хеш или три, оказывается обоих родителей зовет на помощь



Andrew Kalugin [6 days ago]
@Zhinko Проще добавлять user-ов получается. Если правильный join написать, то по проще можно сделать. Но у меня с join проблема, самый простой смог собрать, а вот по сложнее не выходит (edited)


Zhinko [6 days ago]
@Andrew Kalugin Но я немного помучился, но у меня получилось в ExtractData сразу в лист сделать)


Andrew Kalugin [6 days ago]
@Zhinko а join какой получился? у меня просто с user_roles по user_id. может ссылочка какая есть полезная почитать? :slightly_smiling_face: (edited)


Zhinko [6 days ago]
@Andrew Kalugin Обычный join. Если хочешь скину в личку, что у меня получилось.


Andrew Kalugin [6 days ago]
@Zhinko давай, интересно глянуть


Vladimir Gorbatenko [6 days ago]
да, свой ResultSetExtractor это тема!


Alex [Nov 20th at 5:05 AM]
Всем привет, застрял на 1.3, не могу проверить как работает контроллер на развернутом приложении, т.к. при старте выпадает эксепшн "org.apache.jasper.JasperException: javax.servlet.ServletException: javax.servlet.jsp.JspTagException: No message found under code 'app.title' for locale 'ru_RU'." Нарыл, что надо настроить переменные окружения в томкат во вкладке edit configuration. Настроил, не помогло. Кто сталкивался, подскажите
Pasted image at 2018-11-20, 10:05 AM



2 replies
Sergey Zhukov [6 days ago]
Системная переменная  TOPJAVA_ROOT настроена? в 10 видео 5:40



Alex [6 days ago]
Спасибо за подсказку. Сработало, когда добавил ее в конфиги томката


regorov [Nov 21st at 3:41 AM]
У кого-нибудь было такое? В jdbcUser тест на метод getAll отдельно отрабатывает с успехом, но если с остальными тестами то падает. Причина:

Expecting:
<[User{id=100001, email=admin@gmail.com, name=Admin, enabled=true, roles=[ROLE_USER, ROLE_ADMIN], caloriesPerDay=2000}]>
to be equal to:
<[User{id=100001, email=admin@gmail.com, name=Admin, enabled=true, roles=[ROLE_USER, ROLE_ADMIN], caloriesPerDay=2000},
   User{id=100000, email=user@yandex.ru, name=User, enabled=true, roles=[ROLE_USER], caloriesPerDay=2000}]>

По списку тестов слева внизу перед ним идет тест delete как раз этого отсутствующего юзера (совпадение??)
Это как так получается скрипт на возврат БД к исходному состоянию не отрабатывает?
Как можно проверить базу в этот момент, как иначе продиагностировать? (edited)


1 reply
Grigory Kislin [4 days ago]
проверь, возвращается ли база к исхоному состояние в предыдущем тесте. не портятся ли кэши. не портишь ли константы.
состояние базы можно в тесте распечатать (edited)


regorov [3:56 AM]
Разобрался, это кеш первого уровня... Его надо было оставить в jdbc
5 утра, можно комитить ДЗ и просыпаться на работу через 2 часа:grinning:


alabra [Nov 21st at 9:12 AM]
Подскажите с пунктом: 2.4 Починить тесты в JdbcUserRepositoryImpl (добавить роли). Доставать можно двумя способами: одним запросом с JOIN либо двумя запросами: отдельно users и отдельно roles
Кто нибудь делал одним запросом? Я попробовал сделать одним запросом, но из-за left join к ролям строчки дублируются. Пришлось вручную обходить в цикле результат запроса и анализировать строчки с пользователями и ролями. Есть ли более правильное решение как сделать одним запросом в List<User> с ролями? В какую сторону посмотреть? (edited)


45 replies
Alla Protopopova [5 days ago]
Я сделала одним запросом с Left join. Из-за дублирующихся строчек писала свой ResultSetExtractor, который обрабатывает resultSet и на выходе отдает уже правильный лист.



Sergey Zhukov [5 days ago]
Смотри в сторону группировки результатов.
Я делал одним запросом и через свой RowMapper.


alabra [5 days ago]
Подскажите как правильно сделать установку ролей при обходе resultSet? Столкнулся с проблемой. Если использовать getter, то он возвращает Set<Role>. Т.к. это абстрактный тип, то add сделать не дает (java.lang.UnsupportedOperationException
    at java.base/java.util.AbstractCollection.add(AbstractCollection.java:267)). Как правильно это делать? Я преобразовал в HashSet результат геттера, добавил роль, потом обратно установил сеттером


alabra [5 days ago]
Группировку имеется ввиду в sql group by? (edited)


Sergey Zhukov [5 days ago]
да, возвращал из базы без дублей


Alla Protopopova [5 days ago]
user.getRoles().add(role); прекрасно работает. UnsupportedOperationException по какой-то другой причине кидается


Sergey Zhukov [5 days ago]
это приведенный тип, внутри лежит конкретная реализация


Alla Protopopova [5 days ago]
Как ты создаешь Set, когда у пользователя еще нет ни одной роли? (edited)


Alla Protopopova [5 days ago]
Если Set.of(role), то он вроде бы неизменяемым создается. Тогда при попытке Set.add() будет UnsupportedOperationException кидаться как раз...


Sergey Zhukov [5 days ago]
конструктор User() принимает Collection<Role> roles
я при создании вообще туда отдаю ArrayList


Alla Protopopova [5 days ago]
Если я правильно поняла, то ты отдаешь в конструктор пустой ArrayList. Тогда получается так: из конструктора вызывается setRoles и, так как коллекция пустая, в переменную roles инициализируется Collections.emptySet(). Вот он потом и кидает тебе UnsupportedOperationException, потому что в него нельзя ничего добавлять, он неизменяемый


Alla Protopopova [5 days ago]
Передавай в конструктор сразу Collections.singleton(role) и проблем не будет


alabra [5 days ago]
а точно спасибо не догадался посмотреть в сеттер что он создает empySet. Да проблема была в этом.


alabra [4 days ago]
Пришлось из-за этого сеттера переделывать реализацию :slightly_smiling_face: Мне кажется у @Grigory Kislin здесь ошибка. В чем смысл такого сеттера с точки зрения бизнес логики? Пользователя без ролей мы можем создать. Но если мы создали пользователя без ролей, то добавить роли уже нельзя. Или я что-то пропустил?


Alla Protopopova [4 days ago]
Мне тоже не совсем понятен данный момент(

Grigory Kislin [4 days ago]
переделали - ок. я сразу готовый set вставляю, те мне не требуется. все по потребности приложения.
думаю, что тоже поправлю (edited)


alabra [4 days ago]
@Sergey Zhukov Подскажите как вы сделали через группировку и свой RowMapper. Не могу понять с какой стороны подойти? При использовании Group by в запросе по user для ролей придется использовать агрегатную функцию чтобы избежать дублирования?


Sergey Zhukov [4 days ago]
@alabra да я использовал агрегатную функцию, но это не рекомендуют делать, потому что не все базы их поддерживают и возвращают в разном виде.
Попробуй через экстрактор.


alabra [4 days ago]
Через экстрактор сделал просто было интересно как можно ещё. Все равно не понимаю как вы потом достаёте роли из агрегатной функции


Sergey Zhukov [4 days ago]
ранее я писал тут в ветке и показал в каком виде возвращает запрос, мне их парсил StringTokenizer


JavaHolic [4 days ago]
Добавьте distinct в селект

KaryNaiKo [4 days ago]
@JavaHolic Просто уел всех :D



alabra [4 days ago]
@JavaHolic Как это поможет? Дублирование имеется ввиду не полностью строки, а поля user. Т.е. запрос возвращает
user1 role_user
user1 role_admin
user2 role_user


JavaHolic [4 days ago]
а какая роль из двух нужна? (edited)


alabra [4 days ago]
обе


JavaHolic [4 days ago]
как они должны быть перечслены? через какойто разделитель?


JavaHolic [4 days ago]
в итоговой выборке


alabra [4 days ago]
Нужно получить в итоге
user1 List<Role>{role_user, role_admin}
user2 List<Role>{role_user}


alabra [4 days ago]
Я вот тоже не понимаю как это можно сделать


Sergey Zhukov [4 days ago]
завтра узнаете )


JavaHolic [4 days ago]
)


alabra [4 days ago]
Можно в SQL в запросе их объединить в одно поле через разделитель?


JavaHolic [4 days ago]
можно


JavaHolic [4 days ago]
вот пример для Postgres
SELECT c_id, STRING_AGG(c_grp_id, ',' ORDER BY c_grp_id) AS group_ids
FROM c_grp_at
GROUP BY c_id


alabra [4 days ago]
Понял спасибо попробую. Не знал про STRING_AGG


Sergey Zhukov [4 days ago]
@JavaHolic на других базах не прокатит (edited)

JavaHolic [4 days ago]
ну тогда для HSQLDB так будет
<group concat function> ::= GROUP_CONCAT <left paren> [ <set quantifier> ] <value expression> [ <order by clause> ] [ SEPARATOR <separator> ] <right paren> (edited)


Sergey Zhukov [4 days ago]
это уже не будет работать на postgres, уничерсальный наверно через экстрактор


JavaHolic [4 days ago]
для разных БД синтаксис для функции агрегации сильно различается, универсального селекта тогда в данном случае сделать не получится

JavaHolic [4 days ago]
тогда полагаю что агрегацию в данном случае необходимо будет выполнять силами java (edited)


alabra [4 days ago]
@Sergey Zhukov нашел в этой ветке как вы сделали через группировку. Интересно, я не догадался пока не увидел. Для разделения ролей в разные колонки пришлось делать двойной JOIN с условиями в первом role='ROLE_ADMIN' и role='ROLE_USER'? Или как то по другому сделали?


Sergey Zhukov [4 days ago]
да делал так, с двумя колонками не вариант, что если будем добавлять еще роли, количество JOIN увеличится


alabra [4 days ago]
Понял спасибо было интересно именно с технической точки зрения


Dima [4 days ago]
я делал запросом через join, потом через стримы делал Map с ключом номер юзера, значением Set ролей. А потом другим стримом просто бежал по изначальному List и добавлял нужные роли, вытаскивая их из Map.


alabra [4 days ago]
@Dima первоначально делал тоже похожим образом, но так как есть сортировка то можно сделать за один проход цикла


under4eg [Nov 21st at 8:20 PM]
никто не встречал проблемы с кодировкой? фильтр из урока не спасает :disappointed:


5 replies
alabra [4 days ago]
Был один случай Мне помогло указание кодировки в строке подключения например
#database.url=jdbc:mysql://localhost:3306/mybasename?autoReconnect=true&amp;useUnicode=true&amp;createDatabaseIfNotExist=true&amp;characterEncoding=utf-8


alabra [4 days ago]
Можно посмотреть в отладчике в контроллере в каком виде данные из view приходят.  Если там все ок с кодировкой то посмотреть в каком виде пишется в базу включив вывод в лог самих запросов с данными


under4eg [4 days ago]
похоже, что проблема в JSP, а не в базе


under4eg [4 days ago]
вообще не угадал. вот, где была проблема
Pasted image at 2018-11-21, 9:30 PM



under4eg [4 days ago]
криво лег патч


Sergey Zhukov [Nov 22nd at 10:28 AM]
@Grigory Kislin зачем в методах писать super.get (и другие методы), если мы не переопределяем метод, он же и так наследуется, можно просто get. Это чтоб понятней было тем кто будет читать код, или перестраховаться от попытки переопределения рядом, или так принято делать?
В случае с JpaUtil все понятно, мы переопределяли setUp() потому и вызывали super.setUp(), чтобы не дублировать (edited)


1 reply
Grigory Kislin [3 days ago]
не обязательно. мы просто будем еще переделывать этот класс


Илья Чиликин [Nov 22nd at 11:32 PM]
*upd: вопрос снят*

Поясните решение с получением ролей в разборе HW6.
Из патча:
```Map<Integer, Set<Role>> map = new HashMap<>();
jdbcTemplate.query("SELECT * FROM user_roles", rs -> {
    map.computeIfAbsent(rs.getInt("user_id"), userId -> EnumSet.noneOf(Role.class)).add(Role.valueOf(rs.getString("role")));
});```
В ситуации, когда у пользователя более одной роли.
Перебираем resultSet, встречаем строку user_id=1, role=ADMIN.
Ключа 1 в map нет, выполняется mapping function, в map появляется entry key=1,value=[ADMIN].
Продолжаем перебирать resultSet, встречаем строку user_id=1, role=USER.
Ключ 1 в map уже есть, значит mapping function не выполняется (т.к. computeIfAbsent), роль USER в map не попадает.

*upd: вопрос снят* (edited)


3 replies
Gekov Iliya [3 days ago]
У нас роли в сете, роль просто добавится к этому сету. Суть computeIfAbsent не в том, что оно не выполнится, если ключ присутствует, а в том, что если ключ отсутствует, то создастся пустой сет EnumSet.noneOf(Role.class)), в который добавится роль. Если сет на таком ключе уже существует, то к сету прибавится новая роль (edited)



Gekov Iliya [3 days ago]
Из доков: If the specified key is not already associated with a value (or is mapped to null), attempts to compute its value using the given mapping function and enters it into this map unless null.


Илья Чиликин [3 days ago]
А, вопрос снят. Смотрел через окно применения патча, неверно прочёл код в узкой части окна. (edited)
Pasted image at 2018-11-23, 12:42 AM


Alexey_b [9:41 PM]
Осталось некоторое недопонимание по поводу вынесения в разные места ресурсов, чтобы была возможность менять их и следовательно менять поведение программы в рантайме. Я правильно понимаю, что это нужно только для тестовых целей, так как для продакшена, нам надо собрать всё в единый war,  и в нем уже ничего поменять без пересборки нельзя?
